<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="zh-TW"><head>
	<meta http-equiv="Content-Type" content="text/html; charset=Big5">
	<meta name="Author" content="VBird, 鳥哥">
	<meta name="Description" content="knock 為一個好用的程式，可用以開放某些特定服務的防火牆功能">
	<title>鳥哥的 Linux 私房菜 -- 使用 knock 管理防火牆相關行為</title>
	<style type="text/css">
	 	body {
			background-color: #D3D3D3;
			color: #000000;
			background-attachment:fixed ;
		}
				body,th,td,input,select,textarea,select,checkbox {
			font-family: '新細明體', 'Times New Roman', serif;
			line-height: 1.6;
			font-size: 11pt ;
		}
		a:link		{text-decoration: none; color: blue}
		a:visited	{text-decoration: none; color: blue}
		a:active	{text-decoration: none; color: blue}
		a:hover		{text-decoration: underline; color: #ff0000}
				table.head1	{width:100%; background-color: #FFCCCC; 
				 border-style:groove;border-width:5px;border-color: #FFCCCC; margin:0;
				 padding: 5px 5px}
		   		   td.head1	{font: 10pt "新細明體", serif; color: #000099; }
		   		   td.info1	{font: 11pt "新細明體", serif; color: #000066; text-align:center; width:14%}
		   td.info2	{font: 11pt "新細明體", serif; color: #000066; text-align:center; width:12%}
		    *.info21	{font: 11pt "新細明體", serif; color: #000066; }
		    *.info22	{font: 11pt "新細明體", serif; color: blue  ; }
		    *.info23	{font: 11pt "新細明體", serif; color: green ; }
		   td.info3	{font: 11pt "新細明體", serif; color: #000066; text-align:justify}
				*.text_head0	{font-size:18pt; font-family:'標楷體','Times New Roman','Times', serif; }
		*.text_head_en	{font-size:18pt; font-family:'Times New Roman','Times', serif; }
				*.text_h1	{font: 15pt "新細明體", serif; color: #0000BB; font-weight: bold }
				*.text_h2	{font: 13pt "新細明體", serif; color: #0000BB; font-weight: bold }
				*.text_import1	{font:  11pt "新細明體", serif; color: #000088; font-weight: bold  }
		*.text_import2	{font:  11pt "新細明體", serif; color: #000088; font-weight: normal}
		*.text_vbird	{font:  11pt "新細明體", serif; color: #000088; font-weight: normal; 
				 font-style: italic;}
		*.text_history	{font:  10pt "新細明體", serif; color: #000066; }
		*.text_date	{font:  10pt "新細明體", serif; color: #3333FF; }
				*.block1	{padding: 10px 20px 10px 25px; text-align:left }
				*.block2	{padding: 10px 0px  10px 25px; text-align:left }
	    table.term2		{width: 350px; background-color: #000000;
				 border-style:groove;border-width:3px;border-color: #FFCCCC; margin:10px 0px;}
	    	    table.term		{width: 580px; background-color: #000000;
				 border-style:groove;border-width:3px;border-color: #FFCCCC; margin:10px 0px;}
	       	       td.term		{font:  10pt "細明體", Fixedsys, serif; color: #FFFFFF; }
		*.term_hd	{font:  10pt "細明體", Fixedsys, serif; color: #BBBBBB; }
		*.term_note	{font:  10pt "細明體", Fixedsys, serif; color: #777777; font-weight: normal }
		*.term_note_b	{font:  10pt "細明體", Fixedsys, serif; color: #FF77FF; font-weight: bolder }
		*.term_command	{font:  10pt "細明體", Fixedsys, serif; color: yellow ; font-weight: bolder }
		*.term_write	{font:  10pt "細明體", Fixedsys, serif; color: yellow ; font-weight: normal }
		*.term_say	{font:  10pt "細明體", Fixedsys, serif; color: #FF6666; font-weight: normal }
		*.term_white	{font:  10pt "細明體", Fixedsys, serif; color: #000000; background-color: #FFFFFF }
		*.list1		{list-style-type: square ; padding-left:0; margin-bottom:0 }
		*.listol	{                          padding-left:0; margin-bottom:0 }
		*.blockex	{padding: 10px 0px  10px 25px ; font: 9pt "新細明體", serif; color: #FFFFFF ; text-align: left }
		*.fontwidth	{font-family: 細明體 }
		*.fontwidth td 	{font-family: 細明體 ; text-align: justify; }
	</style>
	<script language="JaveScript" type="text/javascript" src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/java.js"></script>
</head>
<body style="margin:0; padding:0">
<center>


<!-- 這裡是關於頁首按鈕處的按鈕程式 -->
<div style="text-align:center">
<span style="font-weight:bolder; color:#3333FF"><span class="text_head0">鳥哥的<span class="text_head_en"> 
	Linux </span>私房菜</span></span><br>
<span style="color:#000080">為取得較佳瀏覽結果，請愛用 <a href="http://moztw.org/" target="_blank">firefox</a>
	瀏覽本網頁</span><br>
| <a href="http://linux.vbird.org/" target="_top" title="前往鳥哥的 Linux 私房菜首頁" style="font-size: 10pt">繁體主站</a> | 
<a href="http://vbird.dic.ksu.edu.tw/" target="_blank" title="前往鳥哥的 Linux 私房菜首頁" style="font-size: 10pt">簡體主站</a> | 
<a href="http://linux.vbird.org/linux_basic/" title="Linux 基礎學習篇，從頭學習 Linux" style="font-size: 10pt">基礎篇</a> | 
<a href="http://linux.vbird.org/linux_server/" title="Linux 伺服器架設篇" style="font-size: 10pt">伺服器</a> | 
<a href="http://linux.vbird.org/linux_enterprise/" title="Linux 企業應用篇" style="font-size: 10pt">企業應用</a> | 
<a href="http://linux.vbird.org/linux_desktop/" title="Linux 桌面應用篇" style="font-size: 10pt">桌面應用</a> | 
<a href="http://linux.vbird.org/linux_security/" title="Linux 安全管理篇" style="font-size: 10pt">安全管理</a> | 
<a href="http://phorum.vbird.org/" target="_blank" title="鳥站新手討論板" style="font-size: 10pt">討論板</a> | 
<a href="http://phorum.study-area.org/" target="_blank" title="酷！學園討論板" style="font-size: 10pt">酷學園</a> | 
<a href="http://linux.vbird.org/book/" title="書籍戡誤" style="font-size: 10pt">書籍戡誤</a> | 
<a href="http://linux.vbird.org/vbird/" title="關於鳥哥的一些事情" style="font-size: 10pt">鳥哥我</a> | 
<a href="http://www.dic.ksu.edu.tw/" target="_blank" title="崑山資傳" style="font-size: 10pt">崑山資傳</a> | 
</div>

<table summary="本文內容的排版" style="width:750px; 
	background-image:url('http://linux.vbird.org/images/VBirdLinux.jpg');
	background-attachment:fixed;" cellspacing="0" cellpadding="0" border="0">
<tbody><tr><td style="width:16px; height:16px; background-image:url('http://linux.vbird.org/images/border-top-left.jpg'); 
	font-size:6px">　</td>
    <td style="width:718px; height:16px; font-size:6px;
	background-image:url('http://linux.vbird.org/images/border-top-center.jpg')">　</td>
    <td style="width:16px; height:16px; background-image:url('http://linux.vbird.org/images/border-top-right.jpg');
	font-size:6px">　</td></tr>
<tr><td style="width:16px; font-size:6px;
	background-image:url('http://linux.vbird.org/images/border-middle-left.jpg')">　</td>
    <td width="718">

<!-- 本文的檔頭部分 -->
<div style="text-align:center">
    <a href="http://linux.vbird.org/linux_security/knockd.php">
    <span class="text_head0">使用<span class="text_head_en"> knock </span>管理防火牆</span></a><br>
</div>
    <div style="text-align:left">
        <a href="http://linux.vbird.org/linux_security/knockd.php?thisscreen=800x600">切換解析度為 800x600</a>
    </div>
    <div style="text-align:right">
        <span class="text_history">最近更新日期：2007/09/22</span>
    </div>
<!-- 本文的檔頭部分 -->
<table class="head1" summary="排版：文章檔頭的說明"><tbody><tr><td class="head1">
	『為自己開一個後門』是很多系統管理員常常需要思考的問題，因為我們常常需要在不同的環境裡面連線到主機去！
	為了自己管理的方便，總希望可以這麼做。但是如此一來又擔心系統的網路安全問題。
	所以，一般來說，為自己開一個後門最好是允許可信任的固定 IP 連線，這樣最簡單與單純，
	而且，當然不要針對整個 Internet 開放具有較高危險的服務，舉例來說 ssh 就是其中一個啊！<br><br>
	不過，如果用戶端是非固定的 IP 時，這個時候難道要將伺服器的服務針對 Internet 進行開放嗎？
	當然不行啦∼如此一來，防火牆怎麼設計啊？真是很困擾！好在，這個 knockd 可以幫我們處理這個問題呢！<br>
</td></tr></tbody></table><br>

<!-- 本文的連結區部分 -->
<div class="block1">
<span class="text_h1">
1. <a href="#firewall">防火牆基礎</a><br>
2. <a href="#knock">knockd 的使用</a><br>
	<span class="text_h2">
	　　2.1 <a href="#knock_work">knockd 的功能與特色</a><br>
	　　2.2 <a href="#knock_install">knockd 的安裝</a><br>
	　　2.3 <a href="#knock_config">knockd 的設定與啟動--以 SSH 為例</a><br>
	</span>
3. <a href="#client">knock 用戶端處理方式</a><br>
	<span class="text_h2">
	　　3.1 <a href="#client_linux">用戶端為 Linux 系統</a><br>
	　　3.2 <a href="#client_windows">用戶端為 Windows 系統</a><br>
	</span>
<span class="text_h2">
4. <a href="http://phorum.vbird.org/viewtopic.php?p=127903" target="_blank">針對本文的建議：http://phorum.vbird.org/viewtopic.php?p=127903#127903</a><br>
</span>

</span>
</div>

<!-- 本文的正式部分 -->
<hr><a name="firewall"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-m.gif" alt="大標題的圖示" width="25" height="34" align="middle"><span class="text_h1">防火牆基礎</span><br>
<div class="block1">
	一部伺服器的維護與管理當中，最重要的是<span class="text_import2">更新所提供的服務之軟體程式</span>，
	以避免可能會遭人入侵的漏洞問題。舉例來說，如果開放 WWW 就得要隨時更新 Apache  這支程式才好。
	再來則是訂定一系列的災難復原標準操作行為，接下來才是防火牆的設定。所以說，防火牆的重要性還比不上軟體更新喔！
	但是防火牆還是有他存在的必要啦，底下來簡單的說一說原因吧。<br><br>

	一般來說，在 Linux 伺服器上頭的封包過濾式防火牆主要有兩種，(1)是 Linux 核心支援的 iptables ，
	(2)則是利用 TCP Wrappers (或 xinetd 這個 super daemon) ，亦即是利用 /etc/hosts.allow, /etc/hosts.deny 
	這兩個檔案來管理的方式。利用 iptables 可以即時更新防火牆機制，而且效能也是很不錯的。
	至於使用 TCP Wrappers 的話，那就得要針對 /etc/hosts.{allow,deny} 修修改改的囉。<br><br>
	
	基本上，只要妳想要架設防火牆的話，就得要針對特定或不特定的 IP 來源進行開放或拒絕的動作。
	所謂的『特定』指的是例如 192.168.0.0/24 或者是某個特定的 IP 或主機名稱，或者是某個特定的協定 (如 port 80) 等。
	而不特定在這裡的意思表示針對整個 Internet 開放的意思。如果妳對於防火牆還有其他的問題，
	可以先參考一下鳥哥之前寫的一篇 <a href="http://linux.vbird.org/linux_server/0250simple_firewall.php">簡易防火牆</a> 再說。
	在這一章當中，鳥哥假設您已經學會 iptables 的相關語法與觀察的指令了。<br><br>

	雖然很多人都覺得防火牆是一部主機管理上最重要的地方，但其實鳥哥之前就曾談過，
	防火牆基本上是沒有什麼用途的！ ^_^！因為無論如何，妳都得要開放某些服務給用戶端登入對吧！
	如此一來，防火牆當然無法抵擋對你所開放的服務之連線啦！
	但防火牆也不是一無用處，至少他可以將伺服器所提供的網路服務『侷限』在某些特定的範圍內。
	怎麼說呢？底下我們來舉個例子好了。<br><br>

	鳥哥有些 Linux 主機放置到<a href="http://www.ksu.edu.tw/" target="_blank">崑山科大資訊傳播系</a>內，
	而且鳥哥常常需要在沒有固定 IP 的地方連線到這部主機上面進行操作，以秀給大家看一下主機的設定或者是一些 Linux 相關議題。
	因為鳥哥所在的用戶端沒有固定 IP ，所以是否就得要針對整個 Internet 來開放那個可怕的 sshd 的服務嗎？
	要注意， sshd 可是個很危險的服務喔，因為只要使用者登入主機，那麼他能夠作的事情實在太多了！
	所以不要將 sshd 對整個 Internet 開放才好。您說是吧？<br><br>

	既然 sshd 不對整個 Internet 開放，然而鳥哥所在的位置又是非固定 IP 的來源，那我這部 Linux server 的防火牆要如何針對 sshd
	進行設定啊？難道無解嗎？呵呵！沒問題，我們可以利用 knockd 這個 daemon 來負責的啦！
	底下我們就來談一談 knockd 這個咚咚吧！<br><br>
</div>


<hr><a name="knock"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-m.gif" alt="大標題的圖示" width="25" height="34" align="middle"><span class="text_h1">knockd 的使用</span><br>
<div class="block1">
	為了解決非固定 IP 來源用戶端的連線問題，我們可能得要手動的加入用戶端的防火牆設定於防火牆規則當中。
	這很麻煩啦！那有沒有自動的方式可以讓防火牆規則自動的修改的？是有的∼那就是利用 knockd 這個服務。
	底下讓我們來談談這個玩意兒的特色與使用方式吧！<br><br>

	<hr><a name="knock_work"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-s.gif" alt="小標題的圖示" width="16" height="23" align="middle"><span class="text_h2">knockd 的功能與特色</span><br>
	<div class="block2">
		knockd 主要的目的是希望可以動態的修改防火牆規則，他的運作流程是這樣的：<br>
		<ol><span class="text_import2">
		<li>伺服器端的防火牆規則中先開放三個左右的埠口，這些埠口沒有被其他程式啟用，且可由 knockd 所偵測；
		</li><li>用戶端若依照設定的順序依序的連線到這三個埠口時， knockd 將進行動態防火牆規則的設定
		</li><li>防火牆規則被修改，且 knockd 持續進行偵測；
		</li><li>當用戶端讓 knockd 等候逾時，或者是用戶端離線後，剛剛步驟三的防火牆規則將會被移除。
		</li></span></ol>
		如此一來，當我在非固定 IP 的網段想要連線到伺服器時，就可以透過這個機制來處理啦！
		整個流程有點像底下的圖示：<br><br>

		<center><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/knock_01.png" title="knockd 的處理流程" alt="knockd 的處理流程" border="1"><br>
		圖一-a、用戶端必須要『依序』對某些埠口進行連線的動作<br>
		</center><br>
		<center><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/knock_02.png" title="knockd 的處理流程" alt="knockd 的處理流程" border="1"><br>
		圖一-b、若通過 knockd 對埠口的設定，則 knockd 會動態的增加防火牆規則，且用戶端可以連線了<br>
		</center><br>
		<center><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/knock_03.png" title="knockd 的處理流程" alt="knockd 的處理流程" border="1"><br>
		圖一-c、若用戶端離線，或者是 knockd 等待逾時，則 knockd 可主動的刪除剛剛建立的規則<br>
		</center><br>

		您可以看到，防火牆的規則本來是關閉的，然後在用戶端依序碰觸某些埠口後， knockd
		就能夠『僅針對此一 IP』啟動某些特定的埠口，此時用戶端就能夠透過這個特殊的埠口進行主機的連線。
		並且可以在用戶端斷線後，將該防火牆規則拿掉！呵呵！如此一來，我們不論是在何處，
		就可以使用這個功能來開啟某些比較危險的服務啦，例如 sshd 這個 port 22 囉！<br><br>
	</div>
	<hr><a name="knock_install"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-s.gif" alt="小標題的圖示" width="16" height="23" align="middle"><span class="text_h2">knockd 的安裝</span><br>
	<div class="block2">
		knockd 的安裝非常簡單，因為他除了提供 Tarball 之外，還提供 SRPM 哩！所以安裝方面非常容易！
		鳥哥是將 knockd 安裝在 CentOS 5.x 上面的，所以使用 RPM 來測試給大家看看。
		如果妳想要安裝 Tarball 的話，可以參考這一篇的說明：
		<a href="http://linux.vbird.org/linux_basic/0520source_code_and_tarball.php">Tarball 與原始碼</a> 。至於 knockd 的下載可以參考：
		<ul><li><a href="http://www.invoca.ch/pub/packages/knock/" target="_blank">SRPM 下載點：http://www.invoca.ch/pub/packages/knock/</a></li></ul>
		讓我們開始安裝吧！<br>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd">1. 先下載這個軟體吧！</span>
[root@linux ~]# <span class="term_command">wget  \</span>
&gt; <span class="term_command">http://www.invoca.ch/pub/packages/knock/knock-0.5-4.src.rpm</span>

<span class="term_hd">2. 開始編譯成為 RPM 檔案！</span>
[root@linux ~]# <span class="term_command">rpmbuild --rebuild knock-0.5-4.src.rpm</span>
Installing knock-0.5-4.src.rpm
error: Failed build dependencies:
        libpcap-devel is needed by knock-0.5-4.i386
<span class="term_say"># 如果出現類似上述的訊息，表示妳還有某些關鍵套件未安裝，請自行使用 yum 安裝
# 此外，請確認你已經安裝了發展工具組，包括 gcc, glibc-devel 等等，
# 當然，若有需要時，可以安裝整個發展工具套件： 
# yum groupinstall "Development Tools"</span>

[root@linux ~]# <span class="term_command">rpmbuild --rebuild knock-0.5-4.src.rpm</span>
Installing knock-0.5-4.src.rpm
Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.42725
+ umask 022
+ cd /usr/src/redhat/BUILD
<span class="term_say">.....(中間省略).....</span>
<span class="term_note_b">Wrote: /usr/src/redhat/RPMS/i386/knock-0.5-4.i386.rpm
Wrote: /usr/src/redhat/RPMS/i386/knock-server-0.5-4.i386.rpm</span>
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.26785
<span class="term_say">.....(底下省略).....</span>
<span class="term_say"># 至少要出現如上的粗體字，才是正確的編譯成功喔！接下來準備安裝！</span>

[root@linux ~]# <span class="term_command">rpm -ivh /usr/src/redhat/RPMS/i386/knock-*</span>
Preparing...           ################################# [100%]
   1:knock-server      ################################# [ 50%]
   2:knock             ################################# [100%]
<span class="term_say"># 那個 knock 是 client 端的指令， knock-server 才是伺服器端的軟體！</span>
</pre></td></tr></tbody></table>

		有夠簡單吧！這樣就安裝妥當了∼妳可以使用 rpm -ql knockd 及 rpm -ql knockd-server 去看看有啥資料在這個套件中，
		然後可以使用 man knock 及 man knockd 分別察看 client/server 端的設定方法！
		底下我們就開始來設定 knockd  吧！<br><br>
	</div>

	<hr><a name="knock_config"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-s.gif" alt="小標題的圖示" width="16" height="23" align="middle"><span class="text_h2">knockd 的設定與啟動--以 SSH 為例</span><br>
	<div class="block2">
		在開始玩 knockd 之前，請務必使用 man knockd 去查閱一下詳細的設定方法，
		這很重要啊！不然妳不會知道底下設定檔的意義喔！好了，我們知道 knockd 是藉由偵測 port 來動態進行防火牆規則的修改，
		所以我們當然就得要有設定檔啦。使用 RPM 安裝時，預設的設定檔在 /etc/knockd.conf ，
		這個檔案的原始內容是這樣的：<br>

<table class="term"><tbody><tr><td class="term"><pre>[root@linux ~]# <span class="term_command">vi /etc/knockd.conf</span>
[options]
    UseSyslog
[opencloseSSH]
    sequence      = 2222:udp,3333:tcp,4444:udp
    seq_timeout   = 15
    tcpflags      = syn,ack
    start_command = /sbin/iptables -A INPUT -s %IP% -p tcp --dport ssh -j ACCEPT
    cmd_timeout   = 10
    stop_command  = /sbin/iptables -D INPUT -s %IP% -p tcp --dport ssh -j ACCEPT
<span class="term_say"># 各參數的意義可由 man knockd 查到，簡單的說，各設定項目為：
# [options]:	 與 knockd 環境有關的設定資料；
# UseSyslog:	 與 knockd 有關的登入資料使用 syslogd 放置到 /var/log/messages
# [opencloseSSH] 開啟與關閉 SSH 防火牆的設定項目；
# sequence:	 knockd 偵測的埠口與封包協定 (tcp/udp)
# seq_timeout:	 需要在幾『秒鐘』內，連續上面的埠口接觸 (sequence 之設定)；
# tcpflags:	 來源封包所需帶有的封包標誌，一般來說， UDP 封包不會有 ack ，
#		 所以上述的預設標籤與封包，其實是無法吻合的，所以需要修改。
# start_command: 若連續接觸所有的埠口，則 knockd 開始後續的指令；
# stop_command:	 若用戶端斷線了，那麼就執行後續的指令
# cmd_timeout:	 若設定 stop_command 則需此設定，訂定開始與結束防火牆的時間。
</span></pre></td></tr></tbody></table>

		如上所述，其實預設的設定檔有點小問題的，所以此時我們需要修改一下設定檔才好。
		鳥哥的設定檔長的有點像這樣：<br>

<table class="term"><tbody><tr><td class="term"><pre>[root@linux ~]# <span class="term_command">vi /etc/knockd.conf</span>
<span class="term_write">[options]
    LogFile       = /var/log/knockd.log
    Interface     = eth0
    <span class="term_say"># 鳥哥將登錄檔獨立出來管理，且管制監聽的介面為 eth0</span>

[opencloseSSH]
    sequence      = 2100:tcp,2200:udp,2300:tcp
    seq_timeout   = 15
    tcpflags      = syn
    start_command = /sbin/iptables -A INPUT -s %IP% -p tcp --dport ssh -j ACCEPT
    cmd_timeout   = 30
    <span class="term_say"># 在開放防火牆後，等待 30 秒，若用戶端沒有動作，則將該規則再關閉</span>
    stop_command  = /sbin/iptables -D INPUT -s %IP% -p tcp --dport ssh -j ACCEPT</span>
</pre></td></tr></tbody></table>

		設定妥當之後就趕快來啟動他吧！啟動就更簡單了！<br>

<table class="term"><tbody><tr><td class="term"><pre>[root@linux ~]# <span class="term_command">/etc/init.d/knockd start</span>
[root@linux ~]# <span class="term_command">chkconfig knockd on</span>
</pre></td></tr></tbody></table>

		這樣就搞定了 knockd 了！<br><br>
	</div>
</div>


<hr><a name="client"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-m.gif" alt="大標題的圖示" width="25" height="34" align="middle"><span class="text_h1">knock 用戶端處理方式</span><br>
<div class="block1">
	既然 knockd 需要接觸伺服器的數個埠口，那麼用戶端該如何接觸呢？很簡單啊∼
	妳可以使用 telnet 發送封包，也可以使用 knock 這個用戶端指令來處理。
	knock 很不錯的地方，在於他同時提供 Linux/Windows 那個用戶端程式！
	鳥哥也建議使用 knock 即可，因為使用 telnet 常常無法成功，真煩人∼
	底下讓我們來實際測試看看囉：<br><br>

	<hr><a name="client_linux"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-s.gif" alt="小標題的圖示" width="16" height="23" align="middle"><span class="text_h2">用戶端為 Linux 系統</span><br>
	<div class="block2">
		如果用戶端是 Linux 系統時，請前往前面安裝的地方，妳只要安裝 knock 即可，不需要安裝 knock-server 的啦！
		那這個程式如何使用呢？非常簡單，只要這樣做即可：<br>

<table class="term"><tbody><tr><td class="term"><pre>[root@linux ~]# <span class="term_command">knock -v 192.168.1.254 2100:tcp 2200:udp 2300:tcp</span>
hitting tcp 192.168.1.254:2100
hitting udp 192.168.1.254:2200
hitting tcp 192.168.1.254:2300
</pre></td></tr></tbody></table>

		knock 之後加上主機名稱，然後後面就是接續的不同的埠口。至於 -v 的參數只是列出 knock 用戶的運作流程而已。
		接下來用戶端有 30 秒的時間 (鳥哥的設定檔自訂的，您可以修改此項目) 可以連上主機，
		如果超過 30 秒沒有回應的話，那麼該規則就會被再次的刪除喔！如果想要確認有無成功的話，
		請到 knockd 主機上面，執行 iptables-save 查閱看看有沒有 IP 列表就知道啦！粉簡單吧！<br><br>
	</div>

	<hr><a name="client_windows"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-s.gif" alt="小標題的圖示" width="16" height="23" align="middle"><span class="text_h2">用戶端為 Windows 系統</span><br>
	<div class="block2">
		若用戶端為 Windows 系統時，<a href="http://www.zeroflux.org/cgi-bin/cvstrac.cgi/knock/wiki" target="_blank">knockd 官網</a>已經很好心的將 knock 的用戶端軟體編譯成為 Win32 能執行的二進位檔案 
		(binary file) ，所以妳可以直接下載來使用。若需下載，請按底下的連結吧：<br>
		<ul><li>knock 的用戶端程式：<a href="http://www.zeroflux.org/proj/knock/files/knock-win32.zip">http://www.zeroflux.org/proj/knock/files/knock-win32.zip</a></li></ul>
		由於檔案是壓縮檔，因此妳必須要先解壓縮才行。解壓縮完畢後，進入新建的目錄會有底下的檔案：<br><br>

		<center><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/knock_win.png" title="Windows 用戶端" alt="Windows 用戶端" border="1"><br>
		圖二、Windows 用戶端使用的 knock 軟體<br>
		</center><br>

		上面的檔案都是原始碼，給大家參考用而已。在那個 Release 目錄內的檔案才是可執行檔。
		建議妳<span class="text_import2">可以將檔名為 knock.exe 的檔案 (在 Release 目錄內) 放置到 C:\Windows 底下，
		這樣妳才可以在任何地方直接下達 knock 這個指令</span>。接下來請打開 DOS 視窗，亦即『開始』--&gt;『執行』
		在出現的視窗當中輸入『 cmd 』，就能夠取得終端機了。之後的指令就如同 Linux 環境囉！<br>

<table class="term"><tbody><tr><td class="term"><pre>
C:\&gt;<span class="term_command">knock -v 192.168.1.254 2100:tcp 2200:udp 2300:tcp</span>
hitting tcp 192.168.1.254:2100
hitting udp 192.168.1.254:2200
hitting tcp 192.168.1.254:2300
</pre></td></tr></tbody></table>

		之後再以 pietty (<a href="http://ntu.csie.org/~piaip/pietty/" target="_blank">http://ntu.csie.org/~piaip/pietty/</a>) 立刻連上原本的 SSH 主機，嘿嘿！搞定∼
	</div>
</div>


<hr><a name="reference"></a><img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/penguin-m.gif" alt="大標題的圖示" width="25" height="34" align="middle"><span class="text_h1">參考資料</span><br>
<div class="block1">
<ul>
	<li>knockd 的官網： <a href="http://www.zeroflux.org/cgi-bin/cvstrac.cgi/knock/wiki" target="_blank">http://www.zeroflux.org/cgi-bin/cvstrac.cgi/knock/wiki</a><br></li>

</ul>
</div>


<hr><span class="text_history">
2007/09/19：討論區的老周兄一直建議的好軟體，鳥哥來將他寫成簡單的文件吧！<br>
2007/09/22：根據老周的來信，確認 iptables.rule 不需要修改！沒有開放 port 也可以。感謝 jou ！<br>
</span>
<hr><span class="text_date">2007/09/19 以來統計人數</span><br>
<img src="%E9%B3%A5%E5%93%A5%E7%9A%84%20Linux%20%E7%A7%81%E6%88%BF%E8%8F%9C%20--%20%E4%BD%BF%E7%94%A8%20knock%20%E7%AE%A1%E7%90%86%E9%98%B2%E7%81%AB%E7%89%86%E7%9B%B8%E9%97%9C%E8%A1%8C%E7%82%BA_files/Count.gif" nosave="" width="60" height="15" align="ABSMIDDLE"><br>
    </td>
    <td style="width:16px; font-size:6px;
	background-image:url('http://linux.vbird.org/images/border-middle-right.jpg')">　</td></tr>
<tr><td style="width:16px; height:16px; background-image:url('http://linux.vbird.org/images/border-bottom-left.jpg');
        font-size:6px">　</td>
    <td style="width:750px; height:16px; font-size:6px;
        background-image:url('http://linux.vbird.org/images/border-bottom-center.jpg')">　</td>
    <td style="width:16px; height:16px; background-image:url('http://linux.vbird.org/images/border-bottom-right.jpg');
        font-size:6px">　</td></tr>
</tbody></table>

<div style="padding-top:0px; text-align:center">
| <a href="http://linux.vbird.org/" target="_top" title="前往鳥哥的 Linux 私房菜首頁" style="font-size: 10pt">繁體主站</a> |
<a href="http://vbird.dic.ksu.edu.tw/" target="_blank" title="前往鳥哥的 Linux 私房菜首頁" style="font-size: 10pt">簡體主站</a> |
<a href="http://linux.vbird.org/linux_basic/" title="Linux 基礎學習篇，從頭學習 Linux" style="font-size: 10pt">基礎篇</a> |
<a href="http://linux.vbird.org/linux_server/" title="Linux 伺服器架設篇" style="font-size: 10pt">伺服器</a> |
<a href="http://linux.vbird.org/linux_enterprise/" title="Linux 企業應用篇" style="font-size: 10pt">企業應用</a> |
<a href="http://linux.vbird.org/linux_desktop/" title="Linux 桌面應用篇" style="font-size: 10pt">桌面應用</a> |
<a href="http://linux.vbird.org/linux_security/" title="Linux 安全管理篇" style="font-size: 10pt">安全管理</a> |
<a href="http://phorum.vbird.org/" target="_blank" title="鳥站新手討論板" style="font-size: 10pt">討論板</a> |
<a href="http://phorum.study-area.org/" target="_blank" title="酷！學園討論板" style="font-size: 10pt">酷學園</a> |
<a href="http://linux.vbird.org/book/" title="書籍戡誤" style="font-size: 10pt">書籍戡誤</a> |
<a href="http://linux.vbird.org/vbird/" title="關於鳥哥的一些事情" style="font-size: 10pt">鳥哥我</a> |
<a href="http://www.dic.ksu.edu.tw/" target="_blank" title="崑山資傳" style="font-size: 10pt">崑山資傳</a> |
<br>
<div style="padding:0; margin:0">
</div>
<span style="font-size: 80%">
	本網頁主要以 <a href="http://moztw.org/" target="_blank">firefox</a> 配合解析度 1024x768 作為設計依據<br>
	<a href="http://linux.vbird.org/" target="_top" title="前往鳥哥的首頁">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="聯絡鳥哥(我不要廣告信！)">VBird</a>
		during 2001-2011. <a href="http://www.ksu.edu.tw/" target="_blank">ksu.edu</a></span>
</div>
</center>


</body></html>