/**
 * Created by sf on 2018/8/3.
 */
var areaArr = []

var trackHost = 'https://segmentfault.com';
var viewApi = trackHost + '/ad/track/view'
var clickApi = trackHost + '/ad/track/click'

function ajax(opt) {
    opt = opt || {};//opt以数组方式存参，如果参数不存在就为空。
    opt.method = opt.method.toUpperCase() || 'POST';//转为大写失败，就转为POST
    opt.url = opt.url || '';//检查URL是否为空
    opt.async = opt.async || true;//是否异步
    opt.data = opt.data || null;//是否发送参数，如POST、GET发送参数
    opt.success = opt.success || function () {}; //成功后处理方式
    var xmlHttp = null;//定义1个空变量
    if (XMLHttpRequest) {
        xmlHttp = new XMLHttpRequest();//如果XMLHttpRequest存在就新建，IE大于9&&非IE有效
    }
    else {
        xmlHttp = new ActiveXObject('Microsoft.XMLHTTP');//用于低版本IE
    }
    var params = [];//定义1个空数组
    for (var key in opt.data){
        params.push(key + '=' + opt.data[key]);//将opt里的data存到push里
    }
    var postData = params.join('&');//追加个& params
    if (opt.method.toUpperCase() === 'POST') {
        xmlHttp.open(opt.method, opt.url, opt.async);//开始请求
        xmlHttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded;charset=utf-8');//发送头信息，与表单里的一样。
        xmlHttp.send(postData);//发送POST数据
    }
    else if (opt.method.toUpperCase() === 'GET') {
        xmlHttp.open(opt.method, opt.url, opt.async);//GET请求
        xmlHttp.send(null);//发送空数据
    }
    xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {//readyState有5个状态，可以百度一下看看都有什么。当请求完成，并且返回数据成功
            opt.success(xmlHttp.responseText);//返回成功的数据
        }
    };
}

var sTitle="";
window.SFGridAd = {};
SFGridAd.d = function(o) {
    sTitle = o.getAttribute('stitle');
    document.getElementById("gridMapHoverBox").style.display = "block"
}

SFGridAd.e = function(o) {
    sTitle = "";
    document.getElementById("gridMapHoverBox").style.display = "none"
}

SFGridAd.c = function(id) {

    var clickApi2 = clickApi + '?id=' + id

    ajax({url: clickApi2, method: 'GET'})
};

// 这里 data 需要注入
[{"id":"1750000020264806","user_id":"1030000002496563","box_ad_id":"0","started":"1567526400","ended":"1569945600","cycles":"4","status":"0","banner":"\/593\/351\/593351944-5d6d0585d5e05","link":"https:\/\/www.fundebug.com\/?utm_source=sf_ad","title":"\u4e00\u884c\u4ee3\u7801\u641e\u5b9aBUG\u76d1\u63a7","area_info":{"area":"F5:I5","height":"17","width":"68","left":"85","top":"68","pos":{"rowTop":5,"rowBottom":5,"columnLeft":6,"columnRight":9},"size":4},"created":"1567425858","modified":"1567426002"},{"id":"1750000020331414","user_id":"1030000005963844","box_ad_id":"0","started":"1568044800","ended":"1569254400","cycles":"2","status":"0","banner":"\/392\/208\/3922086354-5d75ca967c900","link":"https:\/\/www.h5ds.com","title":"\u6655~\u8fd9\u4e48\u5c0f\u653e\u5565\u56fe\u7247\u554a\uff1f\uff1f\u81ea\u5df1\u8fdb\u6765\u770b\u5427\uff01","area_info":{"area":"K3:L3","height":"17","width":"34","left":"170","top":"34","pos":{"rowTop":3,"rowBottom":3,"columnLeft":11,"columnRight":12},"size":2},"created":"1568000396","modified":"1568000712"},{"id":"1750000020360171","user_id":"1030000005682377","box_ad_id":"0","started":"1568304000","ended":"1569513600","cycles":"2","status":"0","banner":"\/292\/343\/2923433764-5d789efb1e683","link":"https:\/\/github.com\/tumobi\/nideshop-mini-program","title":"\u5f00\u6e90\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u5546\u57ce","area_info":{"area":"C3:C3","height":"17","width":"17","left":"34","top":"34","pos":{"rowTop":3,"rowBottom":3,"columnLeft":3,"columnRight":3},"size":1},"created":"1568185790","modified":"1568186131"},{"id":"1750000020365896","user_id":"1030000008037822","box_ad_id":"0","started":"1568304000","ended":"1568908800","cycles":"1","status":"0","banner":"\/284\/073\/2840731507-5d791a565a78d","link":"https:\/\/mengwei.live","title":"\u731b\u8587 | \u65c5\u884c\u53ca\u57ce\u5e02\u751f\u6d3b\u793e\u533a","area_info":{"area":"F1:F1","height":"17","width":"17","left":"85","top":"0","pos":{"rowTop":1,"rowBottom":1,"columnLeft":6,"columnRight":6},"size":1},"created":"1568217258","modified":"1568217697"},{"id":"1750000020367353","user_id":"1030000020281160","box_ad_id":"0","started":"1568304000","ended":"1569513600","cycles":"2","status":"0","banner":"\/281\/932\/2819327955-5d79a88760dd6","link":"https:\/\/github.com\/iresty\/apisix\/blob\/master\/README_CN.md","title":"\u5f00\u6e90\u7684\u5fae\u670d\u52a1 API \u7f51\u5173\uff0c\u70b9\u51fb\u8fdb\u5165 GitHub \u67e5\u770b","area_info":{"area":"A8:A8","height":"17","width":"17","left":"0","top":"119","pos":{"rowTop":8,"rowBottom":8,"columnLeft":1,"columnRight":1},"size":1},"created":"1568252302","modified":"1568254089"},{"id":"1750000020374863","user_id":"1030000004063682","box_ad_id":"0","started":"1568304000","ended":"1569513600","cycles":"1","status":"0","banner":"\/321\/156\/3211565291-5d7a1399c0b19","link":"https:\/\/www.sobot.com\/chat\/h5\/index.html?sysNum=ad22d3b19d4b45e6ae00dbbe9cb1fac2","title":"\u805a\u4e91\u7f51\uff1a\u957f\u671f\u62db\u52df\u8fdc\u7a0b\u5f00\u53d1\u4eba\u5458","area_info":{"area":"A5:A5","height":"17","width":"17","left":"0","top":"68","pos":{"rowTop":5,"rowBottom":5,"columnLeft":1,"columnRight":1},"size":1},"created":"1568281163","modified":"1568281826"},{"id":"1750000020391060","user_id":"1030000007747454","box_ad_id":"0","started":"1568649600","ended":"1569254400","cycles":"1","status":"0","banner":"\/333\/830\/3338301951-5d7eea2743eb0","link":"https:\/\/www.openinstall.io","title":"Android\/iOS \u4e00\u4e2a\u5b89\u88c5\u5305\u8d70\u5929\u4e0b\uff01","area_info":{"area":"D7:G7","height":"17","width":"68","left":"51","top":"102","pos":{"rowTop":7,"rowBottom":7,"columnLeft":4,"columnRight":7},"size":4},"created":"1568598469","modified":"1568598598"},{"id":"1750000020397068","user_id":"1030000009704636","box_ad_id":"0","started":"1568649600","ended":"1569254400","cycles":"1","status":"0","banner":"\/146\/295\/1462959109-5d7f505908442","link":"https:\/\/github.com\/GzhiYi\/dandan-account","title":"|\u0434\uff65)\u5c0f\u7a0b\u5e8f\u641c\u7d22\uff1a\u5355\u5355\u8bb0\u8d26","area_info":{"area":"J5:J5","height":"17","width":"17","left":"153","top":"68","pos":{"rowTop":5,"rowBottom":5,"columnLeft":10,"columnRight":10},"size":1},"created":"1568624135","modified":"1568624737"}].forEach(function(item) {
    var html = '<area shape="rect" ' +
        'target="_blank" ' +
        'onmouseover="SFGridAd.d(this)" ' +
        'onmouseout="SFGridAd.e(this)" ' +
        'onclick="SFGridAd.c(' + item.id + ')" ' +
        'coords="' + item.area_info.left + ',' + item.area_info.top + ',' + ((+item.area_info.left)+(+item.area_info.width)) + ',' + ((+item.area_info.top)+(+item.area_info.height)) + '" ' +
        'href="' + item.link + '" ' +
        'stitle="' + item.title + '" />'

    areaArr.push(html)
})

document.getElementById('gridsMap').innerHTML = areaArr.join('')

document.getElementById('gridsMap').onmousemove = function(e) {
    var pos = getMousePos(e)

    document.getElementById("gridMapHoverBox").style.left = pos.x + 20 + 'px'
    document.getElementById("gridMapHoverBox").style.top = pos.y + 20 + 'px'

    document.getElementById("gridMapHoverBox").innerHTML = sTitle
}

// 增加 view 统计
setTimeout(function() {
    isShow = document.querySelector('img[src^="https://static.segmentfault.com/sponsor"]').clientHeight > 0
    if (isShow) ajax({url: viewApi, method: 'GET'})
}, 0)

function getMousePos(event) {
    var e = event || window.event;
    var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
    var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
    var x = e.pageX || e.clientX + scrollX;
    var y = e.pageY || e.clientY + scrollY;
    return { 'x': x, 'y': y };
}
