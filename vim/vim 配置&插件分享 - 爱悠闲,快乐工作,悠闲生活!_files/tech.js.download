$(function() {
	buildCTable();
});

function buildCTable() {
	var hs = $('#cpost_content').find('h1,h2,h3,h4,h5,h6');
	if (hs.length < 2)
		return;
	var s = '';
	s += '<div style="clear:both"></div>';
	s += '<div style="border:solid 1px #ccc; background:#eee; float:left; min-width:200px;padding:4px 10px;">';
	s += '<p style="text-align:right;margin:0;"><span style="float:left;">目录</span><a href="#" onclick="javascript:return openct(this);" title="展开">[+]</a></p>';
	s += '<ol style="display:none;margin-left:14px;padding-left:14px;line-height:160%;">';
	var old_h = 0, ol_cnt = 0;
	for ( var i = 0; i < hs.length; i++) {
		var h = parseInt(hs[i].tagName.substr(1), 10);
		if (!old_h)
			old_h = h;
		if (h > old_h) {
			s += '<ol>';
			ol_cnt++;
		} else if (h < old_h && ol_cnt > 0) {
			s += '</ol>';
			ol_cnt--;
		}
		if (h == 1) {
			while (ol_cnt > 0) {
				s += '</ol>';
				ol_cnt--;
			}
		}
		old_h = h;
		var tit = hs.eq(i).text().replace(/^[\d.、\s]+/g, '');
		tit = tit.replace(/[^a-zA-Z0-9_\-\s\u4e00-\u9fa5]+/g, '');
		if (tit.length < 100) {
			s += '<li><a href="#t' + i + '">' + tit + '</a></li>';
			hs.eq(i).html('<a name="t' + i + '"></a>' + hs.eq(i).html());
		}
	}
	while (ol_cnt > 0) {
		s += '</ol>';
		ol_cnt--;
	}
	s += '</ol></div>';
	s += '<div style="clear:both"></div>';
	$('#mulu').html(s);
	$('#mulu').css('margin-top', '10px');
	$('#clearboth').css('clear', 'both');
}
function openct(e) {
	if (e.innerHTML == '[+]') {
		$(e).attr('title', '收起').html('[-]').parent().next().show();
	} else {
		$(e).attr('title', '展开').html('[+]').parent().next().hide();
	}
	e.blur();
	return false;
}

function adsfix() {
	var $sidebar = $("#side-ads");
	var top = $sidebar.position().top, $window = $(window), offset = $sidebar
			.offset();
	$window.scroll(function() {
		var scrolls = $(this).scrollTop();
		if ($window.scrollTop() > (offset.top - 35)) {
			if (window.XMLHttpRequest) {
				$sidebar.addClass("already-fixed");
			} else {
				$sidebar.css({
					position : "absolute",
					top : scrolls
				});
			}
		} else {
			if (window.XMLHttpRequest) {
				$sidebar.removeClass("already-fixed");
			} else {
				$sidebar.css({
					position : "absolute",
					top : top
				});
			}
		}
	});
}