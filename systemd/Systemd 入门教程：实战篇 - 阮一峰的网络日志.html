<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type  5.2.2" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--link rel="stylesheet" href="http://www.ruanyifeng.com/blog/styles.css" type="text/css" /-->
<link rel="start" href="http://www.ruanyifeng.com/blog/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="http://feeds.feedburner.com/ruanyifeng" />
<script type="text/javascript" src="http://www.ruanyifeng.com/blog/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="http://www.ruanyifeng.com/blog/2014/10/real-leadership-lessons-of-steve-jobs.html">
<dc:title>乔布斯的管理课</dc:title>
<dc:description>2011年11月出版的《乔布斯传》很畅销，也写得很好，我还写过一篇读后感。...</dc:description>
<dc:creator>阮一峰</dc:creator>
<dc:date>2014-10-02T12:13:53+08:00</dc:date>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<style>
body {
  background-color: #f5f5d5;
}

#container::before {
  display: block;
  width: 100%;
  padding: 10px;
  background: rgba(0,0,0,0.1);
  text-align: center;
  content: "本站显示不正常，可能因为您使用了广告拦截器。";
}

</style>
<script>
function loadjscssfile(filename, filetype){
    if (filetype=="js"){ //if filename is a external JavaScript file
        var fileref=document.createElement('script')
        fileref.setAttribute("type","text/javascript")
        fileref.setAttribute("src", filename)
    }
    else if (filetype=="css"){ //if filename is an external CSS file
        var fileref=document.createElement("link")
        fileref.setAttribute("rel", "stylesheet")
        fileref.setAttribute("type", "text/css")
        fileref.setAttribute("href", filename)
    }
    if (typeof fileref!="undefined")
        document.getElementsByTagName("head")[0].appendChild(fileref)
}
//loadjscssfile("http://www.ruanyifeng.com/blog/styles.css", "css");
loadjscssfile('/static/themes/theme_scrapbook/theme_scrapbook.min.css', "css");


function checker() {
// var img = document.querySelector('img[src^="http://www.ruanyifeng.com/blog/images"]');
var img = document.querySelector('a > img[src*="wangbase.com/blogimg/asset/"]');
  if (img && window.getComputedStyle(img).display === 'none'){
    var sponsor = document.querySelector('.entry-sponsor');
    var prompt = document.createElement('div');
    prompt.style = 'border: 1px solid #c6c6c6;border-radius: 4px;background-color: #f5f2f0;padding: 15px; font-size: 14px;';
  prompt.innerHTML = '<p>您使用了广告拦截器，导致本站内容无法显示。</p><p>请将 www.ruanyifeng.com 加入白名单，解除广告屏蔽后，刷新页面。谢谢。</p>';
    sponsor.parentNode.replaceChild(prompt, sponsor);
    document.querySelector('#main-content').innerHTML = '';
  }
}

setTimeout(checker, 1000);
</script>

    
    <link rel="prev" href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html" title="Systemd 入门教程：命令篇" />
    <link rel="next" href="http://www.ruanyifeng.com/blog/2016/03/node-systemd-tutorial.html" title="Node 应用的 Systemd 启动" />
    
    <title>Systemd 入门教程：实战篇 - 阮一峰的网络日志</title>
</head>
<body id="scrapbook" class="mt-entry-archive one-column">
<script>
if (/mobile/i.test(navigator.userAgent) || /android/i.test(navigator.userAgent)) document.body.classList.add('mobile');

/*
window.addEventListener('load', function(event) {
  setTimeout(function () {
    hab('#sup-post-2');
    hab('#cre-inner');
  }, 1000);
});
*/
</script>
    <div id="container">
        <div id="container-inner">

            <div id="header">
    <div id="header-inner">
        <div id="header-content">


            <div id="header-name">阮一峰的网络日志 <span id="site_location"> » <a href="http://www.ruanyifeng.com/blog/" accesskey="1">首页</a></span><span id="site_archive"> » <a href="http://www.ruanyifeng.com/blog/archives.html">档案</a></span>
</div>

<div id="google_search">
<!-- SiteSearch Google -->
<form action="https://www.baidu.com/s" target="_blank" method="get" id="cse-search-box">
  <div>
  <input type="text" size="20" name="origin" class="searchbox" id="sbi" value="" />
  <input type="hidden" name="wd" value="" />
  <!--input type="image" src="/static/themes/theme_scrapbook/images/top_search_submit.gif" class="searchbox_submit" value="" alt="搜索" name="sa" onclick="this.form.wd.value = this.form.origin.value + ' inurl:www.ruanyifeng.com/blog'" /-->
  <input type="image" src="/static/themes/theme_scrapbook/images/top_search_submit.gif" class="searchbox_submit" value="" alt="搜索" name="sa" onclick="this.form.wd.value = this.form.origin.value + ' 阮一峰'" />
</div>
</form>

<!-- SiteSearch Google -->
</div>
<div id="feed_icon">
<a href="/feed.html" title="订阅Feed">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAUzSURBVHjavFdbbFRVFF3nPjoz7dTWTittaW0jUDRAUqaNojyqREnEQKgfUj9MqqAmhqRt/OCD4CuY+Kckoh+aiGKC+gMJbdHoRysJ8dkhhmJLNdDKtJU+6GMK87j3Hs85d2Z6HzNtMYWb3Dn3NWftvfba+5xNYDl+e6Fkj6yqb/oDRbWq14vlPBLRKCITkxf0ROLt+hNjp1PPSRK4kA3vF1dXNRcWlyA2OQU9eos9opAkAiKxD+XkKO6t15aRWO7J/MgmAZU8MEgexgZHMX518Dh72sYMmVKShnxWuWHdHtxKIDIYTgMuDzgfmSOIQkYMpdUF8OY92Hytt4/jvkg47czzU16iQovM3QFwmNck+Yyduu7D6NA0Z6JR4THntFs9V4tWQg6Ui3s6MwKDncsFTnXKLJhDSeUK3AgPtyhccDzmVs999buRt/1Vm4i0od+hX7+MRG87jPGB/w1u8FPj9xEw7McVrnYuOCvtpjTth3J/nTg99c8LRhKhr6D3dTB5R24bXFwbMXBsyZzeoXaycEpJ95TB09AGX/NpqLVNtw8urnVzLvHjFNxiFqRy2OOHuqUVnue+ACkoWzo4O6lGzTmuHq6nPvY2m9rVqjrIK2rMEKxqyG5NPAKt+wjo0LklgfNxJkZMA3KJvqRUk3z5UFY3QH14P0h+WUY79HPvgv7VuSg4ZRGY1YgZgqXmORccF17sy2ehnf9AeO085K2HQFbtXBScj0LcpgF2cN+WV+DZ/LJQu6gD4R7oV7pBJwbSgtMvfiPoVp56DySwxm7EtkMs1WdAB7qzggsDJKQYsHucSkOudrkiCPWR/fA2nYCn8SNIK4NptSMyAu3sAdDRkIsJdfth0LzSrODUoPNZ4KI9SxJI5UHk7D4GdQfz2us31c7CoHMjRkKuDPHseCMrONVhNcDJwMJpKFVvg9L4OaTiNWm1x789KCqkrXhVBiEz0WYCT2nAzQAD1/vaETv1GrRfP4Vx5cfMNcDPwvP0h0DhanPym7OIf/+O67vcJ1/PCJ4KgdzaUP6Wz+dU+5yIL6fV+PsHGAOdwlPpvvUOyeeAVGyCdqkDNB6DPjsBSrnndfOGevOh3RhGItxvA+fX1CtbGFhgYUFkFMZPR6F1HnClHq8HyubWtJexX06CRmdt33hrd7nA7SFY4qoGpnYuOKcRykPPgDCBcsHx9Iv+fNL2PueBehCWUfYQIIMGLOCcOmXDXsh1+yCt35tUPfvzGFuSvzvoinXOxqa02qOhM6733nVP2MAdaej2XN11DPKjLZCD+yBvahGCo7JfTKAN9UD7s8Oe9zUNIhz8fWI8DG2k38WCFdxugANcXrvTVd1IEbuv3Jour7Hzn7jLMBNfKs7R3i67gRVrbeCOEDhinmWhAatsqdquM2XzHZINhK2cqTjHr/XZdVJUbgN3MWAVXKbSyg9jesRW2xP9di+lwrL5ojM3m2H/kG9hwcIA37c71W6wJdW2J2S5nrjYbq/t1AHAhJsKQeyfPvf6IMJgghPJhFZ4x0KlfLFvt22du45Au/A1SOlGc0P672XXwhLtOcM0kTTEMMd0qkVmMNXxMd/tsedUjInr4SQDgOfeXMSiN0FCL5WHah4L1qqYXPJOJlttd+a5M+YpcG5poLYKQ5f+6JJ4r8bbJYP47hq4r7QAs9PjYNhHJd4o8l5taiwuOpa7AS4XKqI/5NjJbTnaWK92nLdLuhQAJayRNMiygXPBeQN+Qbvu0zDc3y+aUzhbkGR73sI7ljvUnndx2q3t+X8CDAD66FtrIL864AAAAABJRU5ErkJggg==" alt="" style="border: 0pt none;" />
</a></div>

        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-1878" class="entry-asset asset hentry">
                                <div class="asset-header">
<div class="asset-nav entry-nav">

<div class="entry-location">
<ul>
<li>上一篇：<a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html" title="Systemd 入门教程：命令篇">Systemd&nbsp;入门教</a></li>
<li>下一篇：<a href="http://www.ruanyifeng.com/blog/2016/03/node-systemd-tutorial.html" title="Node 应用的 Systemd 启动">Node&nbsp;应用的&nbsp;Sy</a></li>
</ul>
</div>


    
                                    <div class="entry-categories">
                                        <p>分类<span class="delimiter">：</span></p>
                                        <ul>
                                            <li><a href="http://www.ruanyifeng.com/blog/developer/" rel="tag">开发者手册</a></li>
                                        </ul>
                                    </div>
    


                                            
<div class="entry-location-mobile" style="float: right;">
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html" title="Systemd 入门教程：命令篇">⇐&nbsp;</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2016/03/node-systemd-tutorial.html" title="Node 应用的 Systemd 启动">&nbsp;⇒</a></li>
</ul>
</div>

</div>
</div>

                          
<article class="hentry">
                                    <h1 id="page-title" class="asset-name entry-title">Systemd 入门教程：实战篇</h1>
                                            <div id="share_button" class="social-share" style="float:right;padding-right:2em;padding-top:1em;"></div>

<div class="asset-meta">
                                        

                                            <p class="vcard author">作者： <a class="fn url" href="http://www.ruanyifeng.com">阮一峰</a></p>
                                    <p>日期： <a href="http://www.ruanyifeng.com/blog/2016/03/"><abbr class="published" title="2016-03-08T21:51:03+08:00">2016年3月 8日</abbr></a></p>


</div>








                                
                                <div class="asset-content entry-content" id="main-content">

                                    <!-- div class="asset-body" -->
                                        <p>上一篇文章，我介绍了 Systemd 的<a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">主要命令</a>，今天介绍如何使用它完成一些基本的任务。</p>

                                    <!-- /div -->


                                    <!-- div id="more" class="asset-more" -->
                                        <p><img src="http://www.ruanyifeng.com/blogimg/asset/2016/bg2016030801.jpg" alt="" title="" /></p>

<h2>一、开机启动</h2>

<p>对于那些支持 Systemd 的软件，安装的时候，会自动在<code>/usr/lib/systemd/system</code>目录添加一个配置文件。</p>

<p>如果你想让该软件开机启动，就执行下面的命令（以<code>httpd.service</code>为例）。</p>

<blockquote><pre><code class="language-bash">
$ sudo systemctl enable httpd
</code></pre></blockquote>

<p>上面的命令相当于在<code>/etc/systemd/system</code>目录添加一个符号链接，指向<code>/usr/lib/systemd/system</code>里面的<code>httpd.service</code>文件。</p>

<p>这是因为开机时，<code>Systemd</code>只执行<code>/etc/systemd/system</code>目录里面的配置文件。这也意味着，如果把修改后的配置文件放在该目录，就可以达到覆盖原始配置的效果。</p>

<h2>二、启动服务</h2>

<p>设置开机启动以后，软件并不会立即启动，必须等到下一次开机。如果想现在就运行该软件，那么要执行<code>systemctl start</code>命令。</p>

<blockquote><pre><code class="language-bash">
$ sudo systemctl start httpd
</code></pre></blockquote>

<p>执行上面的命令以后，有可能启动失败，因此要用<code>systemctl status</code>命令查看一下该服务的状态。</p>

<blockquote><pre><code class="language-bash">
$ sudo systemctl status httpd

httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled)
   Active: active (running) since 金 2014-12-05 12:18:22 JST; 7min ago
 Main PID: 4349 (httpd)
   Status: "Total requests: 1; Current requests/sec: 0; Current traffic:   0 B/sec"
   CGroup: /system.slice/httpd.service
           ├─4349 /usr/sbin/httpd -DFOREGROUND
           ├─4350 /usr/sbin/httpd -DFOREGROUND
           ├─4351 /usr/sbin/httpd -DFOREGROUND
           ├─4352 /usr/sbin/httpd -DFOREGROUND
           ├─4353 /usr/sbin/httpd -DFOREGROUND
           └─4354 /usr/sbin/httpd -DFOREGROUND

12月 05 12:18:22 localhost.localdomain systemd[1]: Starting The Apache HTTP Server...
12月 05 12:18:22 localhost.localdomain systemd[1]: Started The Apache HTTP Server.
12月 05 12:22:40 localhost.localdomain systemd[1]: Started The Apache HTTP Server.
</code></pre></blockquote>

<p>上面的输出结果含义如下。</p>

<blockquote>
  <ul>
<li><code>Loaded</code>行：配置文件的位置，是否设为开机启动</li>
<li><code>Active</code>行：表示正在运行</li>
<li><code>Main PID</code>行：主进程ID</li>
<li><code>Status</code>行：由应用本身（这里是 httpd ）提供的软件当前状态</li>
<li><code>CGroup</code>块：应用的所有子进程</li>
<li>日志块：应用的日志</li>
</ul>
</blockquote>

<h2>三、停止服务</h2>

<p>终止正在运行的服务，需要执行<code>systemctl stop</code>命令。</p>

<blockquote><pre><code class="language-bash">
$ sudo systemctl stop httpd.service
</code></pre></blockquote>

<p>有时候，该命令可能没有响应，服务停不下来。这时候就不得不"杀进程"了，向正在运行的进程发出<code>kill</code>信号。</p>

<blockquote><pre><code class="language-bash">
$ sudo systemctl kill httpd.service
</code></pre></blockquote>

<p>此外，重启服务要执行<code>systemctl restart</code>命令。</p>

<blockquote><pre><code class="language-bash">
$ sudo systemctl restart httpd.service
</code></pre></blockquote>

<h2>四、读懂配置文件</h2>

<p>一个服务怎么启动，完全由它的配置文件决定。下面就来看，配置文件有些什么内容。</p>

<p>前面说过，配置文件主要放在<code>/usr/lib/systemd/system</code>目录，也可能在<code>/etc/systemd/system</code>目录。找到配置文件以后，使用文本编辑器打开即可。</p>

<p><code>systemctl cat</code>命令可以用来查看配置文件，下面以<code>sshd.service</code>文件为例，它的作用是启动一个 SSH 服务器，供其他用户以 SSH 方式登录。</p>

<blockquote><pre><code class="language-bash">
$ systemctl cat sshd.service

[Unit]
Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.service
Wants=sshd-keygen.service

[Service]
EnvironmentFile=/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D $OPTIONS
ExecReload=/bin/kill -HUP $MAINPID
Type=simple
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
</code></pre></blockquote>

<p>可以看到，配置文件分成几个区块，每个区块包含若干条键值对。</p>

<p>下面依次解释每个区块的内容。</p>

<h2>五、 [Unit] 区块：启动顺序与依赖关系。</h2>

<p><code>Unit</code>区块的<code>Description</code>字段给出当前服务的简单描述，<code>Documentation</code>字段给出文档位置。</p>

<p>接下来的设置是启动顺序和依赖关系，这个比较重要。</p>

<blockquote>
  <p><code>After</code>字段：表示如果<code>network.target</code>或<code>sshd-keygen.service</code>需要启动，那么<code>sshd.service</code>应该在它们之后启动。</p>
</blockquote>

<p>相应地，还有一个<code>Before</code>字段，定义<code>sshd.service</code>应该在哪些服务之前启动。</p>

<p>注意，<code>After</code>和<code>Before</code>字段只涉及启动顺序，不涉及依赖关系。</p>

<p>举例来说，某 Web 应用需要 postgresql 数据库储存数据。在配置文件中，它只定义要在 postgresql 之后启动，而没有定义依赖 postgresql 。上线后，由于某种原因，postgresql 需要重新启动，在停止服务期间，该 Web 应用就会无法建立数据库连接。</p>

<p>设置依赖关系，需要使用<code>Wants</code>字段和<code>Requires</code>字段。</p>

<blockquote>
  <p><code>Wants</code>字段：表示<code>sshd.service</code>与<code>sshd-keygen.service</code>之间存在"弱依赖"关系，即如果"sshd-keygen.service"启动失败或停止运行，不影响<code>sshd.service</code>继续执行。</p>
</blockquote>

<p><code>Requires</code>字段则表示"强依赖"关系，即如果该服务启动失败或异常退出，那么<code>sshd.service</code>也必须退出。</p>

<p>注意，<code>Wants</code>字段与<code>Requires</code>字段只涉及依赖关系，与启动顺序无关，默认情况下是同时启动的。</p>

<h2>六、[Service] 区块：启动行为</h2>

<p><code>Service</code>区块定义如何启动当前服务。</p>

<h3>6.1 启动命令</h3>

<p>许多软件都有自己的环境参数文件，该文件可以用<code>EnvironmentFile</code>字段读取。</p>

<blockquote>
  <p><code>EnvironmentFile</code>字段：指定当前服务的环境参数文件。该文件内部的<code>key=value</code>键值对，可以用<code>$key</code>的形式，在当前配置文件中获取。</p>
</blockquote>

<p>上面的例子中，sshd 的环境参数文件是<code>/etc/sysconfig/sshd</code>。</p>

<p>配置文件里面最重要的字段是<code>ExecStart</code>。</p>

<blockquote>
  <p><code>ExecStart</code>字段：定义启动进程时执行的命令。</p>
</blockquote>

<p>上面的例子中，启动<code>sshd</code>，执行的命令是<code>/usr/sbin/sshd -D $OPTIONS</code>，其中的变量<code>$OPTIONS</code>就来自<code>EnvironmentFile</code>字段指定的环境参数文件。</p>

<p>与之作用相似的，还有如下这些字段。</p>

<blockquote>
  <ul>
<li><code>ExecReload</code>字段：重启服务时执行的命令</li>
<li><code>ExecStop</code>字段：停止服务时执行的命令</li>
<li><code>ExecStartPre</code>字段：启动服务之前执行的命令</li>
<li><code>ExecStartPost</code>字段：启动服务之后执行的命令</li>
<li><code>ExecStopPost</code>字段：停止服务之后执行的命令</li>
</ul>
</blockquote>

<p>请看下面的例子。</p>

<blockquote><pre><code class="language-bash">
[Service]
ExecStart=/bin/echo execstart1
ExecStart=
ExecStart=/bin/echo execstart2
ExecStartPost=/bin/echo post1
ExecStartPost=/bin/echo post2
</code></pre></blockquote>

<p>上面这个配置文件，第二行<code>ExecStart</code>设为空值，等于取消了第一行的设置，运行结果如下。</p>

<blockquote><pre><code class="language-bash">
execstart2
post1
post2
</code></pre></blockquote>

<p>所有的启动设置之前，都可以加上一个连词号（<code>-</code>），表示"抑制错误"，即发生错误的时候，不影响其他命令的执行。比如，<code>EnvironmentFile=-/etc/sysconfig/sshd</code>（注意等号后面的那个连词号），就表示即使<code>/etc/sysconfig/sshd</code>文件不存在，也不会抛出错误。</p>

<h3>6.2 启动类型</h3>

<p><code>Type</code>字段定义启动类型。它可以设置的值如下。</p>

<blockquote>
  <ul>
<li>simple（默认值）：<code>ExecStart</code>字段启动的进程为主进程</li>
<li>forking：<code>ExecStart</code>字段将以<code>fork()</code>方式启动，此时父进程将会退出，子进程将成为主进程</li>
<li>oneshot：类似于<code>simple</code>，但只执行一次，Systemd 会等它执行完，才启动其他服务</li>
<li>dbus：类似于<code>simple</code>，但会等待 D-Bus 信号后启动</li>
<li>notify：类似于<code>simple</code>，启动结束后会发出通知信号，然后 Systemd 再启动其他服务</li>
<li>idle：类似于<code>simple</code>，但是要等到其他任务都执行完，才会启动该服务。一种使用场合是为让该服务的输出，不与其他服务的输出相混合</li>
</ul>
</blockquote>

<p>下面是一个<code>oneshot</code>的例子，笔记本电脑启动时，要把触摸板关掉，配置文件可以这样写。</p>

<blockquote><pre><code class="language-bash">
[Unit]
Description=Switch-off Touchpad

[Service]
Type=oneshot
ExecStart=/usr/bin/touchpad-off

[Install]
WantedBy=multi-user.target
</code></pre></blockquote>

<p>上面的配置文件，启动类型设为<code>oneshot</code>，就表明这个服务只要运行一次就够了，不需要长期运行。</p>

<p>如果关闭以后，将来某个时候还想打开，配置文件修改如下。</p>

<blockquote><pre><code class="language-bash">
[Unit]
Description=Switch-off Touchpad

[Service]
Type=oneshot
ExecStart=/usr/bin/touchpad-off start
ExecStop=/usr/bin/touchpad-off stop
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
</code></pre></blockquote>

<p>上面配置文件中，<code>RemainAfterExit</code>字段设为<code>yes</code>，表示进程退出以后，服务仍然保持执行。这样的话，一旦使用<code>systemctl stop</code>命令停止服务，<code>ExecStop</code>指定的命令就会执行，从而重新开启触摸板。</p>

<h3>6.3 重启行为</h3>

<p><code>Service</code>区块有一些字段，定义了重启行为。</p>

<blockquote>
  <p><code>KillMode</code>字段：定义 Systemd 如何停止 sshd 服务。</p>
</blockquote>

<p>上面这个例子中，将<code>KillMode</code>设为<code>process</code>，表示只停止主进程，不停止任何sshd 子进程，即子进程打开的 SSH session 仍然保持连接。这个设置不太常见，但对 sshd 很重要，否则你停止服务的时候，会连自己打开的 SSH session 一起杀掉。</p>

<p><code>KillMode</code>字段可以设置的值如下。</p>

<blockquote>
  <ul>
<li>control-group（默认值）：当前控制组里面的所有子进程，都会被杀掉</li>
<li>process：只杀主进程</li>
<li>mixed：主进程将收到 SIGTERM 信号，子进程收到 SIGKILL 信号</li>
<li>none：没有进程会被杀掉，只是执行服务的 stop 命令。</li>
</ul>
</blockquote>

<p>接下来是<code>Restart</code>字段。</p>

<blockquote>
  <p><code>Restart</code>字段：定义了 sshd 退出后，Systemd 的重启方式。</p>
</blockquote>

<p>上面的例子中，<code>Restart</code>设为<code>on-failure</code>，表示任何意外的失败，就将重启sshd。如果 sshd 正常停止（比如执行<code>systemctl stop</code>命令），它就不会重启。</p>

<p><code>Restart</code>字段可以设置的值如下。</p>

<blockquote>
  <ul>
<li>no（默认值）：退出后不会重启</li>
<li>on-success：只有正常退出时（退出状态码为0），才会重启</li>
<li>on-failure：非正常退出时（退出状态码非0），包括被信号终止和超时，才会重启</li>
<li>on-abnormal：只有被信号终止和超时，才会重启</li>
<li>on-abort：只有在收到没有捕捉到的信号终止时，才会重启</li>
<li>on-watchdog：超时退出，才会重启</li>
<li>always：不管是什么退出原因，总是重启</li>
</ul>
</blockquote>

<p>对于守护进程，推荐设为<code>on-failure</code>。对于那些允许发生错误退出的服务，可以设为<code>on-abnormal</code>。</p>

<p>最后是<code>RestartSec</code>字段。</p>

<blockquote>
  <p><code>RestartSec</code>字段：表示 Systemd 重启服务之前，需要等待的秒数。上面的例子设为等待42秒。</p>
</blockquote>

<h2>七、[Install] 区块</h2>

<p><code>Install</code>区块，定义如何安装这个配置文件，即怎样做到开机启动。</p>

<blockquote>
  <p><code>WantedBy</code>字段：表示该服务所在的 Target。</p>
</blockquote>

<p><code>Target</code>的含义是服务组，表示一组服务。<code>WantedBy=multi-user.target</code>指的是，sshd 所在的 Target 是<code>multi-user.target</code>。</p>

<p>这个设置非常重要，因为执行<code>systemctl enable sshd.service</code>命令时，<code>sshd.service</code>的一个符号链接，就会放在<code>/etc/systemd/system</code>目录下面的<code>multi-user.target.wants</code>子目录之中。</p>

<p>Systemd 有默认的启动 Target。</p>

<blockquote><pre><code class="language-bash">
$ systemctl get-default
multi-user.target
</code></pre></blockquote>

<p>上面的结果表示，默认的启动 Target 是<code>multi-user.target</code>。在这个组里的所有服务，都将开机启动。这就是为什么<code>systemctl enable</code>命令能设置开机启动的原因。</p>

<p>使用 Target 的时候，<code>systemctl list-dependencies</code>命令和<code>systemctl isolate</code>命令也很有用。</p>

<blockquote><pre><code class="language-bash">
# 查看 multi-user.target 包含的所有服务
$ systemctl list-dependencies multi-user.target

# 切换到另一个 target
# shutdown.target 就是关机状态
$ sudo systemctl isolate shutdown.target
</code></pre></blockquote>

<p>一般来说，常用的 Target 有两个：一个是<code>multi-user.target</code>，表示多用户命令行状态；另一个是<code>graphical.target</code>，表示图形用户状态，它依赖于<code>multi-user.target</code>。官方文档有一张非常清晰的 <a href="https://www.freedesktop.org/software/systemd/man/bootup.html#System%20Manager%20Bootup">Target 依赖关系图</a>。</p>

<h2>八、Target 的配置文件</h2>

<p>Target 也有自己的配置文件。</p>

<blockquote><pre><code class="language-bash">
$ systemctl cat multi-user.target

[Unit]
Description=Multi-User System
Documentation=man:systemd.special(7)
Requires=basic.target
Conflicts=rescue.service rescue.target
After=basic.target rescue.service rescue.target
AllowIsolate=yes
</code></pre></blockquote>

<p>注意，Target 配置文件里面没有启动命令。</p>

<p>上面输出结果中，主要字段含义如下。</p>

<blockquote>
  <p><code>Requires</code>字段：要求<code>basic.target</code>一起运行。</p>

<p><code>Conflicts</code>字段：冲突字段。如果<code>rescue.service</code>或<code>rescue.target</code>正在运行，<code>multi-user.target</code>就不能运行，反之亦然。</p>

<p><code>After</code>：表示<code>multi-user.target</code>在<code>basic.target</code> 、 <code>rescue.service</code>、 <code>rescue.target</code>之后启动，如果它们有启动的话。</p>

<p><code>AllowIsolate</code>：允许使用<code>systemctl isolate</code>命令切换到<code>multi-user.target</code>。</p>
</blockquote>

<h2>九、修改配置文件后重启</h2>

<p>修改配置文件以后，需要重新加载配置文件，然后重新启动相关服务。</p>

<blockquote><pre><code class="language-bash">
# 重新加载配置文件
$ sudo systemctl daemon-reload

# 重启相关服务
$ sudo systemctl restart foobar
</code></pre></blockquote>

<p>（完）</p>

                                    <!-- /div -->

                                </div>
    <script type="text/javascript" src="/newwindow.js"></script>
                                <div class="asset-footer">

<h3>文档信息</h3>
<ul>
<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>
<li>发表日期： <abbr class="published" title="2016-03-08T21:51:03+08:00">2016年3月 8日</abbr></li>

</ul>
                                </div>
</article>
                            </div>

  <div style="display: inline-block ! important;width: 100%;">
  <p style="text-align:center;font-size: 16px;">
    <a title="极客大学" target="_blank" href="https://u.geekbang.org/subject/fe/1000447?utm_source=ruanyf&utm_medium=ad0519&utm_term=ruanyfad0519&gk_cus_user_wechat=university">winter 老师的前端训练营</a>
    <br>
    <a title="极客大学" href="https://u.geekbang.org/subject/fe/1000447?utm_source=ruanyf&utm_medium=ad0519&utm_term=ruanyfad0519&gk_cus_user_wechat=university" target="_blank"><img alt="极客大学" src="https://www.wangbase.com/blogimg/asset/202005/bg2020051901.jpg" style="border: 1px solid #666;display: block !important;width:100%;max-width:100%;" /></a>
  </p>
  </div>

<div id="related_entries">
<h2>相关文章</h2>
<ul>

<li><strong>2020.04.27: <a href="http://www.ruanyifeng.com/blog/2020/04/git-cherry-pick.html">git cherry-pick 教程</a></strong>

                           <div class="entry-body">
                              对于多分支的代码库，将代码从一个分支转移到另一个分支是常见需求。

                           </div>

</li>

 
<li><strong>2020.04.16: <a href="http://www.ruanyifeng.com/blog/2020/04/bash-tutorial.html">《Bash 脚本教程》发布了</a></strong>

                           <div class="entry-body">
                              过去三个月，我一直在写《Bash 脚本教程》，现在终于写完了。

                           </div>

</li>

 
<li><strong>2020.02.23: <a href="http://www.ruanyifeng.com/blog/2020/02/sparql.html">RDF 和 SPARQL 初探：以维基数据为例</a></strong>

                           <div class="entry-body">
                              维基百科有一个姐妹项目，叫做"维基数据"（Wikidata）。你可以从维基百科左侧边栏点进去。

                           </div>

</li>

 
<li><strong>2020.01.14: <a href="http://www.ruanyifeng.com/blog/2020/01/ffmpeg.html">FFmpeg 视频处理入门教程</a></strong>

                           <div class="entry-body">
                              FFmpeg 是视频处理最常用的开源软件。

                           </div>

</li>

 
</ul>
</div>


<div id="cre" style="display: block !important;">
<h2>广告<a href="/support.html">（购买广告位）</a></h2>
<div id="cre-inner">

<p style="font-size:16px;text-align:center;"><a title="Vue 源码剖析课程" href="https://datayi.cn/w/xogjqgOP" target="_blank">Vue 源码剖析课程</a></p>
<a title="Vue 源码剖析课程" href="https://datayi.cn/w/xogjqgOP" target="_blank"><image alt=="Vue 源码剖析课程" src="https://www.wangbase.com/blogimg/asset/202005/bg2020052207.jpg" style="border:none;" /></a>



</div>
</div>








                    

                    <div id="comments" class="comments">


    
    
        
    <h2 class="comments-header">留言（27条）</h2>

    <div id="comments-content" class="comments-content" style="clear: left;">
        
        <div id="comment-354861" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">taoyu</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354861">
            <p>很清晰实用。赞</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March  9, 2016 12:04 PM">2016年3月 9日 12:04</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354861">#</a>
 | <a href="#comment-text" title="引用taoyu的这条留言" onclick="return CommentQuote('comment-quote-354861','taoyu');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-354878" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">yak</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354878">
            <blockquote><pre>前面说过，配置文件主要放在/usr/lib/systemd/system目录，也可能在/usr/lib/systemd/system目录。</pre></blockquote>

<p>是不是 typo 了？</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March  9, 2016  5:54 PM">2016年3月 9日 17:54</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354878">#</a>
 | <a href="#comment-text" title="引用yak的这条留言" onclick="return CommentQuote('comment-quote-354878','yak');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-354879" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">阮一峰</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354879">
            <p>确实写错了，我改一下。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March  9, 2016  6:35 PM">2016年3月 9日 18:35</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354879">#</a>
 | <a href="#comment-text" title="引用阮一峰的这条留言" onclick="return CommentQuote('comment-quote-354879','阮一峰');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-354920" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">Dio</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354920">
            <p>請問修改了systemd自己的配置檔後，例如/etc/systemd/system.conf<br />
，是否一定需要重啟機器才會生效?<br />
我試了一下daemon-reload與restart單一的unit，配置還是不會生效</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March 11, 2016  4:40 PM">2016年3月11日 16:40</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354920">#</a>
 | <a href="#comment-text" title="引用Dio的这条留言" onclick="return CommentQuote('comment-quote-354920','Dio');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-354925" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">阮一峰</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354925">
            <p>@dio：</p>

<p>查了systemd.conf(5)，里面也没说，看来是需要重启机器了。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March 11, 2016  9:48 PM">2016年3月11日 21:48</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354925">#</a>
 | <a href="#comment-text" title="引用阮一峰的这条留言" onclick="return CommentQuote('comment-quote-354925','阮一峰');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-354927" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="http://teachcourse.cn" href="http://teachcourse.cn" target="_blank" rel="nofollow">TeachCourse</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354927">
            <p>玩技术的，有时候写出来的东西，感觉懂的人自然容易看明白，不懂的感觉很吃力。。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March 11, 2016 11:44 PM">2016年3月11日 23:44</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354927">#</a>
 | <a href="#comment-text" title="引用TeachCourse的这条留言" onclick="return CommentQuote('comment-quote-354927','TeachCourse');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-354933" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="http://lvguoning.com" href="http://lvguoning.com" target="_blank" rel="nofollow">Daniel Lv</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354933">
            <p>我想搞明白的是 systemd 如何兼容 upstart 以及 system V 的？<br />
如果安装了 Ubuntu 15.10 Server （当下的最新版本），会发现 “/etc/systemd” 和 "/etc/init" 以及 "/etc/init.d" 下都有各自的服务进程配置文件，互相之间的关系又是什么呢？</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March 12, 2016 11:00 AM">2016年3月12日 11:00</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354933">#</a>
 | <a href="#comment-text" title="引用Daniel Lv的这条留言" onclick="return CommentQuote('comment-quote-354933','Daniel Lv');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-354999" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="http://rambone.me" href="http://rambone.me" target="_blank" rel="nofollow">rambone</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-354999">
            <blockquote>
<pre>引用Daniel Lv的发言：</pre>

<p>我想搞明白的是 systemd 如何兼容 upstart 以及 system V 的？<br />
如果安装了 Ubuntu 15.10 Server （当下的最新版本），会发现 “/etc/systemd” 和 "/etc/init" 以及 "/etc/init.d" 下都有各自的服务进程配置文件，互相之间的关系又是什么呢？</p>

</blockquote>

<p>ll /sbin/init 就清楚了 应该是systemd的link文件</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March 14, 2016  7:45 PM">2016年3月14日 19:45</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-354999">#</a>
 | <a href="#comment-text" title="引用rambone的这条留言" onclick="return CommentQuote('comment-quote-354999','rambone');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-367175" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">Yiutto</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-367175">
            <p>最近在学习centos，安装的是centos7.2，<br />
后发现每次关机时，电源不断电，每次都要我强制关机才能切断电源。<br />
网上一些powoff -p now, halt、init 0 等命令，都没有用</p>

<p>请问大神有什么方法，能每次点power off就会关机，断电源</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="October 27, 2016  1:57 PM">2016年10月27日 13:57</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-367175">#</a>
 | <a href="#comment-text" title="引用Yiutto的这条留言" onclick="return CommentQuote('comment-quote-367175','Yiutto');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-367277" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">Alxsc</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-367277">
            <blockquote>
<pre>引用Yiutto的发言：</pre>

<p>最近在学习centos，安装的是centos7.2，<br />
后发现每次关机时，电源不断电，每次都要我强制关机才能切断电源。<br />
网上一些powoff -p now, halt、init 0 等命令，都没有用</p>

<p>请问大神有什么方法，能每次点power off就会关机，断电源</p>

</blockquote>

<p>试试 sudo systemctl poweroff 命令, 在大神的上一篇 “Systemd 入门教程：命令篇” 中有提及。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="October 28, 2016  4:37 PM">2016年10月28日 16:37</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-367277">#</a>
 | <a href="#comment-text" title="引用Alxsc的这条留言" onclick="return CommentQuote('comment-quote-367277','Alxsc');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-367840" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">blue</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-367840">
            <p>看了命令篇和实践篇，作者思路清晰，解释到位。很好的入门材料，受益了。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="November  5, 2016 11:57 PM">2016年11月 5日 23:57</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-367840">#</a>
 | <a href="#comment-text" title="引用blue的这条留言" onclick="return CommentQuote('comment-quote-367840','blue');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-370462" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">Passenger22222</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-370462">
            <blockquote>
<pre>引用Yiutto的发言：</pre>

<p>最近在学习centos，安装的是centos7.2，<br />
后发现每次关机时，电源不断电，每次都要我强制关机才能切断电源。<br />
网上一些powoff -p now, halt、init 0 等命令，都没有用</p>

<p>请问大神有什么方法，能每次点power off就会关机，断电源</p>

</blockquote>

<p>shutdown -h now</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="December 15, 2016  7:44 PM">2016年12月15日 19:44</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-370462">#</a>
 | <a href="#comment-text" title="引用Passenger22222的这条留言" onclick="return CommentQuote('comment-quote-370462','Passenger22222');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-375186" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">tengent</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-375186">
            <p>Quote“这是因为开机时，Systemd只执行/etc/systemd/system目录里面的配置文件。”<br />
这句话貌似说的不太正确吧, /etc/systemd/system是优先执行，而不是只执行吧。 <br />
reference：https://www.freedesktop.org/wiki/Software/systemd/FrequentlyAskedQuestions/</p>

<p>Q: I want to change a service file, but rpm keeps overwriting it in /usr/lib/systemd/system all the time, how should I handle this?</p>

<p>A: The recommended way is to copy the service file from /usr/lib/systemd/system to /etc/systemd/system and edit it there. <b>The latter directory takes precedence over the former<b>, and rpm will never overwrite it. If you want to use the distributed service file again you can simply delete (or rename) the service file in /etc/systemd/system again.</b></b></p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March 21, 2017 11:37 AM">2017年3月21日 11:37</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-375186">#</a>
 | <a href="#comment-text" title="引用tengent的这条留言" onclick="return CommentQuote('comment-quote-375186','tengent');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-378133" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">花承赞</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-378133">
            <blockquote>
<pre>引用tengent的发言：</pre>

<p>Quote“这是因为开机时，Systemd只执行/etc/systemd/system目录里面的配置文件。”<br />
这句话貌似说的不太正确吧, /etc/systemd/system是优先执行，而不是只执行吧。 <br />
reference：https://www.freedesktop.org/wiki/Software/systemd/FrequentlyAskedQuestions/</p>

<p>Q: I want to change a service file, but rpm keeps overwriting it in /usr/lib/systemd/system all the time, how should I handle this?</p>

<p>A: The recommended way is to copy the service file from /usr/lib/systemd/system to /etc/systemd/system and edit it there. The latter directory takes precedence over the former, and rpm will never overwrite it. If you want to use the distributed service file again you can simply delete (or rename) the service file in /etc/systemd/system again.</p>

</blockquote>

<p>稳得，Arch wiki 上也是说 /etc/systemd/system 优先级高</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="June 22, 2017  4:47 PM">2017年6月22日 16:47</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-378133">#</a>
 | <a href="#comment-text" title="引用花承赞的这条留言" onclick="return CommentQuote('comment-quote-378133','花承赞');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-382323" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="https://mrliz.github.io/" href="https://mrliz.github.io/" target="_blank" rel="nofollow">Mr.L</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-382323">
            <p>赞!浅显易懂。我怎么就写不出！</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="November 14, 2017 10:30 PM">2017年11月14日 22:30</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-382323">#</a>
 | <a href="#comment-text" title="引用Mr.L的这条留言" onclick="return CommentQuote('comment-quote-382323','Mr.L');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-386103" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">lpf</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-386103">
            <p>写的很好，很详细，主要写出了linux中操作的本质(对文件的编辑)</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="February 27, 2018  4:55 PM">2018年2月27日 16:55</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-386103">#</a>
 | <a href="#comment-text" title="引用lpf的这条留言" onclick="return CommentQuote('comment-quote-386103','lpf');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-388399" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">wing</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-388399">
            <blockquote>
<pre>引用花承赞的发言：</pre>

<p></p>

<p>稳得，Arch wiki 上也是说 /etc/systemd/system 优先级高</p>

</blockquote>

<p>只是执行是针对/var/lib/systemd/system说的，就是说，尽管这里面也有，但系统只是执行/etc/...../syetem下有链接的。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="May  1, 2018 11:46 AM">2018年5月 1日 11:46</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-388399">#</a>
 | <a href="#comment-text" title="引用wing的这条留言" onclick="return CommentQuote('comment-quote-388399','wing');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-395012" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">DPnice</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-395012">
            <p>大佬们 systemctl  把 springboot 项目 搞成 服务  ，springboot项目里配置了 日志 ，但是用systemctl  启动 日志 没有创建 是什么原因</p>

<p>我写了一个 创建 文件 的 脚本 然后 用 systemctl  执行  创建不了</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="November 15, 2018  4:31 PM">2018年11月15日 16:31</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-395012">#</a>
 | <a href="#comment-text" title="引用DPnice的这条留言" onclick="return CommentQuote('comment-quote-395012','DPnice');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-408249" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">zzk</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-408249">
            <p>写的很详细。棒！</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="February 15, 2019  2:38 PM">2019年2月15日 14:38</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-408249">#</a>
 | <a href="#comment-text" title="引用zzk的这条留言" onclick="return CommentQuote('comment-quote-408249','zzk');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-408294" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="http://as4k.top" href="http://as4k.top" target="_blank" rel="nofollow">阿胜4K</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-408294">
            <p>太强了！全网最直观systemd教程，我看了几遍。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="February 19, 2019 11:37 AM">2019年2月19日 11:37</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-408294">#</a>
 | <a href="#comment-text" title="引用阿胜4K的这条留言" onclick="return CommentQuote('comment-quote-408294','阿胜4K');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-408298" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">疯琴</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-408298">
            <p>上面配置文件中，RemainAfterExit字段设为yes，表示进程退出以后，服务仍然保持执行。这样的话，一旦使用systemctl stop命令停止服务，ExecStop指定的命令就会执行，从而重新开启触摸板。</p>

<p>这段没看懂，systemctl stop以后ExecStop制定的命令就是关闭触摸板，为啥会重新开启？</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="February 19, 2019  2:48 PM">2019年2月19日 14:48</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-408298">#</a>
 | <a href="#comment-text" title="引用疯琴的这条留言" onclick="return CommentQuote('comment-quote-408298','疯琴');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-410109" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">yoyo</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-410109">
            <p>怎么注释掉一个配置行？</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="March 23, 2019  2:06 PM">2019年3月23日 14:06</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-410109">#</a>
 | <a href="#comment-text" title="引用yoyo的这条留言" onclick="return CommentQuote('comment-quote-410109','yoyo');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-410321" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="https://www.xiebruce.top" href="https://www.xiebruce.top" target="_blank" rel="nofollow">无名氏</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-410321">
            <blockquote>
<pre>引用疯琴的发言：</pre>

<p>上面配置文件中，RemainAfterExit字段设为yes，表示进程退出以后，服务仍然保持执行。这样的话，一旦使用systemctl stop命令停止服务，ExecStop指定的命令就会执行，从而重新开启触摸板。</p>

<p>这段没看懂，systemctl stop以后ExecStop制定的命令就是关闭触摸板，为啥会重新开启？</p>

</blockquote>

<p>其实我也没太懂，这里有解释，其实我也没太懂：https://stackoverflow.com/questions/38072849/when-should-the-option-remainafterexit-needs-to-be-set-true-when-creating-new-sy</p>

<p>这里也有个例子：https://www.shellhacks.com/systemd-service-file-example/，这个例子的意思是有些一次性执行的命令，比如清空/tmp目录，但它又是后面程序的依赖，就是说后面的程序必须等它清空后才能执行，否则会报错，比如有些.sock文件要清除(我的nginx就是这样)，但是因为它是一次性命令，这决定了它不可能保持运行，但后面的程序又要它为active才可以，所以用RemainAfterExit=yes来让后面依赖它的程序认为它还处于运行状态，事实上它并没有在运行，但它确实已经做过清理/tmp目录的工作了。我不知道我说的这样你明白不？</p>

<p>但我还是希望阮老师能解释一下，因为我认为你说的这句话是有问题的。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="April  3, 2019  3:30 PM">2019年4月 3日 15:30</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-410321">#</a>
 | <a href="#comment-text" title="引用无名氏的这条留言" onclick="return CommentQuote('comment-quote-410321','无名氏');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-410322" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="https://www.xiebruce.top" href="https://www.xiebruce.top" target="_blank" rel="nofollow">无名氏</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-410322">
            <p>我又看了一下，又懂一点了，你要看清楚，它是：/usr/bin/touchpad-off，也就是说：/usr/bin/touchpad-off start 就是关闭，而/usr/bin/touchpad-off stop反而是开启(stop off就是停止关闭，那不就是打开的意思么？双重否定哈哈，差点被忽悠了)</p>

<p>至于RemainAfterExit=yes 表示程序退出后依然保持执行，我的理解是，因为这本身就是oneshot命令，也就是一次性的，它掉就是关掉了，而且除非你重新开启，否则肯定是“保持关掉”的状态，但是stop命令不知道呀，你执行stop的前提是systemctl status看到的状态是“active”状态，你才可以stop，否则你本身就是stop状态的话，是无法执行stop的，所以才需要RemainAfterExit=yes 来让systemctl认为它处于start状态，然后你才能stop。</p>

<p>前面的评论错怪阮老师了，不好意思啊！不过这里确实不是很好理解，我次我认为我的理解是没错的了！</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="April  3, 2019  3:44 PM">2019年4月 3日 15:44</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-410322">#</a>
 | <a href="#comment-text" title="引用无名氏的这条留言" onclick="return CommentQuote('comment-quote-410322','无名氏');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-412590" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">xtzt</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-412590">
            <p>思路非常清晰！！！<br />
讲的寻寻渐进，环环相扣！！！<br />
不错！！！</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="August  6, 2019  1:31 PM">2019年8月 6日 13:31</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-412590">#</a>
 | <a href="#comment-text" title="引用xtzt的这条留言" onclick="return CommentQuote('comment-quote-412590','xtzt');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-412738" class="comment">
    <div  class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author">yuzhewo</span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-412738">
            <p>如何填写自己的配置，例如程序的端口指定或者配置文件路径指定。</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="August 15, 2019 11:21 AM">2019年8月15日 11:21</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-412738">#</a>
 | <a href="#comment-text" title="引用yuzhewo的这条留言" onclick="return CommentQuote('comment-quote-412738','yuzhewo');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    
        
        <div id="comment-418115" class="comment">
    <div id="comment-last" class="inner">
        <div class="comment-header">
            <div class="asset-meta">
<p>
                <span class="byline">
                    

                    <span class="vcard author"><a title="http://duboglong.com" href="http://duboglong.com" target="_blank" rel="nofollow">梦凡</a></span>

 说：
                </span>
</p>
            </div>
        </div>
        <div class="comment-content" id="comment-quote-418115">
            <p>请教一个问题，如果启动tgt服务前，要求目录/mnt/share被挂载，那么在tgt.service中应该增加哪些内容？</p>
        </div>
<div class="comment-footer">
<div class="comment-footer-inner">
<p>
                   <abbr class="published" title="April 30, 2020  4:49 PM">2020年4月30日 16:49</abbr>
 | <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html#comment-418115">#</a>
 | <a href="#comment-text" title="引用梦凡的这条留言" onclick="return CommentQuote('comment-quote-418115','梦凡');">引用</a>
</p>
</div>
</div>
    </div>
</div>
        
    </div>
        
    


    
    
    <div class="comments-open" id="comments-open">
        <h2 class="comments-open-header">我要发表看法</h2>
        <div class="comments-open-content">

        
            <div id="comment-greeting"></div>

            <form method="post" action="http://www.ruanyifeng.com/cgi-bin/mtos/mt-comments.cgi" name="comments_form" id="comments-form" onsubmit="return pleaseWait();">
                <input type="hidden" name="static" value="1" />
                <input type="hidden" name="entry_id" value="1878" />
                <input type="hidden" name="__lang" value="en" />
                <input type="hidden" name="parent_id" value="" id="comment-parent-id" />
                <input type="hidden" name="armor" value="1" />
                <input type="hidden" name="preview" value="" />
                <input type="hidden" name="sid" value="" />
                <div id="comments-open-data">
            <div id="comments-open-text">
                    <p><label for="comment-text">您的留言
                    （HTML标签部分可用）</label></p>
                    <p><textarea id="comment-text" name="text" rows="10" cols="50"></textarea></p>
                </div>
                    <div id="comment-form-name">
                        <p><label for="comment-author">您的大名：</label></p>
                        <p><input id="comment-author" name="author" size="30" value="" />  <span class="hint"> &laquo;-必填</span></p>
                    </div>
                    <div id="comment-form-email">
                        <p><label for="comment-email">电子邮件：</label></p>
                        <p><input id="comment-email" name="email" size="30" value="" />  <span class="hint"> &laquo;-必填，不公开</span></p>
                    </div>
                    <div id="comment-form-url">
                        <p><label for="comment-url">个人网址：</label></p>
                        <p><input id="comment-url" name="url" size="30" value="" />  <span class="hint"> &laquo;-我信任你，不会填写广告链接</span></p>
                    </div>
                    <div id="comment-form-remember-me">
                        <p>
                        <label for="comment-bake-cookie">记住个人信息？</label><input type="checkbox" id="comment-bake-cookie" name="bakecookie" onclick="!this.checked?forgetMe(document.comments_form):rememberMe(document.comments_form)" value="1" accesskey="r" /></p>
                    </div>
                </div>
                    <div id="comment-form-reply" style="display:none">
                    <input type="checkbox" id="comment-reply" name="comment_reply" value="" onclick="mtSetCommentParentID()" />
                    <label for="comment-reply" id="comment-reply-label"></label>
                </div>
                <div id="comments-open-captcha"></div>
                <div id="comments-open-footer">
<div id="wait" style="display:none;">
<p><strong>正在发表您的评论，请稍候</strong></p>
<p>
<input type="text" name="percent" size="3" style="font-family:Arial; color:black;text-align:center; border-width:medium; border-style:none;">           
<input type="text" name="chart" size="46" style="font-family:Arial;font-weight:bolder; color:black; padding:0px; border-style:none;">
</p>
</div>

                    <p><input type="submit" accesskey="s" name="post" id="comment-submit" value="发表" />  <span class="hint"> &laquo;- 点击按钮</span></p>
                </div>
            </form>


        </div>
    </div>

    


</div>




                        </div>
                    </div>

                </div>
            </div>
        <script type="text/javascript" src="http://www.ruanyifeng.com/blog/js/prism.js"></script>
        <script type="text/javascript" src="/blog/checker.js"></script> 
            <div id="footer">
<div id="footer-inner">
  <div id="footer-content">

      
<!--
      <section> 
     </section>
  <p><a title="Instagram" target="_blank" href="http://instagram.com/ruanyf">Instagram</a></p>
       <p><a title="订阅" href="https://app.feedblitz.com/f/f.fbz?Sub=348868" target="_blank">邮件订阅</a></p>
  
       <h2>Feed</h2>
       <p><a title="FeedBurner" href="http://feeds.feedburner.com/ruanyifeng" target="_blank">FeedBurner</a></p>
       <p><a title="atom.xml" href="http://www.ruanyifeng.com/blog/atom.xml" target="_blank">atom.xml</a></p>
     
      <p>支付宝：<a title="支付宝" href="alipays://platformapi/startapp?appId=20000067&url=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog" target="_blank">yifeng.ruan@gmail.com</a></p>
-->

     <section>
<!--
       <h2>授权方式</h2>
       <p><a title="许可证" href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">自由转载-非商用-非衍生-保持署名</a></p>
       <h2>微信公号</h2>
       <h2>社交帐号</h2>
       <h2>联系方式</h2>
     -->
       <p><img src="https://www.wangbase.com/blogimg/asset/202001/bg2020013101.jpg" alt="微信扫描"></p>
       <p>
         <a title="微博" href="http://weibo.com/ruanyf" target="_blank">Weibo</a> | 
         <a title="Twitter" target="_blank" href="https://twitter.com/ruanyf">Twitter</a> |
         <a title="GitHub" target="_blank" href="https://github.com/ruanyf">GitHub</a>
       </p>
     
     <p>Email: <a title="电子邮件" href="mailto:yifeng.ruan@gmail.com" target="_blank">yifeng.ruan@gmail.com</a></p>
     </section>
  
  


  </div>
</div>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46829782-1', 'ruanyifeng.com');
  ga('send', 'pageview');

</script>

<script type="text/javascript" src="/blog/stats.js"></script>
<script>
var supportImg = document.querySelector('#support-img');

if (supportImg && _hmt) {
  _hmt.push(['_trackEvent', 'banner', 'load']);
  supportImg.addEventListener('click', function () {
    _hmt.push(['_trackEvent', 'banner', 'click']);
  }, false);
}

var homepageImg = document.querySelector('#homepage_sponsor');
if (homepageImg && _hmt) {
  _hmt.push(['_trackEvent', 'homepage-banner', 'load']);
  homepageImg.addEventListener('click', function () {
    _hmt.push(['_trackEvent', 'homepage-banner', 'click']);
  }, false);
}
</script>


<div id="share_button_proto" style="display:none;">
<a class="bshareDiv" href="http://www.bshare.cn/share">分享按钮</a>



<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#uuid=15e016b4-0028-44f1-a40d-a3c9d9c13c28&style=10&bgcolor=#fff&bp=weixin,qqim,qzone,qqmb,sinaminiblog,fanfou,xueqiu,douban,facebook,twitter,gplus,instapaper&ssc=false"></script>
<script type="text/javascript" charset="utf-8">
bShare.addEntry({
    title: document.getElementById("page-title").innerHTML,
url:window.location.href
});
</script>
</div>

<script>
document.getElementById("share_button").innerHTML=document.getElementById("share_button_proto").innerHTML;
</script>





        </div>
    </div>
</body>
</html>