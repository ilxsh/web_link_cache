<!DOCTYPE html>
<!-- saved from url=(0029)http://dockone.io/article/334 -->
<html class=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
<meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1">
<meta name="renderer" content="webkit">
<title>使用Systemd运行Docker容器 - DockOne.io</title>
<meta name="keywords" content="使用,systemd,运行,docker,容器">
<meta name="description" content="使用Systemd运行Docker容器 - 【编者的话】现今Docker的每个主要发行版都在转移到Systemd上，使用Systemd运行Docker更有便于主机系统初始化以及进程管理等。但Systemd在监控容器上有一弊端，它不监控容器，而监控的是客户端，导致了若客户端与容器脱离联系后无论容器是否...">
<meta property="qc:admins" content="460401166337656177">
<!--<base href="http://dockone.io/">--><base href="."><!--[if IE]></base><![endif]-->
<link href="http://static.dockone.io/favicon.ico?t=20150328" rel="shortcut icon" type="image/x-icon">

<link rel="stylesheet" type="text/css" href="./使用Systemd运行Docker容器 - DockOne.io_files/foot.css">

<link rel="stylesheet" type="text/css" href="./使用Systemd运行Docker容器 - DockOne.io_files/bootstrap.css">
<link rel="stylesheet" type="text/css" href="./使用Systemd运行Docker容器 - DockOne.io_files/icon.css">

<link href="./使用Systemd运行Docker容器 - DockOne.io_files/common.css" rel="stylesheet" type="text/css">
<link href="./使用Systemd运行Docker容器 - DockOne.io_files/link.css" rel="stylesheet" type="text/css">
<link href="./使用Systemd运行Docker容器 - DockOne.io_files/style.css" rel="stylesheet" type="text/css">


<script type="text/javascript">
	var _B4ABED3953C9FE3C7C19C63DCEB1D5F0="";
	var G_POST_HASH=_B4ABED3953C9FE3C7C19C63DCEB1D5F0;
	var G_INDEX_SCRIPT = "";
	var G_SITE_NAME = "DockOne.io";
	var G_BASE_URL = "http://dockone.io";
	var G_STATIC_URL = "http://dockone.io/static";
	var G_UPLOAD_URL = "http://dockone.io/uploads";
	var G_USER_ID = "";
	var G_USER_NAME = "";
	var G_UPLOAD_ENABLE = "N";
	var G_UNREAD_NOTIFICATION = 0;
	var G_NOTIFICATION_INTERVAL = 100000;
	var G_CAN_CREATE_TOPIC = "";
	var G_REQUEST_URL = "/article/";

	</script>
<script src="./使用Systemd运行Docker容器 - DockOne.io_files/jquery.2.js.download" type="text/javascript"></script>
<script src="./使用Systemd运行Docker容器 - DockOne.io_files/jquery.form.js.download" type="text/javascript"></script>
<script src="./使用Systemd运行Docker容器 - DockOne.io_files/plug-in_module.js.download" type="text/javascript"></script>
<script src="./使用Systemd运行Docker容器 - DockOne.io_files/aws.js.download" type="text/javascript"></script>
<script src="./使用Systemd运行Docker容器 - DockOne.io_files/aw_template.js.download" type="text/javascript"></script>
<script src="./使用Systemd运行Docker容器 - DockOne.io_files/app.js.download" type="text/javascript"></script>
<script type="text/javascript" src="./使用Systemd运行Docker容器 - DockOne.io_files/compatibility.js.download"></script>
<!--[if lte IE 8]>
	<script type="text/javascript" src="http://dockone.io/static/js/respond.js"></script>
<![endif]-->
<style type="text/css">.fancybox-margin{margin-right:17px;}</style></head>
<body><noscript unselectable="on" id="noscript">
    <div class="aw-404 aw-404-wrap container">
        <img src="http://dockone.io/static/common/no-js.jpg">
        <p>你的浏览器禁用了JavaScript, 请开启后刷新浏览器获得更好的体验!</p>
    </div>
</noscript>


	<div class="aw-top-menu-wrap">
		<div class="container">
			<!-- logo -->
			<div class="aw-logo hidden-xs">
				<a href="http://dockone.io/"></a>
			</div>
			<!-- end logo -->
			<!-- 搜索框 -->
			<div class="aw-search-box  hidden-xs hidden-sm">
				<form class="navbar-search" action="http://dockone.io/search/" id="global_search_form" method="post">
					<input class="form-control search-query" type="text" placeholder="搜索问题、话题或人" autocomplete="off" name="q" id="aw-search-query">
					<span title="搜索" id="global_search_btns" onclick="$(&#39;#global_search_form&#39;).submit();"><i class="icon icon-search"></i></span>
					<div class="aw-dropdown">
						<div class="mod-body">
							<p class="title">输入关键字进行搜索</p>
							<ul class="aw-dropdown-list hide"></ul>
							<p class="search"><span>搜索:</span><a onclick="$(&#39;#global_search_form&#39;).submit();"></a></p>
						</div>
						<div class="mod-footer">
							<a href="http://dockone.io/publish" onclick="$(&#39;#header_publish&#39;).click();" class="pull-right btn btn-mini btn-success publish">发起问题</a>
						</div>
					</div>
				</form>
			</div>
			<!-- end 搜索框 -->
			<!-- 导航 -->
			<div class="aw-top-nav navbar">
				<div class="navbar-header">
			      <button class="navbar-toggle pull-left">
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			      </button>
			    </div>
				<nav role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
			      <ul class="nav navbar-nav">
			      	                    <li><a href="http://dockone.io/" class=""><i class="icon icon-ul"></i> 发现</a></li>

					<!-- <li><a href="http://dockone.io/question/" class="">问题</a></li>

					<li><a href="http://dockone.io/article/" class="active">文章</a></li> -->

					<li><a href="http://dockone.io/topic/"><i class="icon icon-topic"></i> 话题</a></li>
										<li><a href="http://dockone.io/help/"><i class="icon icon-bulb"></i> 帮助</a></li>			      </ul>
			    </nav>
			</div>
			<!-- end 导航 -->
			<!-- 用户栏 -->
			<div class="aw-user-nav">
				<!-- 登陆&注册栏 -->
									<a class="login btn btn-normal btn-primary" href="http://dockone.io/login/">登录</a>
					<a class="register btn btn-normal btn-success" href="http://dockone.io/account/register/">注册</a>								<!-- end 登陆&注册栏 -->
			</div>
			<!-- end 用户栏 -->
			<!-- 发起 -->
						<!-- end 发起 -->
		</div>
	</div>
	
<script type="text/javascript">
$(document).ready(function(){
$("#newClassImg").attr("src", "http://static.dockone.io/partner/banner.jpg?"+new Date().getTime());
  });
</script>
<div class="aw-container-wrap">
    <div class="container">
<br>
<a href="http://dockone.io/article/2626" target="_blank" style="display:block;margin:0 auto;margin-bottom:15px;margin-top:-40px;"><img id="newClassImg" src="./使用Systemd运行Docker容器 - DockOne.io_files/banner.jpg"></a>
        <div class="row">
            <div class="aw-content-wrap clearfix">
                <div class="col-sm-12 col-md-9 aw-main-content aw-article-content">
                    <div class="aw-mod aw-topic-bar" id="question_topic_editor" data-type="article" data-id="334">
                        <div class="tag-bar clearfix">
                                                                                    <span class="topic-tag" data-id="127">
                                <a class="text" href="http://dockone.io/topic/Systemd">Systemd</a>
                            </span>
                                                        <span class="topic-tag" data-id="7">
                                <a class="text" href="http://dockone.io/topic/Docker">Docker</a>
                            </span>
                                                        
                                                    </div>
                    </div>
                    <div class="aw-mod aw-question-detail">
                        <div class="mod-head">
                            <h1>
                                使用Systemd运行Docker容器                            </h1>

                                                    </div>
                        <div class="mod-body">
                            <div class="content markitup-box">
                                <br>【编者的话】现今Docker的每个主要发行版都在转移到Systemd上，使用Systemd运行Docker更有便于主机系统初始化以及进程管理等。但Systemd在监控容器上有一弊端，它不监控容器，而监控的是客户端，导致了若客户端与容器脱离联系后无论容器是否运行正常Systemd均会将该容器停掉等问题。但可以通过Systemd-Docker来解决。<br>
<br>你可以通过Shell脚本或者Docker Compose（目前它还不能用于生产环境）来运行Docker容器，但在一些用户场景下，你也可以使用主机系统初始化/进程管理。现在看起来，好像主流的Linux发行版本都准备使用Systemd，所以接下来我将深入介绍下Docker和Systemd。<br>
<br>如果你的一个非容器化的服务依赖于容器，那这个时候使用Systemd就可能是最好的解决方案。更有趣的是，纯容器应用的开发者也注意到Systemd的价值。最后提醒下大家，CoreOS就建立在Systemd和Docker之上。<br>
<br>在<a href="https://docs.docker.com/articles/host_integration/">『官方的Docker文档之使用Systemd』</a>中，你可以看到官方推荐手动创建Docker容器，并只在service文件中使用docker start以及docker stop。我不赞同这个建议，因为这使得主机之间的迁移配置或使用一个新容器重启服务更加困难----如果service文件包含了所有的依赖组件会更好。这是通过CoreOS的方法，我将在这博客展示一个案例。<br>
<br>我们以一个基于『Systemd』的Docker化的Redis为例来进行说明。例子中我将使用CentOS 7，我想其它的发行版也应该类似。你几乎需要以下所有的service file：<br>
<pre class="prettyprint">[Unit]<br>
Description=Redis&nbsp;Container<br>
After=Docker.service<br>
Requires=Docker.service<br>
[Service]<br>
TimeoutStartSec=0<br>
Restart=always<br>
ExecStartPre=-/usr/bin/Docker&nbsp;stop&nbsp;redis<br>
ExecStartPre=-/usr/bin/Docker&nbsp;rm&nbsp;redis<br>
ExecStartPre=/usr/bin/Docker&nbsp;pull&nbsp;redis<br>
ExecStart=/usr/bin/Docker&nbsp;run&nbsp;--rm&nbsp;--name&nbsp;%n&nbsp;redis<br>
[Install]<br>
WantedBy=multi-user.target<br>
</pre><br>
这里需要注意的事情有：<br>
<ul><li>很明显，容器依赖于Docker的运行，因此Requires 这行。After这行也需要注意避免竞争条件。</li><li>在我们启动容器之前，我们首先停掉并移除任何存在相同名称的容器，然后拉取最新的版本的镜像。以”-”开头的意味着如果命令执行失败，系统不会终止。</li><li>这意味着我们的容器将每次都从头开始。如果你希望保存数据，你需要使用volumes或volume 容器，亦或改变code（如果存在），重启旧的容器。</li><li>我们使用TimeoutStartSec=0实现永不超时，例如Docker pull可能需要一段时间。</li></ul><br>
<br>如果你保存这文件到/etc/Systemd/system/Docker.redis.service并且执行systemctl start Docker.redis，Systemd将启动Redis 容器（记住，如果它需要拉取redis镜像这可能需要花一些时间）。那么我们就可以手动访问它，或另设一个依赖于它的服务。例如，如果我们有一个是运行在一个容器并且依赖于redis服务的应用foo，我们就可以使用以下服务文件：<br>
<pre class="prettyprint">[Unit]<br>
Description=Foo&nbsp;Service<br>
After=Docker.service<br>
Requires=Docker.service<br>
After=Docker.redis.service<br>
Requires=Docker.redis.service<br>
[Service]<br>
TimeoutStartSec=0<br>
Restart=always<br>
ExecStartPre=-/usr/bin/Docker&nbsp;stop&nbsp;foo<br>
ExecStartPre=-/usr/bin/Docker&nbsp;rm&nbsp;foo<br>
ExecStartPre=/usr/bin/Docker&nbsp;pull&nbsp;foo<br>
ExecStart=/usr/bin/Docker&nbsp;run&nbsp;--name&nbsp;foo&nbsp;\<br>
--link&nbsp;Docker.redis.ervice:redis&nbsp;--rm\<br>
foo<br>
[Install]<br>
WantedBy=multi-user.target<br>
</pre><br>
如果redis容器发生故障，Systemd将自动重启redis service和依赖foo的服务。<br>
<br>这配置工作花费大部分时间，这有一个主要问题。Systemd不会监控自身的容器，它监控的是客户端。无论出于何种原因如果客户端与容器脱离（比如网络问题），Systemd将停掉这个容器，即使它可能正常运行。相反，如果容器挂了但客户端仍正常运行，Systemd不会做任何操作。我们真正需要监控的是容器，而不是客户端。正好这有一个解决方法---Systemd-Docker。<br>
<br>System-Docker的工作原理是当它启动时通过包装Docker命令和移动容器进程到Systemd服务单元的cgroup上。我们的redis实例看起来是这样的：<br>
<pre class="prettyprint">[Unit]<br>
Description=Redis<br>
After=Docker.service<br>
Requires=Docker.service<br>
[Service]<br>
TimeoutStartSec=0<br>
ExecStartPre=/usr/bin/Docker&nbsp;pull&nbsp;redis<br>
ExecStart=/usr/local/bin/Systemd-Docker&nbsp;--cgroups&nbsp;name=Systemd&nbsp;run&nbsp;--rm&nbsp;--name&nbsp;%n&nbsp;redis<br>
Restart=always<br>
RestartSec=10s<br>
Type=notify<br>
NotifyAccess=all<br>
[Install]<br>
WantedBy=multi-user.target<br>
</pre><br>
这是简单的，但有一个问题是，Systemd-Docker命令隐瞒事实，那就是具有相同名字的停止了的容器将被删除。我不得不添加--cgroups name=system 参数到存在这一问题的CentOS7和cgroups（其他发行版应该不需要这个参数）。如果你想尝试Systemd-Docker，注意，你当前必须从头构建，由于在我写本博文时，“go get”功能是不完整的提供给了Docker的一个依赖。<br>
<br>总之，如果你想使用Systemd，显然你需要在用之前思考得全面点。如果你只是使用一些工具不需要运行时超可靠的，这篇博文的的配置规则就可以了。否则你需要使用Systemd-Docker或解决监控容器的其他方法。<br>
<br>[1].在这种情况下运行，我们可以参照一个不需要修改或第三方工具的快速解决方案，请参阅下面问题的更多信息： <br>
• <a href="https://github.com/Docker/Docker/issues/7245" rel="nofollow" target="_blank">https://github.com/Docker/Docker/issues/7245</a> <br>
• <a href="https://github.com/Docker/Docker/pull/10427" rel="nofollow" target="_blank">https://github.com/Docker/Docker/pull/10427</a> <br>
• <a href="https://github.com/ibuildthecloud/Systemd-Docker/issues/25" rel="nofollow" target="_blank">https://github.com/ibuildthecl ... es/25</a><br>
<br><strong>原文链接：<a href="http://container-solutions.com/2015/04/running-docker-containers-with-systemd/">Running Docker Containers with Systemd</a>（翻译：陈艺华）</strong>
                                
                                                            </div>
                            <div class="meta clearfix">
                                <div class="aw-article-vote pull-left disabled">
                                    <a href="javascript:;" class="agree" onclick=""><i class="icon icon-agree"></i> <b>0</b></a>
                                                                    </div>

                                <span class="pull-right  more-operate">
                                    
                                    
                                    <a class="text-color-999 dropdown-toggle" data-toggle="dropdown">
                                        <i class="icon icon-share"></i> 分享                                    </a>
                                    <div aria-labelledby="dropdownMenu" role="menu" class="aw-dropdown shareout pull-right">
                                        <ul class="aw-dropdown-list">
                                            <li><a onclick="AWS.User.share_out(&#39;tsina&#39;);"><i class="icon icon-weibo"></i> 微博</a></li>
                                            <li><a onclick="AWS.User.share_out(&#39;qzone&#39;);"><i class="icon icon-qzone"></i> QZONE</a></li>
                                            <li><a onclick="AWS.User.share_out(&#39;weixin&#39;);"><i class="icon icon-wechat"></i> 微信</a></li>
                                        </ul>
                                    </div>

                                    <em class="text-color-999">2015-04-21</em>
                                </span>
                            </div>
                        </div>
                        <div class="mod-footer">
                                                    </div>
                    </div>

                    <!-- 文章评论 -->
                    <div class="aw-mod">
                        <div class="mod-head common-head">
                            <h2>0 个评论</h2>
                        </div>

                        <div class="mod-body aw-feed-list">
                                                    </div>

                        
                                            </div>
                    <!-- end 文章评论 -->

                    <!-- 回复编辑器 -->
                    <div class="aw-mod aw-article-replay-box">
                        <a name="answer_form"></a>
                                                <p align="center">要回复文章请先<a href="http://dockone.io/login/">登录</a>或<a href="http://dockone.io/account/register/">注册</a></p>
                                            </div>
                    <!-- end 回复编辑器 -->
                </div>
                <!-- 侧边栏 -->
                <div class="col-sm-12 col-md-3 aw-side-bar hidden-sm hidden-xs">
                    <!-- 发起人 -->
                                        <div class="aw-mod user-detail">
                        <div class="mod-head">
                            <h3>发起人</h3>
                        </div>
                        <div class="mod-body">
                            <dl>
                                <dt class="pull-left aw-border-radius-5">
                                    <a href="http://dockone.io/people/CDocer"><img alt="CDocer" src="./使用Systemd运行Docker容器 - DockOne.io_files/65_avatar_mid.jpg"></a>
                                </dt>
                                <dd class="pull-left">
                                    <a class="aw-user-name" href="http://dockone.io/people/CDocer" data-id="1465">CDocer</a>
                                    
                                                                        <p>90宅男</p>
                                </dd>
                            </dl>
                        </div>
                        <div class="mod-footer clearfix">
                                                    </div>
                    </div>
                                        <!-- end 发起人 -->

                                        <!-- 推荐内容 -->
                    <div class="aw-mod">
                        <div class="mod-head">
                            <h3>推荐内容</h3>
                        </div>
                        <div class="mod-body">
                            <ul>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8834">手把手教你使用 Docker 部署 Vue.js 项目</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8832">容器发展简史</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8828">10 个 Docker 镜像安全最佳实践</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8824">Docker Hub 回应数据泄露事件</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8808">房多多容器化和容器云实践</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8788">Docker 工作原理及容器化简易指南</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8780">DockOne微信分享（二零七）：瓜子云平台的实践经验</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8768">再见Docker！感谢所有人！</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8748">容器化 Go 开发环境的尝试</a>
                                                                    </li>
                                                                <li>
                                                                        <a href="http://dockone.io/article/8744">Docker镜像瘦身与优化</a>
                                                                    </li>
                                                            </ul>
                        </div>
                    </div>
                    <!-- end 推荐内容 -->
                    
                                        <!-- 相关问题 -->
                    <div class="aw-mod aw-text-align-justify question-related-list">
                        <div class="mod-head">
                            <h3>相关问题</h3>
                        </div>
                        <div class="mod-body">
                            <ul>
                                                                <li><a href="http://dockone.io/question/151">Docker如何为企业产生价值？</a></li>
                                                                <li><a href="http://dockone.io/question/341">大家对国内的Docker meetup活动组织有什么建议和想法？比如希望在哪些城市举办？希望听到什么样的话题？</a></li>
                                                                <li><a href="http://dockone.io/question/24">请教下代码放在Docker里面还是外面呢</a></li>
                                                                <li><a href="http://dockone.io/question/10">如何学习Docker</a></li>
                                                                <li><a href="http://dockone.io/question/408">Docker container 到底应该翻译成什么？容器？集装箱？</a></li>
                                                                <li><a href="http://dockone.io/question/160">Machine、Swarm、Compose、SocketPlane这些Docker生态圈软件各解决了哪些问题？</a></li>
                                                                <li><a href="http://dockone.io/question/430">国内有哪些Docker大牛？</a></li>
                                                                <li><a href="http://dockone.io/question/54">容器里Nginx、MySQL的配置文件、日志是否应该挂载到宿主上？</a></li>
                                                                <li><a href="http://dockone.io/question/574">docker书籍</a></li>
                                                                <li><a href="http://dockone.io/question/199">Docker容器使用--net=host的方式启动的，怎么用ssh去连接容器</a></li>
                                                                <li><a href="http://dockone.io/question/187">容器OS的选择与使用</a></li>
                                                            </ul>
                        </div>
                    </div>
                    <!-- end 相关问题 -->
                                    </div>
                <!-- end 侧边栏 -->
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    ANSWER_EDIT_TIME = 30;

    $(document).ready(function () {
        if ($('.aw-article-vote.disabled').length)
        {
            $('.aw-article-vote.disabled a').attr('onclick', '');
        }

        AWS.at_user_lists('#wmd-input');

        AWS.Init.init_article_comment_box($('.aw-article-comment'));
    });
</script>

	
<footer class="footer">
  <div class="subscribe-email row1 text-center">
    <h3>DockOne.io，专业的Cloud Native技术交流平台</h3>
    <p>关注Cloud Native相关的产品以及开源项目</p>
      </div>
  <div class="row1">
    <div class="copyright">
      <p> 2019 <strong>DockOne</strong>. All Rights Reserved.</p>
      <p class="">DockOne，新圈子，新思路，新视野。</p>
<p class="zz">本网站服务器由<a href="http://www.ucloud.cn/?utm_source=zanzhu&amp;utm_campaign=DokerOne&amp;utm_medium=display">UCloud云服务</a>提供。</p>
    </div>

    <div class="footer-follow">
      <ul class="cf">
        <li><a class="icons-weibo" href="http://weibo.com/dockerone" title="Weibo" target="_blank">Weibo</a></li>
        <li style="position:relative"><a class="icons-twitter" onmouseover="mousemethod(&#39;block&#39;,&#39;img1&#39;)" onmouseout="mousemethod(&#39;none&#39;,&#39;img1&#39;)" title="Wechat" target="_blank" style="cursor:pointer;">Wechat</a><img src="./使用Systemd运行Docker容器 - DockOne.io_files/wechat.jpg" width="100" style="position:absolute; top:37px; left:-32px; display:none;" id="img1"></li>
<li><a class="icons-weekly" href="http://weekly.dockone.io/" title="周报" target="_blank">周报</a></li>
 <li><a class="icons-rss" href="http://dockone.io/feed" title="Feed" target="_blank">Feed</a></li>
      </ul>
    </div>
    <script>
	function mousemethod(op,imgid){
	document.getElementById(imgid).style.display=op;
	}
</script>
  </div>

</footer>


<a class="aw-back-top hidden-xs" href="javascript:;" onclick="$.scrollTo(1, 600, {queue:true});" style="display: none;"><i class="icon icon-up"></i></a>

<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F1f6d1a718ac6b6eb3902c92775fb128e' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./使用Systemd运行Docker容器 - DockOne.io_files/h.js.download" type="text/javascript"></script>

<!-- DO NOT REMOVE -->
<div id="aw-ajax-box" class="aw-ajax-box"></div>
<div style="display:none;" id="__crond"><img src="./使用Systemd运行Docker容器 - DockOne.io_files/1558192380" width="1" height="1"></div>

<!-- Escape time: 0.20000600814819 --><!-- / DO NOT REMOVE -->



</body></html>