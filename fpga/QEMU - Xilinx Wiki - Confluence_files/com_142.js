WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/amd/mediaviewer-amd.js' */
(function(){define("MediaViewer",MediaViewerFactory);define("FileViewer",MediaViewerFactory);define("core/template-store-singleton",function(){var properties=/^[a-zA-Z0-9.]+$/;return{get:function(name){return properties.test(name)?eval("FileViewer.Templates."+name):null}}});function MediaViewerFactory(){AJS.I18n.keys["cp.footer.expand.minimode"]="Show all files";AJS.I18n.keys["cp.footer.close.minimode"]="Hide all files";AJS.I18n.keys["cp.thumbnail.description"]="View a larger version of {0}";AJS.I18n.keys["cp.expand.thumbnail.minimode"]="Show all files";AJS.I18n.keys["cp.close.thumbnail.minimode"]="Hide all files";AJS.I18n.keys["cp.go.to.prev"]="Go to the previous file";AJS.I18n.keys["cp.go.to.next"]="Go to the next file";AJS.I18n.keys["cp.go.to.prev.page"]="Previous page";AJS.I18n.keys["cp.go.to.next.page"]="Next page";AJS.I18n.keys["cp.close"]="Close";AJS.I18n.keys["cp.download.original"]="Download";AJS.I18n.keys["cp.fit.to.page"]="Fit to page";AJS.I18n.keys["cp.zoom.in"]="Zoom in";AJS.I18n.keys["cp.zoom.out"]="Zoom out";AJS.I18n.keys["cp.enter.presentation.mode"]="Start Presentation";AJS.I18n.keys["cp.exit.presentation.mode"]="Exit Presentation";AJS.I18n.keys["cp.image.load.fail.header"]="Image could not be loaded.";AJS.I18n.keys["cp.image.load.fail"]="Unable to load file from {0}.";AJS.I18n.keys["cp.show.more"]="More";AJS.I18n.keys["cp.edit.file"]="Edit file";AJS.I18n.keys["cp.print.file"]="Print";AJS.I18n.keys["cp.delete.file"]="Delete";AJS.I18n.keys["cp.arrow.left.disabled"]="You\'re viewing the least recent file";AJS.I18n.keys["cp.arrow.right.disabled"]="You\'re viewing the most recent file";AJS.I18n.keys["cp.password.protected"]="Enter the password to open this file:";AJS.I18n.keys["cp.password.needed"]="Please enter the password to view this file.";AJS.I18n.keys["cp.password.incorrect"]="Invalid password. Please try again.";AJS.I18n.keys["cp.password.input.placeholder"]="Password";AJS.I18n.keys["cp.password.button.ok"]="OK";AJS.I18n.keys["cp.password.fullscreen.title"]="This file is password protected.";AJS.I18n.keys["cp.password.fullscreen.message"]="Due to technical reasons you have to leave presentation mode to enter the password.";AJS.I18n.keys["cp.error.button.download"]="Download";AJS.I18n.keys["cp.error.button.browser"]="Open in browser";AJS.I18n.keys["cp.error.image.missing.header"]="Ouch! We can\'t load the image.";AJS.I18n.keys["cp.error.pdf.missing.header"]="Ouch! We can\'t load the PDF.";AJS.I18n.keys["cp.error.media.default.header"]="Ouch! We can\'t load the media file.";AJS.I18n.keys["cp.error.pdf.password.header"]="Ouch! We can\'t show password protected files yet.";AJS.I18n.keys["cp.error.pdf.password.message"]="Try downloading the file to view it.";AJS.I18n.keys["cp.error.pdf.invalid.header"]="Ouch! Looks like this document is broken.";AJS.I18n.keys["cp.error.pdf.invalid.message"]="Try downloading the file to view it.";AJS.I18n.keys["cp.error.pdf.default.header"]="Ouch! Something is wrong with this file.";AJS.I18n.keys["cp.error.pdf.default.message"]="Try downloading the file to view it.";AJS.I18n.keys["cp.error.default.header"]="The file cannot be displayed";AJS.I18n.keys["cp.error.file.not.found"]="The file does not exist";AJS.I18n.keys["cp.error.file.no.viewer"]="Cannot find a viewer for the given file";AJS.I18n.keys["cp.file.converting.message.header"]="Your preview is on its way!";AJS.I18n.keys["cp.file.converting.message.text"]="In a hurry? You can download the original right now";AJS.I18n.keys["cp.unknown.file.type.header"]="We can\'t preview this file.";AJS.I18n.keys["cp.unknown.file.type.download.to.view"]="You\'ll have to download the file to view it.";AJS.I18n.keys["cp.unknown.file.type.downloadbutton"]="Download";AJS.I18n.keys["cp.unsupported.browser.header"]="Internet Explorer 9 can\'t preview this file.";AJS.I18n.keys["cp.unsupported.browser.download.to.view"]="You\'ll have to download the file or use a different browser to view it.";AJS.I18n.keys["cp.3d.file.type.toggle.grid"]="Toggle Grid";AJS.I18n.keys["cp.3d.file.type.toggle.camera.type"]="Toggle Camera Type";AJS.I18n.keys["cp.3d.file.type.toggle.light.type"]="Toggle Scene Light";AJS.I18n.keys["cp.3d.file.type.toggle.axis"]="Toggle Axis";AJS.I18n.keys["cp.companion.newversion"]="Update new version";AJS.I18n.keys["cp.companion.downloading"]="Opening...";AJS.I18n.keys["cp.companion.waitforupload"]="Waiting for file changes from {0}";AJS.I18n.keys["cp.companion.uploading"]="Saving...";AJS.I18n.keys["cp.companion.uploaded.prefix"]="Saved";AJS.I18n.keys["cp.companion.uploading.progress"]="{0} of {1}";AJS.I18n.keys["cp.companion.uploading.progress.done"]="Complete";AJS.I18n.keys["cp.companion.buttontitle"]="Edit with";return window.MediaViewer}}());
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/amd/confluence-amd.js' */
define("confluence/legacy",function(){return Confluence});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/file-utils.js' */
define("cp/confluence/file-utils",["underscore"],function(b){function e(f){if(f.id&&f.ownerId){return f.ownerId+"-"+f.id}return f.src}function c(f){return b.uniq(f,e)}function d(j,i){var k=a(i,function(l){return b.findWhere(j,{id:l.id})});var h=k[0];var g=k[1];var f=b.map(j,function(l){var m=b.findWhere(h,{id:l.id});return b.extend({},l,m)});return c(f.concat(g))}function a(i,f){var h=function(k){return !k};var j=i.filter(f);var g=i.filter(b.compose(h,f));return[j,g]}return{matchId:e,deDupeFiles:c,mergeFiles:d,partition:a}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/async-module-backend.js' */
define("cp/confluence/async-module-backend",["jquery","ajs"],function(f,b){var a={"pdf-viewer":"wr!com.atlassian.confluence.plugins.confluence-previews:confluence-previews-pdf"};var d="com.atlassian.confluence.plugins.confluence-previews:confluence-previews-pdf-worker";var c=function(h){var g=b.Meta.get("static-resource-url-prefix");return g+"/download/resources/"+d+"/"+h};function e(){var g=new f.Deferred();f.ajax({url:b.contextPath()+"/rest/webResources/1.0/resources",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({r:[d],c:[],xc:[],xr:[]})}).done(function(l){var h;for(var k in l.resources){var j=l.resources[k].url;if(j&&j.indexOf(d)!==-1){h=j;break}}if(h){var m=c("bcmaps/");g.resolve({workerSrc:h,cMapUrl:m})}else{g.reject()}}).fail(g.reject.bind(g));return g.promise()}return function(g){if(a[g]){return WRM.require(a[g])}else{if(g==="pdf-config"){return e()}}}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/conversion-poller-backend.js' */
define("cp/confluence/conversion-poller-backend",["jquery","underscore","ajs"],function(d,c,b){function a(e){this._type=e;if(this._type==="thumbnail"){this._bulkUrl=b.contextPath()+"/rest/documentConversion/0.1/conversion/thumbnail/results";this._singleUrlBase=b.contextPath()+"/rest/documentConversion/0.1/conversion/thumbnail/"}else{this._bulkUrl=b.contextPath()+"/rest/documentConversion/0.1/conversion/convert/results";this._singleUrlBase=b.contextPath()+"/rest/documentConversion/0.1/conversion/convert/"}this._pollers={};this._timerId=0;this._interval=a.INITIAL_INTERVAL;this._debouncedChange=c.debounce(this._change,100)}a.INITIAL_INTERVAL=1000;a.MAX_INTERVAL=10000;a.BACKOFF_PERCENT=1.5;a.prototype.add=function(g,f){if(g&&!this._pollers[g]){var e=d.Deferred();this._pollers[g]={_dfd:e,_version:f};this._debouncedChange()}return this._pollers[g]._dfd.promise()};a.prototype.remove=function(e){var f=this._pollers[e];if(f){f._dfd.reject("cancelled");delete this._pollers[e]}};a.prototype._doPoll=function(){if(this._pollType==="single"){this._pollSingle()}else{if(this._pollType==="multiple"){this._pollMultiple()}}};a.prototype._backoff=function(){var e=this._interval*a.BACKOFF_PERCENT;this._interval=e>a.MAX_INTERVAL?a.MAX_INTERVAL:e;this._timerId=setTimeout(this._change.bind(this),this._interval)};a.prototype._change=function(){var f=this._getAttachmentIds();var e=!(f.length===0);this._cancel();if(!e){delete this._pollType;this._interval=1000}else{this._changeType();this._doPoll()}};a.prototype._changeType=function(){var g=this._getAttachmentIds();var f=g.length===1;var e=g.length>1;if(f&&this._pollType!=="single"){this._pollType="single"}else{if(e&&this._pollType!=="multiple"){this._pollType="multiple"}}};a.prototype._cancel=function(){clearTimeout(this._timerId);this._xhr&&this._xhr.abort();delete this._xhr};a.prototype._getAttachmentIds=function(){return Object.keys(this._pollers)};a.prototype._getIdsAndVersions=function(){var e=this._pollers;return c.map(this._getAttachmentIds(),function(f){return{id:f,v:e[f]._version}})};a.prototype._pollSingle=function(){var f=this._getAttachmentIds()[0];var g=this._pollers[f];var e=g._version;this._xhr=this._getSingle(f,e).always(function(){delete this._xhr}.bind(this)).done(function(i,j,h){if(h.status===202){this._backoff();g._dfd.notify("converting")}else{g._dfd.resolve(this._singleUrlBase+f+"/"+e,h.getResponseHeader("Content-Type"));delete this._pollers[f];this._change()}}.bind(this)).fail(function(h,j,i){if(h.status==429){this._backoff();g._dfd.notify("busy");return}if(i==="abort"){return}g._dfd.reject();delete this._pollers[f];this._change()}.bind(this))};a.prototype._getSingle=function(f,e){return d.ajax(this._singleUrlBase+f+"/"+e,{type:"HEAD",dataType:"json"})};a.prototype._pollMultiple=function(){this._xhr=d.ajax(this._bulkUrl,{type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(this._getIdsAndVersions())}).always(function(){delete this._xhr}.bind(this)).done(function(e){c(e).each(function(g,h){var i=this._pollers[h];if(!i){return}if(g==200){var f=i._version;if(this._type!=="thumbnail"){this._getSingle(h,f).done(function(k,l,j){i._dfd.resolve(this._singleUrlBase+h+"/"+f,j.getResponseHeader("Content-Type"));delete this._pollers[h]}.bind(this))}else{i._dfd.resolve(this._singleUrlBase+h+"/"+f,"image/jpg");delete this._pollers[h]}}else{if(g>=400&&g!=429){i._dfd.reject();delete this._pollers[h]}}}.bind(this));this._backoff()}.bind(this))};return a});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/conversion-poller.js' */
define("cp/confluence/conversion-poller",["cp/confluence/conversion-poller-backend","jquery"],function(a,e){var b={};var c={};function d(k,g,i,f){if(!b[i]){b[i]=new a(i)}this.backend=b[i];this._attachmentId=k;this._version=g;var h=JSON.stringify({a:k,v:g,t:i});var j=c[h];if(j){this._promise=j.success?e.when(j.url,j.type):e.Deferred().reject(j.reason)}else{this._promise=this.backend.add(this._attachmentId,this._version);this._promise.then(function(l,m){c[h]={success:true,url:l,type:m}},function(l){if(l!=="cancelled"){c[h]={success:false,reason:l}}},f)}}d.prototype.stop=function(){this.backend.remove(this._attachmentId)};d.prototype.promise=function(){return this._promise};return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/service-helpers.js' */
define("cp/service/service-helpers",["ajs","confluence/api/browser","confluence/api/url","jquery"],function(i,k,a,d){var h=["application/pdf","application/x-pdf"];var c=["image/jpeg","image/jpg","image/gif","image/png","image/bmp"];var j=[window.location.protocol,window.location.host].join("//");var b=j+i.contextPath();var f={};var g=function(r){if(r.id===-1){return{}}var z=r.contentType;var y=r.previewContents.THUMBNAIL;var A=r.previewContents.POSTER;var p=r.previewContents.DOCUMENT;var q=r.previewContents.DOCUMENT_HD;var s=r.previewContents.POSTER_HD;var m=i.DarkFeatures.isEnabled("preview.full.image");var n=function(C){return i.DarkFeatures.isEnabled("document.conversion.direct.download")?C:b+C};var o=null;var w=null;var v=null;var B=null;var l=null;if(y){o=n(y.downloadUrl)}if(A){B=n(A.downloadUrl)}var x=m?h.concat(c):h;if(p&&x.indexOf(z)<0){w=n(p.downloadUrl);z="application/octet-stream"}else{w=b+r.downloadUrl;var t=new k(window.navigator.userAgent);if(z==="application/pdf"&&t.isIE()&&t.version()<=11){var u=a.parse(w);u.queryParams.stream=[true];w=a.format(u)}}if(q){v=n(q.downloadUrl)}if(s){l=n(s.downloadUrl)}return{src:w,src_hd:v,srcDownload:b+r.downloadUrl+"&download=true",type:z,originalContentType:r.contentType,thumbnail:o,poster:B,poster_hd:l,title:r.fileName,name:r.fileName,id:r.id.toString(),ownerId:r.containerId&&r.containerId.toString(),version:r.version,hasReplyPermission:r.hasReplyPermission,hasUploadAttachmentVersionPermission:r.hasUploadAttachmentVersionPermission}};var e=function(m){var l=d.Deferred();if(!f[m]){d.ajax({url:i.contextPath()+"/rest/api/space/"+m,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(n){f[m]=n.id.toString();l.resolve(f[m])}).fail(function(n,p,o){l.reject(n,p,o)})}else{l.resolve(f[m])}return l.promise()};return{responseToFile:g,getSpaceId:e}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/comments-service.js' */
define("cp/service/comments-service",["underscore","ajs","jquery","confluence/legacy-message-queue","cp/service/service-helpers"],function(i,g,e,a,b){function d(k,l){this.url=g.contextPath()+"/rest/files/1.0/files/"+k+"/comments";this.version=l}var f=function(k,l){return function(m){return g.defaultIfUndefined(m,{rootObject:k,defaultValue:l})}};var c=function(k){var m=f(k,"");var n=f(k,undefined);var l=n("history.createdDate")||new Date();return{id:m("id"),author:{name:m("history.createdBy.displayName"),avatar:m("history.createdBy.profilePicture.path"),profile:g.contextPath()+"/display/~"+m("history.createdBy.username")},comment:m("body.view.value"),editorFormat:m("body.editor.value"),date:l,hasDeletePermission:k.hasDeletePermission,hasEditPermission:k.hasEditPermission,hasReplyPermission:k.hasReplyPermission,hasResolvePermission:k.hasResolvePermission}};var h=function(k){var m=f(k,undefined);var l=f(k,false);return i.extend({pageNumber:m("anchor.page"),position:[m("anchor.x"),m("anchor.y")],resolved:l("resolved.value")},c(k))};var j=function(n,l){var m=n.changedAttributes();if(m.hasOwnProperty("resolved")&&l){return{resolved:n.get("resolved")}}var k={parentId:n.get("parentId"),commentBody:n.get("editorFormat")};if(n.get("position")||n.get("pageNumber")){k=i.extend({},k,{anchor:{x:n.get("position")[0],y:n.get("position")[1],page:n.get("pageNumber"),type:"pin"}})}return k};d.prototype._makeUrl=function(k){if(!k){k=""}return this.url+k+(this.version?("?attachmentVersion="+this.version):"")};d.prototype.getAnnotations=function(m){var k=e.Deferred();var l=i.extend({},m);e.ajax({url:this._makeUrl(),type:"GET",data:{limit:l.limit,start:l.start},dataType:"json"}).then(function(n){var o=i.map(n.results,h);k.resolve(o)}).fail(function(n,p,o){k.reject(n,p,o)});return k.promise()};d.prototype.getReplies=function(m){var k=e.Deferred();var l=i.extend({},m);e.ajax({url:this._makeUrl("/"+m.parentId),type:"GET",data:{limit:l.limit,start:l.start},dataType:"json"}).then(function(p){var q=f(p,[]);var n=q("children");var o=i.map(n,c);k.resolve(o)}).fail(function(n,p,o){k.reject(n,p,o)});return k.promise()};d.prototype.save=function(n){var k=e.Deferred();var m=n.get("id")?"PUT":"POST";var l=(m==="PUT")?this._makeUrl("/"+n.get("id")):this._makeUrl();e.ajax({url:l,type:m,data:JSON.stringify(j(n,(m==="PUT"))),dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(o){k.resolve(c(o))}).fail(function(o,q,p){k.reject(o,q,p)});return k.promise()};d.prototype.sendTrackEvent=function(k){var m=k.attributes&&k.attributes.resolved;var l=g.Meta.get("space-key");var n=b.getSpaceId(l);n.done(function(q){if(!m){try{var p={type:"ATLASSIAN_CONFLUENCE_ANALYTICS_NEXT_TRACK",payload:{containerType:"space",containerId:q,source:"previewFileScreen",objectType:"page",objectId:g.Meta.get("content-id"),action:k.previous("comment")?"updated":"created",actionSubject:"comment",actionSubjectId:k.get("id"),attributes:{commentType:"file",pageType:g.Meta.get("draft-type"),parentCommentId:k.previous("parentId")}}};a.push(p)}catch(o){}}})};d.prototype.remove=function(l){var k=e.Deferred();e.ajax({url:this._makeUrl("/"+l.get("id")),type:"DELETE",dataType:"json"}).then(function(){k.resolve()}).fail(function(m,o,n){k.reject(m,o,n)});return k.promise()};return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/versions-service.js' */
define("cp/service/versions-service",["ajs","jquery","underscore","cp/service/service-helpers"],function(a,f,c,g){var b=a.contextPath();var e=function(j,h,i){return f.ajax({url:b+"/rest/files/1.0/files/content/"+j+"/byAttachmentId",type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:{attachmentId:h,attachmentVersion:i}}).pipe(function(k){return g.responseToFile(k)})};function d(){}d.prototype.getAllFileVersions=function(h){var i=b+"/rest/files/1.0/files/"+h+"/versions";return f.ajax(i).pipe(function(k){var j=k.results;return c.sortBy(c.map(j,function(l){return{id:l.id,version:l.version.number,message:l.version.message,countComments:l.countComments,ownerId:l.ownerId}}),function(l){return 0-l.version})})};d.prototype.getFileVersion=function(j,h,i){return e(j,h,i)};return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/files-service.js' */
define("cp/service/files-service",["ajs","jquery","underscore","cp/service/service-helpers"],function(a,e,c,f){var b=a.contextPath();function d(g){this.url=b+"/rest/files/1.0/files/content/"+g}d.prototype.getFiles=function(i){var g=e.Deferred();var h=c.extend({},i);e.ajax({url:this.url,type:"GET",data:{"max-results":h.limit,"start-index":h.start},dataType:"json"}).then(function(k){var j=c.map(k.results,f.responseToFile);g.resolve(j)}).fail(function(j,l,k){g.reject(j,l,k)});return g.promise()};d.prototype.getFilesWithId=function(h){var g=e.Deferred();e.ajax({url:this.url+"/byAttachmentIds",type:"POST",data:JSON.stringify({attachmentIds:h}),dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(j){var i=c.map(j.results,f.responseToFile);g.resolve(i)}).fail(function(i,k,j){g.reject(i,k,j)});return g.promise()};d.prototype.getFileWithId=function(g){return this.getFilesWithId([g]).pipe(function(h){return h[0]})};d.prototype.getFilesWithoutId=function(h){var g=e.Deferred();e.ajax({url:this.url+"/minusAttachmentIds",type:"POST",data:JSON.stringify({attachmentIds:h}),dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(j){var i=c.map(j.results,f.responseToFile);g.resolve(i)}).fail(function(i,k,j){g.reject(i,k,j)});return g.promise()};return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/file-preview-loader.js' */
define("cp/confluence/file-preview-loader",["jquery","underscore","ajs","cp/confluence/preview-support","cp/confluence/async-module-backend","MediaViewer","cp/confluence/conversion-poller","cp/service/files-service","cp/service/comments-service","cp/service/versions-service","cp/confluence/file-utils","confluence/api/event","confluence/api/logger","confluence/jsUri"],function(D,Z,p,W,Y,i,x,d,t,U,N,X,v,P){var K,C={},l,e=false,F=!!p.DarkFeatures.isEnabled("improving.performance.loading.image.previews");var c=window.decodeURIComponent;var H=function(ab,ac){p.trigger("analyticsEvent",{name:ab,data:ac});if(ab==="files.fileviewer-web.file.download"){ac.isProject=!!(p.Meta.get("space-type")==="project"&&D('[data-internal-id="tab-files"]').length);p.trigger("analyticsEvent",{name:"confluence-spaces.previews.download",data:ac})}};var E=i.require("file-types/file-types");function S(ab){return ab.attr("data-image-src")||ab.attr("data-file-src")||ab.attr("src")||ab.attr("href")}function L(ab){return ab.attr("data-linked-resource-content-type")||ab.attr("data-mime-type")||"image/web"}function A(ac){var ab=D(ac);var ad=S(ab);var ae=ab.attr("data-linked-resource-default-alias");return{src:ad,srcDownload:ad+"&download=true",thumbnail:ad,type:L(ab),title:ae||ad,name:ae,id:ab.attr("data-linked-resource-id"),version:ab.attr("data-linked-resource-version"),ownerId:ab.attr("data-linked-resource-container-id"),isRemoteLink:ab.hasClass("confluence-external-resource"),shouldEdit:ab.attr("data-should-edit")==="true",referer:ab.attr("data-file-referer")}}function G(ab){return Z.map(ab,function(ac){return A(ac)})}function aa(ab){if(i.isPluginEnabled("annotation")){if(W.isFallbackModeIframe){W.autoShowAnnotationsOnParent();return}ab.once("fv.showFile",function(){i.getPlugin("annotation").showAnnotationsPanel(ab)})}}function O(ac){var ad=null;if(ac){var ab=D(ac);ad={id:ab.attr("data-linked-resource-id"),ownerId:ab.attr("data-linked-resource-container-id")}}else{var ae=(new P(window.location.href)).getQueryParamValue("preview");if(ae){ae=c(ae).split("/");ad={ownerId:ae[1],id:ae[2]}}}return ad}function Q(ab,ac){return ab.id===ac.id&&ab.ownerId===ac.ownerId}function g(ab,ac){return !!Z.find(ac,function(ad){return Q(ad,ab)})}function y(ab){J(false);K.__willReopen=true;K.close();K.open(ab);delete K.__willReopen;J(true)}function o(){if(i.isPluginEnabled("permalink")){i.getPlugin("permalink").setRoutingEnabled(true);i.getPlugin("permalink").startRouting()}}function J(ab){if(i.isPluginEnabled("permalink")){i.getPlugin("permalink").setRoutingEnabled(ab)}}function I(ab,ad,ac,af){var ae;if(K&&ab&&e&&l===ac){z(ab,ac,true);ae=D.when()}else{K&&K.isOpen()&&K.close();ae=V(ac);e=true}ae.then(function(){if(!ad){return}var ah=D(ad);var ak=ah.attr("data-linked-resource-id"),ag=ah.attr("data-linked-resource-container-id"),aj=ah.attr("data-image-src")||ah.attr("data-file-src")||ah.attr("src");var ai=(ak&&ag)?{id:ak,ownerId:ag}:{src:aj};K.open(ai,"main");if(af){aa(K)}})}var w={showPreviewerForComment:function(af,ag,ae,ai){var ab=D(af);var ah=ag.find(W.getFileSelectorString());var ad=Z.uniq(ah,function(aj){return aj.src||aj.href});var ac=G(ad);w.setupPreviewerForComment(ac,ae,false).then(function(){var am=ab.attr("data-linked-resource-id"),aj=ab.attr("data-linked-resource-container-id"),al=ab.attr("data-image-src")||ab.attr("data-file-src")||ab.attr("src");var ak=(am&&aj)?{id:am,ownerId:aj}:{src:al};K.open(ak,"comments");if(ai){aa(K)}})},setupPreviewerForComment:function(ab,ac,ae){r(ab,ac);var ad=s(ab,false);z(ab,ac,ae);ad.then(function(af){K.updateFiles(af,N.matchId)});return ad}};function s(ac,ae){var ad=D.when();var ab=p.Meta.get("page-id");if(ab){ad=M(ac||[],ab,ae)}return ad}function a(ad,ac,ah){var af=D(ad),ai=af.data("linked-resource-container-id"),ag=af.data("linked-resource-id"),ab=new d(ai),ae=A(ad);ab.getFileWithId(ag).then(function(aj){j();T([Z.extend({},ae,aj)],ac,ah)},function(aj){v.log("Error loading previewer for attachment with Id "+ag+aj)})}function T(ae,ad,ah){var ac=u(ae,ad);var ag=ac.getFiles();if(ag.length){if(ag.length>1){var ab=O(ae);ag=Z.filter(ag,function(ai){return ai.id===ab.id&&ai.ownerId===ab.ownerId});ac.updateFiles(ag,N.matchId)}ac.open({id:ag[0].id,ownerId:ag[0].ownerId},ah)}else{var af=s([],true);af.then(function(aj){ac.updateFiles(aj,N.matchId);var am=ac.getFiles();var ai=O();var al=!ai?[]:am.filter(function(an){return an.id===ai.id});var ak={id:al.length?al[0].id:am[0].id};ac.open(ak,ah);o()})}}function u(ac,ab){var ad=Z.isArray(ac)?ac:G(D(ac));z(ad,ab,false);return K}var n;var h=function(ac){var ae=D.Deferred();var ad={};var ab={src_hd:null,poster_hd:null};if(ac.get("src_hd")){D.ajax({type:"HEAD",async:true,url:ac.get("src_hd")}).then(function(af,ah,ag){ae.resolve(ag.status!==200?ab:ad)},function(af,ah,ag){ae.resolve(ab)})}else{ae.resolve(ad)}return ae.promise()};var B=function(ad){n&&n.stop();var ae=ad.get("id");var ac=ad.get("version");var ab=D.Deferred();if(!ae){return D.when(true,ad.get("src"),ad.get("type"))}n=new x(ae,ac,"conversion",function(af){if(af==="converting"||af==="busy"){ab.resolve(false,ad.get("src"),ad.get("type"))}});n.promise().then(function(ag,af){if(ab.state()!=="pending"){return}h(ad).done(function(ah){ab.resolve(true,ad.get("src"),af,ah)}).fail(function(){ab.resolve(true,ad.get("src"),af)})}).fail(function(af){if(ab.state()!=="pending"){return}if(af==="cancelled"){ab.reject(af)}else{h(ad).done(function(ag){ab.resolve(true,ad.get("src"),ad.get("type"),ag)}).fail(function(){ab.resolve(true,ad.get("src"),ad.get("type"))})}});return ab.promise()};var b=function(ad){n&&n.stop();var ae=ad.get("id");var ac=ad.get("version");var ab=D.Deferred();if(!ae){return D.when(true,ad.get("src"),ad.get("type"))}var af=ad.get("originalContentType");if(af&&/^image\//i.test(af)){ab.resolve(true,ad.get("src"),af)}else{n=new x(ae,ac,"conversion",function(ag){if(ag==="converting"||ag==="busy"){ab.resolve(false,ad.get("src"),ad.get("type"))}});n.promise().then(function(ah,ag){if(ab.state()!=="pending"){return}h(ad).done(function(ai){ab.resolve(true,ad.get("src"),ag,ai)}).fail(function(){ab.resolve(true,ad.get("src"),ag)})}).fail(function(ag){if(ab.state()!=="pending"){return}if(ag==="cancelled"){ab.reject(ag)}else{h(ad).done(function(ah){ab.resolve(true,ad.get("src"),ad.get("type"),ah)}).fail(function(){ab.resolve(true,ad.get("src"),ad.get("type"))})}})}return ab.promise()};var R=function(ad){n&&n.stop();var ae=ad.get("id");var ac=ad.get("version");var ab=D.Deferred();n=new x(ae,ac,"conversion");n.promise().done(function(ag,af){ab.resolve(ad.get("src"),af)}).fail(function(af){if(af!=="cancelled"){ab.resolve(ad.get("src"),ad.get("type"))}else{ab.reject(af)}});return ab.promise()};var k=function(ae){var ah=ae.get("type"),ac=ae.get("src"),ad=ae.get("id"),ai=ae.get("isRemoteLink"),ak=D.Deferred();var ag=p.DarkFeatures.isEnabled("previews.dcl-image-thumbnails");if((!ag&&!ai&&E.isImageBrowserSupported(ah))){var ab=ac.replace("/attachments/","/thumbnails/");ak.resolve(ab,"image/jpeg")}else{if(ad){var af=ae.get("version");var aj=new x(ad,af,"thumbnail");aj.promise().done(function(am,al){ak.resolve(am,al)}).fail(function(){ak.reject()})}else{ak.resolve(ac,ah)}}return ak.promise()};function r(ae,ac){l=ac;if(C[l]){K=C[l];return K}var ad=p.Meta.get("static-resource-url-prefix");var ab="com.atlassian.confluence.plugins.confluence-previews:mediaviewer-chunks";var af=ad+"/download/resources/"+ab+"/";var ah={appendTo:D("body"),files:ae,filesService:d,commentService:t,versionsService:U,enableAnnotations:p.DarkFeatures.isEnabled("file-annotations"),enablePermalinks:p.DarkFeatures.isEnabled("previews.sharing")&&ac==="full"&&!W.isFallbackModeIframe,enableMiniMode:true,enableShareButton:true,enableVersionNavigation:true,viewers:["image","document","video"],analyticsBackend:H,assets:{basePath:af},i18n:p.I18n.keys,fetchToken:m};if(ac===W.VIEW_MODE.SIMPLE){ah.enableAnnotations=false;ah.enableMiniMode=false;ah.enableShareButton=false;ah.enableVersionNavigation=false}if(p.DarkFeatures.isEnabled("previews.conversion-service")){ah.isPreviewGenerated=F?b:B;ah.generatePreview=R;ah.generateThumbnail=k}if(W.isFallbackModeIframe){i.prototype.open=function(ai,aj){this._isOpen=true;W.sendPreviewerToParent(this.getFiles(),ac,ai,aj)}}K=new i(ah);C[l]=K;K.on("fv.showFile",function(){X.trigger("confluence-previews.fileviewer.completed")});var ag=K.getView();ag.show=Z.compose(ag.show,function(ai){p.trigger("remove-bindings.keyboardshortcuts");return ai});ag.hide=Z.compose(ag.hide,function(ai){p.trigger("add-bindings.keyboardshortcuts");return ai});return K}function f(ad,ac){var ab=r(ad,ac);o();return ab}function q(ah,ae,ag,al){ag=ag||"full";var ak=O();var aj=ah||ak;var ad=function(am,an){if(am){o();K.open(aj)}else{if(an){y(an)}}};if(!ah&&!ak){K&&K.close();return K}r(ae,ag);if(ae&&ae.length){K.updateFiles(ae,N.matchId)}var af=K.getCurrent();var ai=af&&af.id===aj.id&&af.ownerId===aj.ownerId;var ac=g(ah||ak,K.getFiles());if(ai){return}if(!ac){var ab=!p.Meta.get("question-id");s(null,ab).then(function(am){if(!am||!am.length){return}K.updateFiles(am,N.matchId);ad(ah,ak)})}else{ad(ah,ak)}if(al){aa(K)}o();return K}function z(ad,ab,ac){if(!K||l!==ab){K&&K.close();r(ad,ab)}K.updateFiles(N.deDupeFiles(ad),N.matchId);J(ac)}function V(ae){var ad=Z.uniq(D(W.getFileSelectorString()),function(ah){return D(ah).attr("data-linked-resource-id")||ah.src});var ac=G(ad);var ag=p.Meta.get("user-timezone-offset");if(!ag){p.Meta.set("user-timezone-offset",0)}var af;var ab=p.Meta.get("page-id");if(ab){af=M(ac,ab,true)}else{af=D.when()}return af.then(function(ah){z(ah,ae,true);if(i.isPluginEnabled("permalink")){i.getPlugin("permalink").startRouting()}})}function m(ab){return D.when(ab.attributes)}function M(ad,ac,ah){var af=Z.filter(ad,function(aj){return !!aj.id}),ag=Z.pluck(af,"id"),ai=ac,ab=new d(ai);var ae=[];if(ag.length){ae.push(ab.getFilesWithId(ag));if(!F&&ah){ae.push(ab.getFilesWithoutId(ag))}}else{ae.push(ab.getFiles())}return D.when.apply(D,ae).pipe(function(){var al=Z.reduce(arguments,function(ao,an){return ao.concat(an)});var am=p.DarkFeatures.isEnabled("previews.trigger-all-file-types");var ak=p.DarkFeatures.isEnabled("previews.conversion-service");var aj=al;if(!am&&!ak){aj=Z.filter(al,function(an){return E.isImage(an.type)||(E.isPDF(an.type)&&W.isPDFSupported())})}return N.mergeFiles(ad,aj)})}function j(){if(K){console.info("File Preview: reset files list");K._files.reset()}}return{showPreviewer:I,showPreviewerForSingleFile:T,setupPreviewForSingleFile:u,showPreviewerForComment:w.showPreviewerForComment,setupPreviewerForFallbackMode:f,setupPreviewerForSPA:q,autoShowAnnotationsPanel:aa,resetPreviewFileList:j,fetchAndShowPreviewerForSingleFile:a}});
}catch(e){WRMCB(e)};