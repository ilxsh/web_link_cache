<!DOCTYPE html>
<!-- saved from url=(0050)https://www.cnblogs.com/liujinggang/p/9651170.html -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="origin">
    <meta property="og:description" content="一、 软件平台与硬件平台 一、 软件平台与硬件平台 软件平台： 1、操作系统：Windows-8.1 2、开发套件：ISE14.7 3、仿真工具：ModelSim-10.4-SE 4、Matlab版本">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园</title>
    
    <link rel="stylesheet" href="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/blog-common.min.css">
    <link id="MainCss" rel="stylesheet" href="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/bundle-darkgreentrip.min.css">
    
    <link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/bundle-darkgreentrip-mobile.min.css">
    
    <link type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/liujinggang/rss">
    <link type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/liujinggang/rsd.xml">
    <link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/liujinggang/wlwmanifest.xml">
    <script src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/amp4ads-host-v0.js.download"></script><script src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/pubads_impl_rendering_2019082901.js.download"></script><script async="" src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/analytics.js.download"></script><script type="text/javascript" src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/encoder.js.download"></script><script src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/jquery-2.2.0.min.js.download"></script>
    <script src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/blog-common.min.js.download"></script>
    <script>
        var currentBlogId = 442032;
        var currentBlogApp = 'liujinggang';
        var cb_enable_mathjax = false;
        var isLogined = false;
    </script>
    
    
    
<link rel="preload" href="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/f.txt" as="script"><script type="text/javascript" src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/f.txt"></script><script src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/pubads_impl_2019082901.js.download" async=""></script><link rel="prefetch" href="https://tpc.googlesyndication.com/safeframe/1-0-35/html/container.html"></head>
<body>
    <a name="top"></a>
    
    
<!--done-->
<div id="home">
<div id="header">
	<div id="blogTitle">
        <a id="lnkBlogLogo" href="https://www.cnblogs.com/liujinggang/"><img id="blogLogo" src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/logo.gif" alt="返回主页"></a>		
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle HeaderMainTitle" href="https://www.cnblogs.com/liujinggang/">jgliu</a>
</h1>
<h2>

</h2>




		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li><a id="blog_nav_sitehome" class="menu" href="https://www.cnblogs.com/">
博客园</a>
</li>
<li>
<a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/liujinggang/">
首页</a>
</li>
<li>

<a id="blog_nav_newpost" class="menu" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">
新随笔</a>
</li>
<li>
<a id="blog_nav_contact" class="menu" href="https://msg.cnblogs.com/send/jgliu">
联系</a></li>
<li>
<a id="blog_nav_rss" class="menu" href="https://www.cnblogs.com/liujinggang/rss/">
订阅</a>
<!--<partial name="./Shared/_XmlLink.cshtml" model="Model" /></li>--></li>
<li>
<a id="blog_nav_admin" class="menu" href="https://i.cnblogs.com/">
管理</a>
</li>
</ul>


		<div class="blogStats">
			
			<span id="stats_post_count">随笔 - 
19&nbsp; </span>
<span id="stats_article_count">文章 - 
0&nbsp; </span>
<span id="stats-comment_count">评论 - 
20</span>

			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->

<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		<div id="post_detail">
    <!--done-->
    <div id="topics">
        <div class="post">
            <h1 class="postTitle">
                
<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/liujinggang/p/9651170.html">【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                
<div id="cnblogs_post_body" class="blogpost-body ">
    <div>
<p class="PublishStatus"><span style="font-size: 18pt;">一、 软件平台与硬件平台</span></p>
</div>
<p>　　软件平台：</p>
<p>　　　　1、操作系统：Windows-8.1</p>
<p>　　　　2、开发套件：ISE14.7</p>
<p>　　　　3、仿真工具：ModelSim-10.4-SE</p>
<p>　　　　4、Matlab版本：Matlab2014b/Matlab2016a</p>
<p>　　硬件平台：</p>
<p>　　　　1、 FPGA型号：Xilinx公司的XC6SLX45-2CSG324</p>
<p>　　　　2、 Flash型号：WinBond公司的W25Q128BV&nbsp;&nbsp; Quad SPI Flash存储器</p>
<p>　　<span style="font-family: &#39;Microsoft YaHei&#39;; font-size: 18pt; color: #ff0000;">提示：如果图片不清晰，请把图片在浏览器的新建标签页打开或保存到本地打开。</span></p>
<p class="A1"><span style="font-size: 18pt;">二、 原理介绍</span></p>
<p>　　上一篇博客《SPI总线的原理与FPGA实现》中已经有关于标准SPI协议的原理与时序的介绍，这里不再赘述。本节主要是讨论QSPI(Quad SPI，四线SPI总线)的相关内容。我的开发板上有一片型号是W25Q128BV的Quad SPI Flash存储器，本文将以它为例子来说明QSPI操作的一些内容。</p>
<p>　　W25Q128BV的Quad SPI Flash存储器的Top View如下图所示</p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915152901227-2019694658.png" alt=""></p>
<p align="center">&nbsp;</p>
<p>　　这块芯片一共有8个有用的管脚，其每个管脚的功能定义如下图所示</p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915152927908-1863935977.png" alt=""></p>
<p align="center">&nbsp;</p>
<p>　　由上图可知2号管脚DO(IO1)，3号管脚 /WP(IO2)，5号管脚DI(IO0)以及7号管脚/HOLD(IO3)均为双向IO口，所以在编写Verilog代码的时候要把它们定义为inout类型，inout类型的信号既可以做输出也可以作为输入，具体在代码里面如何处理后文会有介绍。</p>
<p>　　QSPI Flash每个引脚的详细描述如下：</p>
<p>　　1、Chip Select(/CS)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 　　片选信号Chip Select(/CS)的作用是使能或者不使能设备的操作，当CS为高时，表示设备未被选中，串行数据输出线(DO或IO0，IO1，IO2，IO3)均处于高阻态，当CS为低时，表示设备被选中，FPGA可以给QSPI Flash发送数据或从QSPI Flash接收数据。</p>
<p>　　2、串行数据输入信号DI以及串行输出信号DO</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 　　W25Q128BV支持标准SPI协议，双线SPI(Dual SPI)协议与四线SPI(Quad SPI)协议。标准的SPI协议在串行时钟信号(SCLK)的上升沿把串行输入信号DI上的数据存入QSPI Flash中，在串行时钟信号(SCLK)的下降沿把QSPI Flash中的数据串行化通过单向的DO引脚输出。而在Dual SPI与Quad SPI中，DI与DO均为双向信号(既可以作为输入，也可以作为输出)。</p>
<p>　　3、Write Project(/WP)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 　　写保护信号的作用是防止QSPI Flash的状态寄存器被写入错误的数据，WP信号低电平有效，但是当状态寄存器2的QE位被置1时，WP信号失去写保护功能，它变成Quad SPI的一个双向数据传输信号。</p>
<p>　　4、HOLD(/HOLD)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　 HOLD信号的作用是暂停QSPI Flash的操作。当HOLD信号为低，并且CS也为低时，串行输出信号DO将处于高阻态，串行输入信号DI与串行时钟信号SCLK将被QSPI Flash忽略。当HOLD拉高以后，QSPI Flash的读写操作能继续进行。当多个SPI设备共享同一组SPI总线相同的信号的时候，可以通过HOLD来切换信号的流向。和WP信号一样，当当状态寄存器2的QE位被置1时，HOLD信号失去保持功能，它也变成Quad SPI的一个双向数据传输信号。</p>
<p>　　5、串行时钟线</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　 串行时钟线用来提供串行输入输出操作的时钟。</p>
<p>　　W25Q128BV的内部结构框图如下图所示：</p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915153059258-1627550893.png" alt=""></p>
<p align="center">&nbsp;</p>
<p>　　更多详细的内容请阅读W25Q128BV的芯片手册。由于本文要进行4线SPI的操作，但QSPI Flash默认的操作模式是标准单线SPI模式，所以在每次进行4线SPI操作的时候一定要先把状态寄存器2的QE位(倒数第2位)置1，然后才能进行QSPI操作。</p>
<p>　　最后介绍一下我的开发板上QSPI Flash硬件原理图如下图所示：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915153136548-2035591525.png" alt=""></p>
<p class="A1"><span style="font-size: 18pt;">三、 目标任务</span></p>
<p>　　1、编写标准SPI 协议 Verilog代码来操作QSPI Flash，并用ChipScope抓出各个指令的时序与芯片手册提供的时序进行对比</p>
<p>　　2、在标准SPI协议的基础上增加Quad SPI的功能，并用ChipScope抓出Quad SPI的读写数据的时序</p>
<p>　　3、对比标准SPI与Quad SPI读写W25Q128BV的ChipScope时序，感受二者的效率差距</p>
<p class="A1"><span style="font-size: 18pt;">四、 设计思路与Verilog代码编写</span></p>
<p class="A1"><span style="font-size: 14pt;">4.1、 命令类型的定义</span></p>
<p>　　W25Q128BV一共有35条命令，这里不可能把所有命令的逻辑都写出来，所以截取了一部分常用的命令作为示例来说明QSPI Flash的操作方法。由于命令数目很多，所以在这个部分先对各个命令类型做一个初步定义，下文的代码就是按照这个定义来编写的。</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="95">
<p align="center">命令编号</p>
</td>
<td valign="top" width="165">
<p align="center">命令类型(自定义)</p>
</td>
<td valign="top" width="201">
<p align="center">命令码(芯片手册定义)</p>
</td>
<td valign="top" width="196">
<p align="center">命令功能</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">1</p>
</td>
<td valign="top" width="165">
<p align="center">5’b0XXXX</p>
</td>
<td valign="top" width="201">
<p align="center">8’h00</p>
</td>
<td valign="top" width="196">
<p align="center">无</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">2</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10000</p>
</td>
<td valign="top" width="201">
<p align="center">8’h90</p>
</td>
<td valign="top" width="196">
<p align="center">读设备ID</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">3</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10001</p>
</td>
<td valign="top" width="201">
<p align="center">8’h06</p>
</td>
<td valign="top" width="196">
<p align="center">写使能</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">4</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10010</p>
</td>
<td valign="top" width="201">
<p align="center">8’h20</p>
</td>
<td valign="top" width="196">
<p align="center">扇区擦除</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">5</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10011</p>
</td>
<td valign="top" width="201">
<p align="center">8’h05/8’h35</p>
</td>
<td valign="top" width="196">
<p align="center">读状态寄存器1/2</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">6</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10100</p>
</td>
<td valign="top" width="201">
<p align="center">8’h04</p>
</td>
<td valign="top" width="196">
<p align="center">关闭写使能</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">7</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10101</p>
</td>
<td valign="top" width="201">
<p align="center">8’h02</p>
</td>
<td valign="top" width="196">
<p align="center">写数据操作(单线模式)</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">8</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10110</p>
</td>
<td valign="top" width="201">
<p align="center">8’h01</p>
</td>
<td valign="top" width="196">
<p align="center">写状态寄存器</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">9</p>
</td>
<td valign="top" width="165">
<p align="center">5’b10111</p>
</td>
<td valign="top" width="201">
<p align="center">8’h03</p>
</td>
<td valign="top" width="196">
<p align="center">读数据操作(单线模式)</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">10</p>
</td>
<td valign="top" width="165">
<p align="center">5’b11000</p>
</td>
<td valign="top" width="201">
<p align="center">8’h32</p>
</td>
<td valign="top" width="196">
<p align="center">写数据操作(四线模式)</p>
</td>
</tr>
<tr>
<td valign="top" width="95">
<p align="center">11</p>
</td>
<td valign="top" width="165">
<p align="center">5’b11001</p>
</td>
<td valign="top" width="201">
<p align="center">8’h6b</p>
</td>
<td valign="top" width="196">
<p align="center">读数据操作(四线模式)</p>
</td>
</tr>
</tbody>
</table>
<p style="text-align: left;">　　说明：</p>
<p style="text-align: left;">　　1、命令类型是我自己随便定义的，可以随便修改。命令码是芯片手册上定义好，不能修改，更详细的内容请参考W25Q128芯片手册。</p>
<p style="text-align: left;">　　2、命令类型的最高位是使能位，只有当最高位为1时，命令才有效(在代码里面写的就是只有当最高位为1时才能进入SPI操作的状态机)。</p>
<p style="text-align: left;">　　3、进行四线读写操作之前，一定要把四线读写功能的使能位打开，方法是通过写状态寄存器命令把状态寄存器2的QE位(倒数第二位)置1。</p>
<p class="A1" style="text-align: left;"><span style="font-size: 14pt;">4.2、 如何用Matlab产生存放在ROM中的.coe文件格式的数据</span></p>
<p style="text-align: left;">　　上一节设计了一个把存放在ROM中的数据用SPI总线发出来的例子，ROM里面只存放了10个数据，所以可以直接把这10个数据填写到.coe文件就可以了，由于QSPI Flash的页编程(写数据)指令最大支持256字节的写操作，所以下面的例子的功能是把ROM中存放的256个字节(8-bit)数据先写入QSPI Flash中，然后在读出来。由于数据太多(256个),所以一个一个填写肯定不现实，所以可以利用Matlab来直接产生.coe文件，Matlab的完整代码如下：</p>
<div class="cnblogs_code" style="text-align: left;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre>width=<span style="color: #800080;">8</span>;   <span style="color: #008000;">%</span><span style="color: #000000;"><span style="color: #008000;">rom中数据的宽度</span>
depth</span>=<span style="color: #800080;">256</span>; <span style="color: #008000;">%</span><span style="color: #000000;"><span style="color: #008000;">rom的深度</span>
y</span>=<span style="color: #800080;">0</span>:<span style="color: #800080;">255</span><span style="color: #000000;">;   
y</span>=fliplr(y);<span style="color: #008000;"> %产生要发送的数据，255,254,253，...... ，2,1,0</span><span style="color: #000000;">
fid </span>= fopen(<span style="color: #800000;">'</span><span style="color: #800000;">test_data.coe</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span><span style="color: #800000;">w</span><span style="color: #800000;">'</span>); <span style="color: #008000;">% 打开一个.coe文件
</span>
<span style="color: #008000;">%</span><span style="color: #000000;"><span style="color: #008000;"> 存放在ROM中的.coe文件第一行必须是这个字符串，16表示16进制，可以改成其他进制</span>
fprintf(fid,</span><span style="color: #800000;">'</span><span style="color: #800000;">memory_initialization_radix=16;\n</span><span style="color: #800000;">'</span><span style="color: #000000;">); 

</span><span style="color: #008000;">%</span><span style="color: #000000;"><span style="color: #008000;"> 存放在ROM中的.coe文件第二行必须是这个字符串</span>
fprintf(fid,</span><span style="color: #800000;">'</span><span style="color: #800000;">memory_initialization_vector=\n</span><span style="color: #800000;">'</span><span style="color: #000000;">); 

</span><span style="color: #008000;">%</span><span style="color: #000000;"><span style="color: #008000;"> 把前255个数据写入.coe文件中，并用逗号隔开，为了方便知道数据的个数，每行只写一个数据</span>
fprintf(fid,</span><span style="color: #800000;">'</span><span style="color: #800000;">%x,\n</span><span style="color: #800000;">'</span>,y(<span style="color: #800080;">1</span>:end-<span style="color: #800080;">1</span><span style="color: #000000;">));
 
</span><span style="color: #008000;">%</span><span style="color: #000000;"><span style="color: #008000;"> 把最后一个数据写入.coe文件中，并用分号结尾</span>
fprintf(fid,</span><span style="color: #800000;">'</span><span style="color: #800000;">%x;\n</span><span style="color: #800000;">'</span><span style="color: #000000;">,y(end)); 
fclose(fid);  </span><span style="color: #008000;">% 关闭文件指针</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p style="text-align: left;">　　用Matlab2014b运行上面的代码以后会在与这个.m文件相同的目录下产生一个.coe文件，这个.coe文件可以导入到ROM中。</p>
<p class="A1" style="text-align: left;"><span style="font-size: 14pt;">4.3、 标准SPI总线操作QSPI Flash思路与代码编写</span></p>
<p style="text-align: left;">　　上一篇博客《SPI总线的原理与FPGA实现》已经介绍过用spi_module这个模块去读取QSPI Flash的Manufacturer/Device&nbsp; ID，事实上除了上篇博客提供的那种方法以外，还可以直接在时钟信号的下降沿发送数据，时钟信号的上升沿来接受数据来完成读ID的操作，当FPGA在时钟的下降沿发送数据的时候，那么时钟的上升沿刚好在数据的正中间，QSPI Flash刚好可以在这个上升沿把数据读进来，读操作则正好相反。但是有很多有经验的人告诉我在设计中如非必要最好不要使用时钟下降沿触发的设计方法，可能是因为大多数FPGA里面的Flip Flops资源都是上升沿触发的，如果在Verilog代码采用下降沿触发的话 ，综合的时候会在CLK输入信号前面综合出一个反相器，这个反相器可能会对时钟信号的质量有影响，具体的原因等我再Google上继续搜索一段时间在说。这个例子由于状态机相较前几篇博客来说相对复杂，所以接下来写代码我还是采用下降沿发送数据，上升沿接收数据的方式来描述这个状态机。</p>
<p style="text-align: left;">　　接下来的任务就是抽象出一个状态机。上一篇博客仅仅读一个ID就用了6个状态，所以采用上一篇博客的设计思路显然不太现实，但对于初学者而言，上一篇博客仍然有一个基本的指引作用。通过阅读QSPI Flash的芯片手册，可以发现，所有的命令其实至多由以下三个部分组成：</p>
<p style="text-align: left;">　　　　1、发送8-bit的命令码</p>
<p style="text-align: left;">　　　　2、发送24-bit的地址码</p>
<p style="text-align: left;">　　　　3、发送数据或接收数据</p>
<p style="text-align: left;">　　所有命令的状态跳变图可由下图描述</p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20181123085739594-648045779.png" alt=""></p>
<p style="text-align: left;">　　所以按照这个思路来思考的话抽象出来的状态机的状态并不多。单线模式的状态为以下几个：</p>
<p style="text-align: left;">　　　　1、空闲状态：用来初始化各个寄存器的值</p>
<p style="text-align: left;">　　　　2、发送命令状态：用来发送8-bit的命令码</p>
<p style="text-align: left;">　　　　3、发送地址状态：用来发送24-bit的地址码</p>
<p style="text-align: left;">　　　　4、读等待状态：当读数据操作正在进行的时候进入此状态等待读数据完毕</p>
<p style="text-align: left;">　　　　5、写数据状态(单线模式)：在这个状态FPGA往QSPI Flash里面写数据</p>
<p style="text-align: left;">　　　　6、结束状态：一条指令操作结束，并给出一个结束标志</p>
<p style="text-align: left;">　　完整的代码如下：</p>
<p style="text-align: left;">&nbsp;</p>
<div class="cnblogs_code" style="text-align: left;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre>`timescale 1ns /<span style="color: #000000;"> 1ps

</span><span style="color: #0000ff;">module</span><span style="color: #000000;"> qspi_driver
(
</span><span style="color: #0000ff;">output</span>                  O_qspi_clk          , <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线串行时钟线</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>              O_qspi_cs           , <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线片选信号</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>              O_qspi_mosi         , <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线输出信号线，也是QSPI Flash的输入信号线</span>
<span style="color: #0000ff;">input</span>                   I_qspi_miso         , <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线输入信号线，也是QSPI Flash的输出信号线</span>
                                            
<span style="color: #0000ff;">input</span>                   I_rst_n             , <span style="color: #008000;">//</span><span style="color: #008000;"> 复位信号</span>

<span style="color: #0000ff;">input</span>                   I_clk_25M           , <span style="color: #008000;">//</span><span style="color: #008000;"> 25MHz时钟信号</span>
<span style="color: #0000ff;">input</span>       [<span style="color: #800080;">4</span>:<span style="color: #800080;">0</span>]       I_cmd_type          , <span style="color: #008000;">//</span><span style="color: #008000;"> 命令类型</span>
<span style="color: #0000ff;">input</span>       [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]       I_cmd_code          , <span style="color: #008000;">//</span><span style="color: #008000;"> 命令码</span>
<span style="color: #0000ff;">input</span>       [<span style="color: #800080;">23</span>:<span style="color: #800080;">0</span>]      I_qspi_addr         , <span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash地址</span>

<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>              O_done_sig          , <span style="color: #008000;">//</span><span style="color: #008000;"> 指令执行结束标志</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>  [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]       O_read_data         , <span style="color: #008000;">//</span><span style="color: #008000;"> 从QSPI Flash读出的数据</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>              O_read_byte_valid   , <span style="color: #008000;">//</span><span style="color: #008000;"> 读一个字节完成的标志</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>  [<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>]       O_qspi_state          <span style="color: #008000;">//</span><span style="color: #008000;"> 状态机，用于在顶层调试用</span>
<span style="color: #000000;">);


</span><span style="color: #0000ff;">parameter</span>   C_IDLE            =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0000  ; <span style="color: #008000;">// 空闲状态</span></span>
<span style="color: #0000ff;">parameter</span>   C_SEND_CMD        =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0001  ; <span style="color: #008000;">// 发送命令码</span></span>
<span style="color: #0000ff;">parameter</span>   C_SEND_ADDR       =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0010  ; <span style="color: #008000;">// 发送地址码</span></span>
<span style="color: #0000ff;">parameter</span>   C_READ_WAIT       =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0011  ; <span style="color: #008000;">// 读等待</span></span>
<span style="color: #0000ff;">parameter</span>   C_WRITE_DATA      =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0101  ; <span style="color: #008000;">// 写数据</span></span>
<span style="color: #0000ff;">parameter</span>   C_FINISH_DONE     =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0110  ; <span style="color: #008000;">// 一条指令执行结束</span></span>

<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_read_data_reg     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 从Flash中读出的数据用这个变量进行缓存，等读完了在把这个变量的值给输出</span>
<span style="color: #0000ff;">reg</span>                 R_qspi_clk_en       ; <span style="color: #008000;">//</span><span style="color: #008000;"> 串行时钟使能信号</span>
<span style="color: #0000ff;">reg</span>                 R_data_come_single  ; <span style="color: #008000;">//</span><span style="color: #008000;"> 单线操作读数据使能信号，当这个信号为高时</span>
            
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_cmd_reg           ; <span style="color: #008000;">//</span><span style="color: #008000;"> 命令码寄存器</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">23</span>:<span style="color: #800080;">0</span>]  R_address_reg       ; <span style="color: #008000;">//</span><span style="color: #008000;"> 地址码寄存器 </span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_write_bits_cnt    ; <span style="color: #008000;">//</span><span style="color: #008000;"> 写bit计数器，写数据之前把它初始化为7，发送一个bit就减1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">8</span>:<span style="color: #800080;">0</span>]   R_write_bytes_cnt   ; <span style="color: #008000;">//</span><span style="color: #008000;"> 写字节计数器，发送一个字节数据就把它加1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_read_bits_cnt     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 写bit计数器，接收一个bit就加1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">8</span>:<span style="color: #800080;">0</span>]   R_read_bytes_cnt    ; <span style="color: #008000;">//</span><span style="color: #008000;"> 读字节计数器，接收一个字节数据就把它加1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">8</span>:<span style="color: #800080;">0</span>]   R_read_bytes_num    ; <span style="color: #008000;">//</span><span style="color: #008000;"> 要接收的数据总数</span>
<span style="color: #0000ff;">reg</span>                 R_read_finish       ; <span style="color: #008000;">//</span><span style="color: #008000;"> 读数据结束标志位</span>

<span style="color: #0000ff;">wire</span>        [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   W_rom_addr          ;  
</span><span style="color: #0000ff;">wire</span>        [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   W_rom_out           ;  

</span><span style="color: #0000ff;">assign</span> O_qspi_clk = R_qspi_clk_en ? I_clk_25M : <span style="color: #800080;">0</span>   ; <span style="color: #008000;">//</span><span style="color: #008000;"> 产生串行时钟信号</span>
<span style="color: #0000ff;">assign</span> W_rom_addr =<span style="color: #000000;"> R_write_bytes_cnt               ;

</span><span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #008000;">//</span><span style="color: #008000;"> 功能：用时钟的下降沿发送数据</span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">negedge</span><span style="color: #000000;"> I_clk_25M)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n)
        </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
            O_qspi_cs           </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;        </span>
            O_qspi_state        &lt;=<span style="color: #000000;">  C_IDLE ;
            R_cmd_reg           </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_address_reg       </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_qspi_clk_en       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0   ;  <span style="color: #008000;">//SPI clock输出不使能</span></span>
            R_write_bits_cnt    &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_write_bytes_cnt   </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;    
            R_address_reg       </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            O_done_sig          </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0   ;</span>
            R_data_come_single  &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0   ;           </span>
        <span style="color: #0000ff;">end</span>
    <span style="color: #0000ff;">else</span>
        <span style="color: #0000ff;">begin</span>
            <span style="color: #0000ff;">case</span><span style="color: #000000;">(O_qspi_state)
                C_IDLE:  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 初始化各个寄存器，当检测到命令类型有效(命令类型的最高位位1)以后,进入发送命令码状态</span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                              
                        R_qspi_clk_en  </span>&lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;</span>
                        O_qspi_cs      &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1         ;</span>
                        O_qspi_mosi    &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;    </span>
                        R_cmd_reg      &lt;=<span style="color: #000000;">   I_cmd_code   ;
                        R_address_reg  </span>&lt;=<span style="color: #000000;">   I_qspi_addr  ;
                        O_done_sig     </span>&lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;            </span>
                        <span style="color: #0000ff;">if</span>(I_cmd_type[<span style="color: #800080;">4</span>] == <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1) </span>
                            <span style="color: #0000ff;">begin</span>                <span style="color: #008000;">//</span><span style="color: #008000;">如果flash操作命令请求</span>
                                O_qspi_state        &lt;=<span style="color: #000000;">  C_SEND_CMD  ;
                                R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">           ;        
                                R_write_bytes_cnt   </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">           ;
                                R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">           ;                    
                            </span><span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_SEND_CMD: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 发送8-bit命令码状态 </span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        R_qspi_clk_en       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;<span style="color: #008000;"> // 打开SPI串行时钟SCLK的使能开关</span></span>
                        O_qspi_cs           &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;<span style="color: #008000;"> // 拉低片选信号CS</span></span>
                        <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span><span style="color: #000000;">) 
                            </span><span style="color: #0000ff;">begin</span>                           <span style="color: #008000;">//</span><span style="color: #008000;">如果R_cmd_reg还没有发送完</span>
                                O_qspi_mosi        &lt;=  R_cmd_reg[R_write_bits_cnt] ;         <span style="color: #008000;">//</span><span style="color: #008000;">发送bit7~bit1位</span>
                                R_write_bits_cnt   &lt;=  R_write_bits_cnt-<span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1       ;</span>
                            <span style="color: #0000ff;">end</span>                            
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span>                                 <span style="color: #008000;">//</span><span style="color: #008000;">发送bit0</span>
                                O_qspi_mosi &lt;=  R_cmd_reg[<span style="color: #800080;">0</span><span style="color: #000000;">]    ;
                                </span><span style="color: #0000ff;">if</span> ((I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0001) | (I_cmd_type[3:0] == 4</span><span style="color: #800000;">'</span><span style="color: #000000;">b0100)) 
                                    </span><span style="color: #0000ff;">begin</span>    <span style="color: #008000;">//</span><span style="color: #008000;">如果是写使能指令(Write Enable)或者写不使能指令(Write Disable)</span>
                                        O_qspi_state    &lt;=<span style="color: #000000;">  C_FINISH_DONE   ;
                                    </span><span style="color: #0000ff;">end</span>                          
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0011) </span>
                                    <span style="color: #0000ff;">begin</span>    <span style="color: #008000;">//</span><span style="color: #008000;">如果是读状态寄存器指令(Read Register)</span>
                                        O_qspi_state        &lt;=<span style="color: #000000;">  C_READ_WAIT ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">           ;
                                        R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">1</span>           ;<span style="color: #008000;">//</span><span style="color: #008000;">读状态寄存器指令需要接收一个数据 </span>
                                    <span style="color: #0000ff;">end</span>                             
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>( (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0010) || (I_cmd_type[3:0] == 4</span><span style="color: #800000;">'</span>b0101) || (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0111) || (I_cmd_type[3:0] == 4</span><span style="color: #800000;">'</span><span style="color: #000000;">b0000) ) 
                                    </span><span style="color: #0000ff;">begin</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 如果是扇区擦除(Sector Erase),页编程指令(Page Program),读数据指令(Read Data),读设备ID指令(Read Device ID)                          </span>
                                        O_qspi_state        &lt;=<span style="color: #000000;">  C_SEND_ADDR ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">23</span>          ; <span style="color: #008000;">//</span><span style="color: #008000;"> 这几条指令后面都需要跟一个24-bit的地址码</span>
                                    <span style="color: #0000ff;">end</span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_SEND_ADDR: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 发送地址状态</span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span>)  <span style="color: #008000;">//</span><span style="color: #008000;">如果R_cmd_reg还没有发送完</span>
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">                                 
                                O_qspi_mosi        </span>&lt;=  R_address_reg[R_write_bits_cnt] ; <span style="color: #008000;">//</span><span style="color: #008000;">发送bit23~bit1位</span>
                                R_write_bits_cnt   &lt;=  R_write_bits_cnt    -   <span style="color: #800080;">1</span><span style="color: #000000;">       ;    
                            </span><span style="color: #0000ff;">end</span>                                 
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                O_qspi_mosi </span>&lt;=  R_address_reg[<span style="color: #800080;">0</span>]    ;   <span style="color: #008000;">//</span><span style="color: #008000;">发送bit0</span>
                                <span style="color: #0000ff;">if</span>(I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0010) <span style="color: #008000;">// 扇区擦除(Sector Erase)指令</span></span>
                                    <span style="color: #0000ff;">begin</span>  <span style="color: #008000;">//</span><span style="color: #008000;">扇区擦除(Sector Erase)指令发完24-bit地址码就执行结束了，所以直接跳到结束状态</span>
                                        O_qspi_state &lt;=<span style="color: #000000;"> C_FINISH_DONE   ;    
                                    </span><span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0101)<span style="color: #008000;"> // 页编程(Page Program)指令</span></span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                              
                                        O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_WRITE_DATA    ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">               ;                       
                                    </span><span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0000) <span style="color: #008000;">// 读Device ID指令</span></span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">             
                                        O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_READ_WAIT     ;
                                        R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">2</span>               ; <span style="color: #008000;">//</span><span style="color: #008000;">接收2个数据的Device ID</span>
                                    <span style="color: #0000ff;">end</span>                                                         
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0111)<span style="color: #008000;"> // 读数据(Read Data)指令</span></span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                        O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_READ_WAIT     ;
                                        R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">256</span>             ;   <span style="color: #008000;">//</span><span style="color: #008000;">接收256个数据        </span>
                                    <span style="color: #0000ff;">end</span>                                        
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">                  
                C_READ_WAIT: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 读等待状态</span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(R_read_finish)  
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_FINISH_DONE   ;
                                R_data_come_single  </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span>
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                R_data_come_single  </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1            ; <span style="color: #008000;">// 单线模式下读数据标志信号，此信号为高标志正在接收数据</span></span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_WRITE_DATA: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 写数据状态</span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span>(R_write_bytes_cnt &lt; <span style="color: #800080;">256</span>) <span style="color: #008000;">//</span><span style="color: #008000;"> 往QSPI Flash中写入 256个数据</span>
                            <span style="color: #0000ff;">begin</span>                       
                                <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span>) <span style="color: #008000;">//</span><span style="color: #008000;">如果数据还没有发送完</span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                           
                                        O_qspi_mosi         </span>&lt;=  W_rom_out[R_write_bits_cnt] ; <span style="color: #008000;">//</span><span style="color: #008000;">发送bit7~bit1位</span>
                                        R_write_bits_cnt    &lt;=  R_write_bits_cnt  - <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;                        </span>
                                    <span style="color: #0000ff;">end</span>                 
                                <span style="color: #0000ff;">else</span> 
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                                 
                                        O_qspi_mosi         </span>&lt;=  W_rom_out[<span style="color: #800080;">0</span>]                ; <span style="color: #008000;">//</span><span style="color: #008000;">发送bit0</span>
                                        R_write_bits_cnt    &lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">                           ;
                                        R_write_bytes_cnt   </span>&lt;=  R_write_bytes_cnt + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                                    <span style="color: #0000ff;">end</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                O_qspi_state    </span>&lt;=<span style="color: #000000;">  C_FINISH_DONE   ;
                                R_qspi_clk_en   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;</span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_FINISH_DONE:
                    </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        O_qspi_cs           </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                        O_qspi_mosi         &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                        R_qspi_clk_en       &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                        O_done_sig          &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                        R_data_come_single  &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                        O_qspi_state        &lt;=<span style="color: #000000;">  C_IDLE  ;
                    </span><span style="color: #0000ff;">end</span>
                <span style="color: #0000ff;">default</span>:O_qspi_state    &lt;=<span style="color: #000000;">  C_IDLE      ;
            </span><span style="color: #0000ff;">endcase</span>         
        <span style="color: #0000ff;">end</span>
<span style="color: #0000ff;">end</span>

<span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////
</span><span style="color: #008000;">//</span><span style="color: #008000;"> 功能：接收QSPI Flash发送过来的数据    </span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////
</span><span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">posedge</span><span style="color: #000000;"> I_clk_25M)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n)
        </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
            R_read_bytes_cnt    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_bits_cnt     </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_finish       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            O_read_byte_valid   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            R_read_data_reg     &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            O_read_data         </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
        </span><span style="color: #0000ff;">end</span>
    <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(R_data_come_single)   <span style="color: #008000;">//</span><span style="color: #008000;"> 此信号为高表示接收数据从QSPI Flash发过来的数据</span>
        <span style="color: #0000ff;">begin</span>
            <span style="color: #0000ff;">if</span>(R_read_bytes_cnt &lt;<span style="color: #000000;"> R_read_bytes_num) 
                </span><span style="color: #0000ff;">begin</span>            
                    <span style="color: #0000ff;">if</span>(R_read_bits_cnt &lt; <span style="color: #800080;">7</span>)  <span style="color: #008000;">//</span><span style="color: #008000;">接收一个Byte的bit0~bit6    </span>
                        <span style="color: #0000ff;">begin</span><span style="color: #000000;">                         
                            O_read_byte_valid   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0                               ;</span>
                            R_read_data_reg     &lt;=  {R_read_data_reg[<span style="color: #800080;">6</span>:<span style="color: #800080;">0</span><span style="color: #000000;">],I_qspi_miso} ;
                            R_read_bits_cnt     </span>&lt;=  R_read_bits_cnt +   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1           ;</span>
                        <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">else</span>  
                        <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                            O_read_byte_valid   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1                               ; <span style="color: #008000;"> //一个byte数据有效</span></span>
                            O_read_data         &lt;=  {R_read_data_reg[<span style="color: #800080;">6</span>:<span style="color: #800080;">0</span>],I_qspi_miso} ;  <span style="color: #008000;">//</span><span style="color: #008000;">接收bit7</span>
                            R_read_bits_cnt     &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">                                  ;
                            R_read_bytes_cnt    </span>&lt;=  R_read_bytes_cnt    +   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1       ;</span>
                        <span style="color: #0000ff;">end</span>
                <span style="color: #0000ff;">end</span>                               
            <span style="color: #0000ff;">else</span> 
                <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                    R_read_bytes_cnt    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
                    R_read_finish       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                    O_read_byte_valid   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                <span style="color: #0000ff;">end</span>
        <span style="color: #0000ff;">end</span>                               
    <span style="color: #0000ff;">else</span> 
        <span style="color: #0000ff;">begin</span><span style="color: #000000;">
            R_read_bytes_cnt    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_bits_cnt     </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_finish       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            O_read_byte_valid   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            R_read_data_reg     &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
        </span><span style="color: #0000ff;">end</span>
<span style="color: #0000ff;">end</span><span style="color: #000000;">         

rom_data rom_data_inst (
  .clka(I_clk_25M), </span><span style="color: #008000;">//</span><span style="color: #008000;"> input clka</span>
  .addra(W_rom_addr), <span style="color: #008000;">//</span><span style="color: #008000;"> input [7 : 0] addra</span>
  .douta(W_rom_out) <span style="color: #008000;">//</span><span style="color: #008000;"> output [7 : 0] douta</span>
<span style="color: #000000;">);

</span><span style="color: #0000ff;">endmodule</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">　　接下来就是写一个测试代码对这个单线模式SPI驱动，为了保证把上面的所有指令都测试一遍，测试代码如下：</p>
<div class="cnblogs_code" style="text-align: left;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">module</span><span style="color: #000000;"> qspi_top
(
    </span><span style="color: #0000ff;">input</span><span style="color: #000000;">         I_clk         ,
    </span><span style="color: #0000ff;">input</span><span style="color: #000000;">         I_rst_n       ,

    </span><span style="color: #0000ff;">output</span>        O_qspi_clk    , <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线串行时钟线</span>
    <span style="color: #0000ff;">output</span>        O_qspi_cs     , <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线片选信号</span>
    <span style="color: #0000ff;">output</span>        O_qspi_mosi   , <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线输出信号线，也是QSPI Flash的输入信号线</span>
    <span style="color: #0000ff;">input</span>         I_qspi_miso     <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线输入信号线，也是QSPI Flash的输出信号线</span>
<span style="color: #000000;">     
);
     
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   R_state             ;
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   R_flash_cmd         ;
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">23</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]  R_flash_addr        ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_clk_25M           ;
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">4</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   R_cmd_type          ;
                                
</span><span style="color: #0000ff;">wire</span><span style="color: #000000;">        W_done_sig          ;
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]  W_read_data         ;
</span><span style="color: #0000ff;">wire</span><span style="color: #000000;">        W_read_byte_valid   ;
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">2</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]  R_qspi_state        ;


</span><span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//          </span>
<span style="color: #008000;">//</span><span style="color: #008000;">功能：二分频逻辑          </span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//          </span>
<span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">posedge</span> I_clk <span style="color: #0000ff;">or</span> <span style="color: #0000ff;">negedge</span><span style="color: #000000;"> I_rst_n)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n) 
        R_clk_25M   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0        ;</span>
    <span style="color: #0000ff;">else</span><span style="color: #000000;"> 
        R_clk_25M   </span>&lt;=  ~<span style="color: #000000;">R_clk_25M  ;
</span><span style="color: #0000ff;">end</span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//

</span><span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #008000;">//</span><span style="color: #008000;">功能：测试状态机</span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">posedge</span> R_clk_25M <span style="color: #0000ff;">or</span> <span style="color: #0000ff;">negedge</span><span style="color: #000000;"> I_rst_n)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n) 
        </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
            R_state         </span>&lt;=  <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d0        ;</span>
            R_flash_addr    &lt;=  <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0       ;</span>
            R_flash_cmd     &lt;=  <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00       ;</span>
            R_cmd_type      &lt;=  <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000   ;</span>
        <span style="color: #0000ff;">end</span>
     <span style="color: #0000ff;">else</span> 
        <span style="color: #0000ff;">begin</span>
            <span style="color: #0000ff;">case</span><span style="color: #000000;">(R_state)           
                </span><span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d0:<span style="color: #008000;">//读Device ID指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd  </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h90           ; </span>
                                R_flash_addr &lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0           ; </span>
                                R_cmd_type   &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0000       ; </span>
                            <span style="color: #0000ff;">end</span>     
                    <span style="color: #0000ff;">end</span> 
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d1:<span style="color: #008000;">//写Write disable instruction</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h04            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0100        ; </span>
                            <span style="color: #0000ff;">end</span>     
                    <span style="color: #0000ff;">end</span>                
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d2:<span style="color: #008000;">//写使能(Write Enable)指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h06            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0001        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>         
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d3:<span style="color: #008000;">// 扇区擦除(Sector Erase)指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h20            ; </span>
                                R_flash_addr&lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0010        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
            
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d4:<span style="color: #008000;">//读状态寄存器1, 当Busy位(状态寄存器1的最低位)为0时表示擦除操作完成</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span> 
                                <span style="color: #0000ff;">if</span>(W_read_data[<span style="color: #800080;">0</span>]==<span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0) </span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                        R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                                    <span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> 
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                                    <span style="color: #0000ff;">end</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d5:<span style="color: #008000;">//写使能(Write Enable)指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h06            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0001        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>             
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d6: <span style="color: #008000;">//页编程操作(Page Program): 把存放在ROM中的数据写入QSPI Flash中</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h02            ; </span>
                                R_flash_addr&lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0101        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d7:<span style="color: #008000;">//读状态寄存器1, 当Busy位(状态寄存器1的最低位)为0时表示写操作完成</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span> 
                                <span style="color: #0000ff;">if</span>(W_read_data[<span style="color: #800080;">0</span>]==<span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0) </span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                        R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                                    <span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> 
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                                    <span style="color: #0000ff;">end</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>           
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d8:<span style="color: #008000;">//读256 Bytes</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h03            ; </span>
                                R_flash_addr&lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0111        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
            
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d9:<span style="color: #008000;">// 空闲状态</span></span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                        R_state     &lt;= <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d9             ;</span>
                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                    <span style="color: #0000ff;">end</span>
                <span style="color: #0000ff;">default</span> :   R_state     &lt;= <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d0         ;</span>
            <span style="color: #0000ff;">endcase</span>
        <span style="color: #0000ff;">end</span>           
<span style="color: #0000ff;">end</span><span style="color: #000000;"> 
qspi_driver U_qspi_driver
(
.O_qspi_clk          (O_qspi_clk        ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线串行时钟线</span>
.O_qspi_cs           (O_qspi_cs         ), <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线片选信号</span>
.O_qspi_mosi         (O_qspi_mosi       ), <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线输出信号线，也是QSPI Flash的输入信号线</span>
.I_qspi_miso         (I_qspi_miso       ), <span style="color: #008000;">//</span><span style="color: #008000;"> SPI总线输入信号线，也是QSPI Flash的输出信号线</span>
<span style="color: #000000;">                   
.I_rst_n             (I_rst_n           ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> 复位信号</span>
<span style="color: #000000;">
.I_clk_25M           (R_clk_25M         ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> 25MHz时钟信号</span>
.I_cmd_type          (R_cmd_type        ), <span style="color: #008000;">//</span><span style="color: #008000;"> 命令类型</span>
.I_cmd_code          (R_flash_cmd       ), <span style="color: #008000;">//</span><span style="color: #008000;"> 命令码</span>
.I_qspi_addr         (R_flash_addr      ), <span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash地址</span>
<span style="color: #000000;">
.O_done_sig          (W_done_sig        ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> 指令执行结束标志</span>
.O_read_data         (W_read_data       ), <span style="color: #008000;">//</span><span style="color: #008000;"> 从QSPI Flash读出的数据</span>
.O_read_byte_valid   (W_read_byte_valid ), <span style="color: #008000;">//</span><span style="color: #008000;"> 读一个字节完成的标志</span>
.O_qspi_state        (R_qspi_state      )  <span style="color: #008000;">//</span><span style="color: #008000;"> 状态机，用于在顶层调试用</span>
<span style="color: #000000;">);
     
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">35</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]     CONTROL0    ;
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">69</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]     TRIG0       ;
icon icon_inst (
    .CONTROL0(CONTROL0) </span><span style="color: #008000;">//</span><span style="color: #008000;"> INOUT BUS [35:0]</span>
<span style="color: #000000;">);

ila ila_inst (
    .CONTROL(CONTROL0)  , </span><span style="color: #008000;">//</span><span style="color: #008000;"> INOUT BUS [35:0]</span>
    .CLK(I_clk)           ,      <span style="color: #008000;">//</span><span style="color: #008000;"> IN</span>
    .TRIG0(TRIG0)      <span style="color: #008000;">//</span><span style="color: #008000;"> IN BUS [255:0]</span>
<span style="color: #000000;">);                                                     

</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]      =<span style="color: #000000;">   W_read_data         ;                                               
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">8</span>]        =<span style="color: #000000;">   W_read_byte_valid   ;   
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">12</span>:<span style="color: #800080;">9</span>]     =<span style="color: #000000;">   R_state             ;        
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">16</span>:<span style="color: #800080;">13</span>]    =<span style="color: #000000;">   R_qspi_state        ;   
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">17</span>]       =<span style="color: #000000;">   W_done_sig          ;    
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">18</span>]       =<span style="color: #000000;">   I_qspi_miso         ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">19</span>]       =<span style="color: #000000;">   O_qspi_mosi         ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">20</span>]       =<span style="color: #000000;">   O_qspi_cs           ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">21</span>]       =<span style="color: #000000;">   O_qspi_clk          ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">26</span>:<span style="color: #800080;">22</span>]    =<span style="color: #000000;">   R_cmd_type          ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">34</span>:<span style="color: #800080;">27</span>]    =<span style="color: #000000;">   R_flash_cmd         ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">58</span>:<span style="color: #800080;">35</span>]    =<span style="color: #000000;">   R_flash_addr        ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">59</span>]       =<span style="color: #000000;">   I_rst_n             ; 


</span><span style="color: #0000ff;">endmodule</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">　　接下来主要看看用ChipScope抓出来的时序图和芯片手册规定的时序图是否完全一致。</p>
<p style="text-align: left;">　　1、读ID指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册指令的读ID指令时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915153900493-529226718.png" alt=""></p>
<p style="text-align: left;">　　ChipScope抓出来的时序图</p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915153926753-1202639708.png" alt=""></p>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">　　2、写不使能(Write Disable)指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册指令的写不使能时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915153948758-1539983891.png" alt=""></p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ChipScope抓出来的写不使能时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154008514-1233136443.png" alt=""></p>
<p style="text-align: left;">　　3、写使能(Write Enable)指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册指令的写使能时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154034258-940277774.png" alt=""></p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ChipScope抓出来的写使能时序图</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154046993-196365382.png" alt=""></p>
<p style="text-align: left;">　　3、扇区擦除(Sector Erase)指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册的扇区擦除指令时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154109903-225214572.png" alt=""></p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册的扇区擦除指令时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154119518-979765546.png" alt=""></p>
<p style="text-align: left;">　　4、读状态寄存器(Read Status Register)指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册的读状态寄存器指令时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154136668-1924229584.png" alt=""></p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ChipScope抓回来的读状态寄存器指令时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154148968-1907901612.png" alt=""></p>
<p style="text-align: left;">　　由于在擦除操作和写操作(Page Program)操作指令发送完毕以后，芯片内部会自己执行相关的操作并把状态寄存器1中的最低位Busy位拉高，状态寄存器1的各位如下：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154248078-1330622951.png" alt=""></p>
<p style="text-align: left;">　　所以读状态寄存器指令的目的是为了检测Busy是否为高，Busy为高的话说明擦除操作或写操作(Page Program)操作指令并未完成，这种情况应该等待不发送其他指令，等到Busy位拉低以后说明擦除操作或写操作(Page Program)操作指令已经完成，这时才可以执行后续的操作。值得注意的是，在上图中读到8个bit数据(上图读到的数据是0000_0011(8’h03))以后，O_qpsi_cs和O_qspi_clk信号仍然持续了2个周期的时间才变为空闲状态，实际上，回过头去看代码的话很容易解释这种情况，由于代码里面是用时钟的下降沿发送数据，而用时钟的上升沿来接收数据，发送数据与接收数据的状态切换是通过R_data_coming_signal和R_read_finish信号来转换的，所以导致了这种情况的发生。但是读数据相关的指令并不要求完全8-bit对齐，如果在读数据的过程中只要O_qpsi_cs一直为低，那么会一直重复读下去，直至O_qpsi_cs拉高为止才停止读数据，所以上面多出来的两个时钟并不会影响结果的正确性。</p>
<p style="text-align: left;">　　5、写数据(Page Program)指令(单线模式)</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册的写数据指令时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154321638-344267680.png" alt=""></p>
<p style="text-align: left;">　　ChipScope抓回来的时序图</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154343488-256879760.png" alt=""></p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154358068-1908970268.png" alt=""></p>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">　　6、读数据(Read Data)指令(单线模式)</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册的读数据指令时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154430668-272376497.png" alt=""></p>
<p style="text-align: left;">　　ChipScope抓回来的时序图：</p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154457208-1310970211.png" alt=""></p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154512218-167866786.png" alt=""></p>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">　　通过上面用ChipScope抓回来的时序图与芯片手册的时序图进行对比可以很清晰的理解整个QSPI Flash的操作流程与时序细节。</p>
<p class="A1" style="text-align: left;"><span style="font-size: 14pt;">4.4、 如何处理双向信号(Verilog中用关键词inout定义的信号都是双向信号)</span></p>
<p style="text-align: left;">　　四线操作中IO0，IO1，IO2和IO3全部都可以用来发送数据以及接收数据，所以在编写代码的时候要把它们全部定义成双向类型的信号，即inout类型。所以在编写四线操作的代码之前有必要提前熟悉一下inout信号的处理方法。</p>
<p style="text-align: left;">　　总的来说，inout信号大致有以下4个特征：</p>
<p style="text-align: left;">　　　　1、inout端口不能被赋值为reg型，因此，不能用于always语句中。</p>
<p style="text-align: left;">　　　　2、对于inout端口的逻辑判断，要用到？：条件表达式，来控制高阻的赋值</p>
<p style="text-align: left;">　　　　3、inout信号需要有一个中转的寄存器，在always语句中才可以将输入的信号赋给输出(用inout代替纯output)</p>
<p style="text-align: left;">　　　　4、高阻态不要用于芯片内部，应该用逻辑引到引脚处，然后用高阻来实现。</p>
<p style="text-align: left;">　　实际上，FPGA内部的双向信号是通过一个三态门来实现的，一个典型的三态门结构如下</p>
<p style="text-align: center;" align="center"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154703663-946056288.png" alt="">&nbsp;</p>
<p style="text-align: left;">　　描述这个三态门的Verilog代码如下：</p>
<div class="cnblogs_code" style="text-align: left;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">module</span><span style="color: #000000;"> Test_inout
(
</span><span style="color: #0000ff;">input</span><span style="color: #000000;">   I_clk,
</span><span style="color: #0000ff;">input</span><span style="color: #000000;">   I_rst_n,
    .
    .
    .
</span><span style="color: #0000ff;">inout</span><span style="color: #000000;">   IO_data,
    .
    .
    . 
)

</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">     R_data_out  ;
</span><span style="color: #0000ff;">wire</span><span style="color: #000000;">    I_data_in   ;
</span><span style="color: #0000ff;">assign</span>  IO_data = Control ? R_data_out : <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">bz ;</span>
<span style="color: #0000ff;">assign</span>  I_data_in   =<span style="color: #000000;">   IO_data ;

</span><span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">posedge</span> I_clk <span style="color: #0000ff;">or</span> <span style="color: #0000ff;">negedge</span><span style="color: #000000;"> I_rst_n)
</span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
    .
    .
    .
    ;
</span><span style="color: #0000ff;">end</span>

<span style="color: #0000ff;">endmodule</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p style="text-align: left;"><strong>&nbsp;　　</strong>上面的代码表达的意思是：当Control为1是，IO_data信号作为输出，输出R_data_out的值，当Control为0时，IO_data信号作为输入，输入的值赋给I_data_in变量。</p>
<p style="text-align: left;">　　值得注意的是，inout作为输出的时候不能直接给他赋值，而需要通过一个中间变量R_data_out来间接赋值，同时inout变量的输入输出属性必须通过一个控制信号Control来控制，控制性号为高时为inout信号作为输出，输出R_data_out的值，为低时inout处于高阻状态，这时才作为输入接收外部的数据。</p>
<p class="A1" style="text-align: left;"><span style="font-size: 14pt;">4.5、 四线SPI总线操作QSPI Flash思路与代码编写</span></p>
<p style="text-align: left;">　　上一小节已经完成了单线模式QSPI Flash的读写以及其他相关操作，这一节将在上一节的基础上加上四线读写功能。通过进一步阅读W25Q128BV的芯片手册可知，在进行四线读写操作之前一定要把QE(Quad Enable)位置为1，而QE位在状态寄存器2的倒数第二位，见下图</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915154833823-207198662.png" alt=""></p>
<p style="text-align: left;">　　除此以外，四线读操作还需要在读数据之前等待8个dummy clock用来加快读数据的速度(详细内容请阅读芯片手册)。所以，四线操作相对于单线操作而言除了要增加四线模式读写数据的状态以外还要增加一个写状态寄存器的功能用来开启QE(Quad Enable)位以及一个dummy用来等待8个clock。</p>
<p style="text-align: left;">　　综上所述，四线模式的状态为以下几个：</p>
<p style="text-align: left;">　　　　1、空闲状态：用来初始化各个寄存器的值</p>
<p style="text-align: left;">　　　　2、发送命令状态：用来发送8-bit的命令码</p>
<p style="text-align: left;">　　　　3、发送地址状态：用来发送24-bit的地址码</p>
<p style="text-align: left;">　　　　4、读等待状态(单线模式)：当读数据操作正在进行的时候进入此状态等待读数据完毕</p>
<p style="text-align: left;">　　　　5、写数据状态(单线模式)：在这个状态FPGA往QSPI Flash里面写数据</p>
<p style="text-align: left;">　　　　<span style="color: #ff0000;">6、写状态寄存器状态：用来把状态寄存器的QE(Quad Enable)置1</span></p>
<p style="text-align: left;">　　　<span style="color: #ff0000;">　7、Dummy Clock状态：四线读数据之前需要等待8个dummy clock</span></p>
<p style="text-align: left;"><span style="color: #ff0000;">　　　　8、写数据状态(四线模式)：在这个状态FPGA往QSPI Flash里面通过四线模式写数据</span></p>
<p style="text-align: left;"><span style="color: #ff0000;">　　　　9、读等待状态(四线模式)：在这个状态等待FPGA从QSPI Flash里面通过四线模式读数据完成</span></p>
<p style="text-align: left;">　　　　10、结束状态：一条指令操作结束，并给出一个结束标志</p>
<p style="text-align: left;">　　其中标红的状态是四线模式的代码在单线模式代码的基础上增加的四个状态。</p>
<p style="text-align: left;">　　四线模式的完整代码如下所示：</p>
<div class="cnblogs_code" style="text-align: left;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre>`timescale 1ns /<span style="color: #000000;"> 1ps

</span><span style="color: #0000ff;">module</span><span style="color: #000000;"> qspi_driver
(
</span><span style="color: #0000ff;">output</span>                  O_qspi_clk          , <span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash Quad SPI(QPI)总线串行时钟线</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>              O_qspi_cs           , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线片选信号</span>
<span style="color: #0000ff;">inout</span>                   IO_qspi_io0         , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
<span style="color: #0000ff;">inout</span>                   IO_qspi_io1         , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
<span style="color: #0000ff;">inout</span>                   IO_qspi_io2         , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
<span style="color: #0000ff;">inout</span>                   IO_qspi_io3         , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
                                            
<span style="color: #0000ff;">input</span>                   I_rst_n             , <span style="color: #008000;">//</span><span style="color: #008000;"> 复位信号</span>

<span style="color: #0000ff;">input</span>                   I_clk_25M           , <span style="color: #008000;">//</span><span style="color: #008000;"> 25MHz时钟信号</span>
<span style="color: #0000ff;">input</span>       [<span style="color: #800080;">4</span>:<span style="color: #800080;">0</span>]       I_cmd_type          , <span style="color: #008000;">//</span><span style="color: #008000;"> 命令类型</span>
<span style="color: #0000ff;">input</span>       [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]       I_cmd_code          , <span style="color: #008000;">//</span><span style="color: #008000;"> 命令码</span>
<span style="color: #0000ff;">input</span>       [<span style="color: #800080;">23</span>:<span style="color: #800080;">0</span>]      I_qspi_addr         , <span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash地址</span>
<span style="color: #0000ff;">input</span>       [<span style="color: #800080;">15</span>:<span style="color: #800080;">0</span>]      I_status_reg        , <span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash状态寄存器的值</span>

<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>              O_done_sig          , <span style="color: #008000;">//</span><span style="color: #008000;"> 指令执行结束标志</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>  [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]       O_read_data         , <span style="color: #008000;">//</span><span style="color: #008000;"> 从QSPI Flash读出的数据</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>              O_read_byte_valid   , <span style="color: #008000;">//</span><span style="color: #008000;"> 读一个字节完成的标志</span>
<span style="color: #0000ff;">output</span> <span style="color: #0000ff;">reg</span>  [<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>]       O_qspi_state          <span style="color: #008000;">//</span><span style="color: #008000;"> 状态机，用于在顶层调试用</span>
<span style="color: #000000;">);


</span><span style="color: #0000ff;">parameter</span>   C_IDLE            =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0000  ; <span style="color: #008000;">// 空闲状态</span></span>
<span style="color: #0000ff;">parameter</span>   C_SEND_CMD        =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0001  ; <span style="color: #008000;">// 发送命令码</span></span>
<span style="color: #0000ff;">parameter</span>   C_SEND_ADDR       =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0010  ; <span style="color: #008000;">// 发送地址码</span></span>
<span style="color: #0000ff;">parameter</span>   C_READ_WAIT       =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0011  ; <span style="color: #008000;">// 单线模式读等待</span></span>
<span style="color: #0000ff;">parameter</span>   C_WRITE_DATA      =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0101  ; <span style="color: #008000;">// 单线模式写数据到QSPI Flash</span></span>
<span style="color: #0000ff;">parameter</span>   C_FINISH_DONE     =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0110  ; <span style="color: #008000;">// 一条指令执行结束</span></span>

<span style="color: #0000ff;">parameter</span>     C_WRITE_STATE_REG =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0111  ; <span style="color: #008000;">// 写状态寄存器</span></span>
<span style="color: #0000ff;">parameter</span>     C_WRITE_DATA_QUAD =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b1000  ; <span style="color: #008000;">// 四线模式写数据到QSPI Flash</span></span>
<span style="color: #0000ff;">parameter</span>     C_DUMMY           =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b1001  ; <span style="color: #008000;">// 四线模式读数据需要8个时钟周期的dummy clock，这可以加快读数据的速度</span></span>
<span style="color: #0000ff;">parameter</span>     C_READ_WAIT_QUAD  =   <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b1010  ; <span style="color: #008000;">// 四线模式读等待状态</span></span>

<span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash IO输入输出状态控制寄存器</span>
<span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io0          ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io1          ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io2          ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io3          ;          
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io0_out_en   ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io1_out_en   ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io2_out_en   ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_qspi_io3_out_en   ;

</span><span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_read_data_reg     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 从Flash中读出的数据用这个变量进行缓存，等读完了在把这个变量的值给输出</span>
<span style="color: #0000ff;">reg</span>                 R_qspi_clk_en       ; <span style="color: #008000;">//</span><span style="color: #008000;"> 串行时钟使能信号</span>
<span style="color: #0000ff;">reg</span>                 R_data_come_single  ; <span style="color: #008000;">//</span><span style="color: #008000;"> 单线操作读数据使能信号，当这个信号为高时</span>
<span style="color: #0000ff;">reg</span>                 R_data_come_quad      ; <span style="color: #008000;">//</span><span style="color: #008000;"> 单线操作读数据使能信号，当这个信号为高时</span>
            
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_cmd_reg           ; <span style="color: #008000;">//</span><span style="color: #008000;"> 命令码寄存器</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">23</span>:<span style="color: #800080;">0</span>]  R_address_reg       ; <span style="color: #008000;">//</span><span style="color: #008000;"> 地址码寄存器 </span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">15</span>:<span style="color: #800080;">0</span>]  R_status_reg        ; <span style="color: #008000;">//</span><span style="color: #008000;"> 状态寄存器</span>

<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_write_bits_cnt    ; <span style="color: #008000;">//</span><span style="color: #008000;"> 写bit计数器，写数据之前把它初始化为7，发送一个bit就减1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">8</span>:<span style="color: #800080;">0</span>]   R_write_bytes_cnt   ; <span style="color: #008000;">//</span><span style="color: #008000;"> 写字节计数器，发送一个字节数据就把它加1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]   R_read_bits_cnt     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 写bit计数器，接收一个bit就加1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">8</span>:<span style="color: #800080;">0</span>]   R_read_bytes_cnt    ; <span style="color: #008000;">//</span><span style="color: #008000;"> 读字节计数器，接收一个字节数据就把它加1</span>
<span style="color: #0000ff;">reg</span>         [<span style="color: #800080;">8</span>:<span style="color: #800080;">0</span>]   R_read_bytes_num    ; <span style="color: #008000;">//</span><span style="color: #008000;"> 要接收的数据总数</span>
<span style="color: #0000ff;">reg</span>                 R_read_finish       ; <span style="color: #008000;">//</span><span style="color: #008000;"> 读数据结束标志位</span>

<span style="color: #0000ff;">wire</span>        [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   W_rom_addr          ;  
</span><span style="color: #0000ff;">wire</span>        [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   W_rom_out           ;  

</span><span style="color: #0000ff;">assign</span> O_qspi_clk = R_qspi_clk_en ? I_clk_25M : <span style="color: #800080;">0</span>   ; <span style="color: #008000;">//</span><span style="color: #008000;"> 产生串行时钟信号</span>
<span style="color: #0000ff;">assign</span> W_rom_addr =<span style="color: #000000;"> R_write_bytes_cnt               ;

</span><span style="color: #008000;">//</span><span style="color: #008000;"> QSPI IO方向控制</span>
<span style="color: #0000ff;">assign</span> IO_qspi_io0     =   R_qspi_io0_out_en ? R_qspi_io0 : <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">bz ;                </span>
<span style="color: #0000ff;">assign</span> IO_qspi_io1     =   R_qspi_io1_out_en ? R_qspi_io1 : <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">bz ;                </span>
<span style="color: #0000ff;">assign</span> IO_qspi_io2     =   R_qspi_io2_out_en ? R_qspi_io2 : <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">bz ;                </span>
<span style="color: #0000ff;">assign</span> IO_qspi_io3     =   R_qspi_io3_out_en ? R_qspi_io3 : <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">bz ; </span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #008000;">//</span><span style="color: #008000;"> 功能：用时钟的下降沿发送数据</span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">negedge</span><span style="color: #000000;"> I_clk_25M)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n)
        </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
            O_qspi_cs           </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;        </span>
            O_qspi_state        &lt;=<span style="color: #000000;">  C_IDLE ;
            R_cmd_reg           </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_address_reg       </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_qspi_clk_en       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0   ; <span style="color: #008000;"> //QSPI clock输出不使能</span></span>
            R_write_bits_cnt    &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_write_bytes_cnt   </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;    
            R_address_reg       </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">      ;
            O_done_sig          </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0   ;</span>
            R_data_come_single  &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0   ;           </span>
            R_data_come_quad      &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0   ;           </span>
        <span style="color: #0000ff;">end</span>
    <span style="color: #0000ff;">else</span>
        <span style="color: #0000ff;">begin</span>
            <span style="color: #0000ff;">case</span><span style="color: #000000;">(O_qspi_state)
                C_IDLE:  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 初始化各个寄存器，当检测到命令类型有效(命令类型的最高位位1)以后,进入发送命令码状态</span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                              
                        R_qspi_clk_en          </span>&lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;</span>
                        O_qspi_cs              &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1         ;</span>
                        R_qspi_io0             &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;    </span>
                        R_cmd_reg              &lt;=<span style="color: #000000;">   I_cmd_code   ;
                        R_address_reg          </span>&lt;=<span style="color: #000000;">   I_qspi_addr  ;
                        R_status_reg           </span>&lt;=<span style="color: #000000;">   I_status_reg ;
                        O_done_sig             </span>&lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;</span>
                        R_qspi_io3_out_en   &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;<span style="color: #008000;"> // 设置IO_qspi_io3为高阻</span></span>
                        R_qspi_io2_out_en   &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;<span style="color: #008000;"> // 设置IO_qspi_io2为高阻</span></span>
                        R_qspi_io1_out_en   &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ; <span style="color: #008000;">// 设置IO_qspi_io1为高阻</span></span>
                        R_qspi_io0_out_en   &lt;=   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0         ;<span style="color: #008000;"> // 设置IO_qspi_io0为高阻</span></span>
                        <span style="color: #0000ff;">if</span>(I_cmd_type[<span style="color: #800080;">4</span>] == <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1) </span>
                            <span style="color: #0000ff;">begin</span>                <span style="color: #008000;">//</span><span style="color: #008000;">如果flash操作命令请求</span>
                                O_qspi_state        &lt;=<span style="color: #000000;">  C_SEND_CMD  ;
                                R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">           ;        
                                R_write_bytes_cnt   </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">           ;
                                R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">           ;                    
                            </span><span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_SEND_CMD: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 发送8-bit命令码状态 </span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        R_qspi_io0_out_en   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ; <span style="color: #008000;">// 设置IO_qspi_io0为输出</span></span>
                        R_qspi_clk_en       &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ; <span style="color: #008000;">// 打开SPI串行时钟SCLK的使能开关</span></span>
                        O_qspi_cs           &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ; <span style="color: #008000;">// 拉低片选信号CS</span></span>
                        <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span><span style="color: #000000;">) 
                            </span><span style="color: #0000ff;">begin</span>                           <span style="color: #008000;">//</span><span style="color: #008000;">如果R_cmd_reg还没有发送完</span>
                                R_qspi_io0            &lt;=  R_cmd_reg[R_write_bits_cnt] ;         <span style="color: #008000;">//</span><span style="color: #008000;">发送bit7~bit1位</span>
                                R_write_bits_cnt       &lt;=  R_write_bits_cnt-<span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1       ;</span>
                            <span style="color: #0000ff;">end</span>                            
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span>                                 <span style="color: #008000;">//</span><span style="color: #008000;">发送bit0</span>
                                R_qspi_io0 &lt;=  R_cmd_reg[<span style="color: #800080;">0</span><span style="color: #000000;">]    ;
                                </span><span style="color: #0000ff;">if</span> ((I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0001) | (I_cmd_type[3:0] == 4</span><span style="color: #800000;">'</span><span style="color: #000000;">b0100)) 
                                    </span><span style="color: #0000ff;">begin</span>    <span style="color: #008000;">//</span><span style="color: #008000;">如果是写使能指令(Write Enable)或者写不使能指令(Write Disable)</span>
                                        O_qspi_state    &lt;=<span style="color: #000000;">  C_FINISH_DONE   ;
                                    </span><span style="color: #0000ff;">end</span>                          
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0011) </span>
                                    <span style="color: #0000ff;">begin</span>    <span style="color: #008000;">//</span><span style="color: #008000;">如果是读状态寄存器指令(Read Register)</span>
                                        O_qspi_state        &lt;=<span style="color: #000000;">  C_READ_WAIT ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">           ;
                                        R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">1</span>           ;<span style="color: #008000;">//</span><span style="color: #008000;">读状态寄存器指令需要接收一个数据 </span>
                                    <span style="color: #0000ff;">end</span>                             
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>( (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0010) ||  <span style="color: #008000;">// 如果是扇区擦除(Sector Erase)</span></span>
                                         (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0101) ||  <span style="color: #008000;">// 如果是页编程指令(Page Program)</span></span>
                                         (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0111) || <span style="color: #008000;"> // 如果是读数据指令(Read Data)</span></span>
                                         (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0000) || <span style="color: #008000;"> // 如果是读设备ID指令(Read Device ID)</span></span>
                                         (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b1000) ||  <span style="color: #008000;">// 如果是四线模式页编程指令(Quad Page Program)</span></span>
                                         (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b1001)     <span style="color: #008000;">// 如果是四线模式读数据指令(Quad Read Data)</span></span>
<span style="color: #000000;">                                        ) 
                                    </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">                          
                                        O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_SEND_ADDR ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">23</span>          ; <span style="color: #008000;">//</span><span style="color: #008000;"> 这几条指令后面都需要跟一个24-bit的地址码</span>
                                    <span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0110) </span>
                                    <span style="color: #0000ff;">begin</span>    <span style="color: #008000;">//</span><span style="color: #008000;">如果是Write Status Register</span>
                                        O_qspi_state        &lt;=<span style="color: #000000;">  C_WRITE_STATE_REG   ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">15</span><span style="color: #000000;">                  ;
                                    </span><span style="color: #0000ff;">end</span> 
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_WRITE_STATE_REG   :
                    </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        R_qspi_io0_out_en   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;  <span style="color: #008000;"> // 设置IO0为输出</span></span>
                        <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span><span style="color: #000000;">)  
                            </span><span style="color: #0000ff;">begin</span>                           <span style="color: #008000;">//</span><span style="color: #008000;">如果R_cmd_reg还没有发送完</span>
                                R_qspi_io0         &lt;=  R_status_reg[R_write_bits_cnt] ;   <span style="color: #008000;">//</span><span style="color: #008000;">发送bit15~bit1位</span>
                                R_write_bits_cnt   &lt;=  R_write_bits_cnt    -   <span style="color: #800080;">1</span><span style="color: #000000;">      ;    
                            </span><span style="color: #0000ff;">end</span>                                 
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span>                                        <span style="color: #008000;">//</span><span style="color: #008000;">发送bit0</span>
                                R_qspi_io0      &lt;=  R_status_reg[<span style="color: #800080;">0</span><span style="color: #000000;">]    ;   
                                O_qspi_state    </span>&lt;=<span style="color: #000000;">  C_FINISH_DONE      ;                                          
                            </span><span style="color: #0000ff;">end</span>                            
                    <span style="color: #0000ff;">end</span><span style="color: #000000;"> 
                C_SEND_ADDR: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 发送地址状态</span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        R_qspi_io0_out_en   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                        <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span>)  <span style="color: #008000;">//</span><span style="color: #008000;">如果R_cmd_reg还没有发送完</span>
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">                                 
                                R_qspi_io0            </span>&lt;=  R_address_reg[R_write_bits_cnt] ; <span style="color: #008000;">//</span><span style="color: #008000;">发送bit23~bit1位</span>
                                R_write_bits_cnt       &lt;=  R_write_bits_cnt    -   <span style="color: #800080;">1</span><span style="color: #000000;">       ;    
                            </span><span style="color: #0000ff;">end</span>                                 
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_qspi_io0 </span>&lt;=  R_address_reg[<span style="color: #800080;">0</span>]    ;   <span style="color: #008000;">//</span><span style="color: #008000;">发送bit0</span>
                                <span style="color: #0000ff;">if</span>(I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0010)<span style="color: #008000;"> // 扇区擦除(Sector Erase)指令</span></span>
                                    <span style="color: #0000ff;">begin</span>  <span style="color: #008000;">//</span><span style="color: #008000;">扇区擦除(Sector Erase)指令发完24-bit地址码就执行结束了，所以直接跳到结束状态</span>
                                        O_qspi_state &lt;=<span style="color: #000000;"> C_FINISH_DONE   ;    
                                    </span><span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0101)<span style="color: #008000;"> // 页编程(Page Program)指令,页编程指令和写数据指令是一个意思</span></span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                              
                                        O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_WRITE_DATA    ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">               ;                       
                                    </span><span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0000)<span style="color: #008000;"> // 读Device ID指令</span></span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">             
                                        O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_READ_WAIT     ;
                                        R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">2</span>               ; <span style="color: #008000;">//</span><span style="color: #008000;">接收2个数据的Device ID</span>
                                    <span style="color: #0000ff;">end</span>                                                         
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b0111)<span style="color: #008000;"> // 读数据(Read Data)指令</span></span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                        O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_READ_WAIT     ;
                                        R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">256</span>             ;   <span style="color: #008000;">//</span><span style="color: #008000;">接收256个数据        </span>
                                    <span style="color: #0000ff;">end</span> 
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b1000) </span>
                                    <span style="color: #0000ff;">begin</span>   <span style="color: #008000;">//</span><span style="color: #008000;">如果是四线模式页编程指令(Quad Page Program)                               </span>
                                        O_qspi_state        &lt;=<span style="color: #000000;">  C_WRITE_DATA_QUAD   ;
                                        R_write_bits_cnt    </span>&lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">                   ;                       
                                    </span><span style="color: #0000ff;">end</span> 
                                <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (I_cmd_type[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>] == <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">b1001) </span>
                                    <span style="color: #0000ff;">begin</span>   <span style="color: #008000;">//</span><span style="color: #008000;">如果是四线读操作                               </span>
                                        O_qspi_state        &lt;=<span style="color: #000000;">  C_DUMMY         ;
                                        R_read_bytes_num    </span>&lt;=  <span style="color: #800080;">256</span>             ; <span style="color: #008000;">//</span><span style="color: #008000;">接收256个数据    </span>
                                        R_write_bits_cnt    &lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">               ;                      
                                    </span><span style="color: #0000ff;">end</span> 
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;"> 
                C_DUMMY:  </span><span style="color: #008000;">//</span><span style="color: #008000;"> 四线读操作之前需要等待8个dummy clock</span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">  
                        R_qspi_io3_out_en   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ; <span style="color: #008000;">// 设置IO_qspi_io3为高阻</span></span>
                        R_qspi_io2_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ; <span style="color: #008000;">// 设置IO_qspi_io2为高阻</span></span>
                        R_qspi_io1_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;<span style="color: #008000;"> // 设置IO_qspi_io1为高阻</span></span>
                        R_qspi_io0_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;<span style="color: #008000;"> // 设置IO_qspi_io0为高阻 </span>      </span>
                        <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span><span style="color: #000000;">)    
                            R_write_bits_cnt    </span>&lt;=  R_write_bits_cnt - <span style="color: #800080;">1</span><span style="color: #000000;"> ;                                    
                        </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> 
                            O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_READ_WAIT_QUAD     ;                                          
                    </span><span style="color: #0000ff;">end</span><span style="color: #000000;">   
                C_READ_WAIT: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 单线模式读等待状态</span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(R_read_finish)  
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_FINISH_DONE   ;
                                R_data_come_single  </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span>
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                R_data_come_single  </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1            ;<span style="color: #008000;"> // 单线模式下读数据标志信号，此信号为高标志正在接收数据</span></span>
                                R_qspi_io1_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;</span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_READ_WAIT_QUAD: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 四线模式读等待状态</span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(R_read_finish)  
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                O_qspi_state        </span>&lt;=<span style="color: #000000;">  C_FINISH_DONE   ;
                                R_data_come_quad    </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span><span style="color: #000000;">
                            R_data_come_quad        </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1            ;</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_WRITE_DATA: </span><span style="color: #008000;">//</span><span style="color: #008000;"> 写数据状态</span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span>(R_write_bytes_cnt &lt; <span style="color: #800080;">256</span>) <span style="color: #008000;">//</span><span style="color: #008000;"> 往QSPI Flash中写入 256个数据</span>
                            <span style="color: #0000ff;">begin</span>                       
                                <span style="color: #0000ff;">if</span>(R_write_bits_cnt &gt; <span style="color: #800080;">0</span>) <span style="color: #008000;">//</span><span style="color: #008000;">如果数据还没有发送完</span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                           
                                        R_qspi_io0             </span>&lt;=  W_rom_out[R_write_bits_cnt] ; <span style="color: #008000;">//</span><span style="color: #008000;">发送bit7~bit1位</span>
                                        R_write_bits_cnt    &lt;=  R_write_bits_cnt  - <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;                        </span>
                                    <span style="color: #0000ff;">end</span>                 
                                <span style="color: #0000ff;">else</span> 
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">                                 
                                        R_qspi_io0             </span>&lt;=  W_rom_out[<span style="color: #800080;">0</span>]                ; <span style="color: #008000;">//</span><span style="color: #008000;">发送bit0</span>
                                        R_write_bits_cnt    &lt;=  <span style="color: #800080;">7</span><span style="color: #000000;">                           ;
                                        R_write_bytes_cnt   </span>&lt;=  R_write_bytes_cnt + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                                    <span style="color: #0000ff;">end</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                O_qspi_state    </span>&lt;=<span style="color: #000000;">  C_FINISH_DONE   ;
                                R_qspi_clk_en   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0            ;</span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span><span style="color: #000000;">
                C_WRITE_DATA_QUAD    :
                    </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        R_qspi_io0_out_en   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;   <span style="color: #008000;">// 设置IO0为输出</span></span>
                        R_qspi_io1_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;   <span style="color: #008000;">// 设置IO1为输出</span></span>
                        R_qspi_io2_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;  <span style="color: #008000;"> // 设置IO2为输出</span></span>
                        R_qspi_io3_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;   <span style="color: #008000;">// 设置IO3为输出  </span>                        </span>
                        <span style="color: #0000ff;">if</span>(R_write_bytes_cnt == <span style="color: #800080;">9</span><span style="color: #800000;">'</span><span style="color: #800000;">d256)</span>
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                O_qspi_state   </span>&lt;=<span style="color: #000000;">  C_FINISH_DONE    ;    
                                R_qspi_clk_en  </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0             ; </span>
                            <span style="color: #0000ff;">end</span> 
                        <span style="color: #0000ff;">else</span>
                            <span style="color: #0000ff;">begin</span>      
                                <span style="color: #0000ff;">if</span>(R_write_bits_cnt == <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">d3)</span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                        R_write_bytes_cnt   </span>&lt;=  R_write_bytes_cnt + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1         ;</span>
                                        R_write_bits_cnt    &lt;=  <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">d7                             ;</span>
                                        R_qspi_io3          &lt;=  W_rom_out[<span style="color: #800080;">3</span>]                     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit3</span>
                                        R_qspi_io2          &lt;=  W_rom_out[<span style="color: #800080;">2</span>]                     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit2</span>
                                        R_qspi_io1          &lt;=  W_rom_out[<span style="color: #800080;">1</span>]                     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit1</span>
                                        R_qspi_io0          &lt;=  W_rom_out[<span style="color: #800080;">0</span>]                     ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit0</span>
                                    <span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                        R_write_bits_cnt    </span>&lt;=  R_write_bits_cnt - <span style="color: #800080;">4</span><span style="color: #000000;">            ;
                                        R_qspi_io3          </span>&lt;=  W_rom_out[R_write_bits_cnt - <span style="color: #800080;">0</span>] ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit7</span>
                                        R_qspi_io2          &lt;=  W_rom_out[R_write_bits_cnt - <span style="color: #800080;">1</span>] ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit6</span>
                                        R_qspi_io1          &lt;=  W_rom_out[R_write_bits_cnt - <span style="color: #800080;">2</span>] ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit5</span>
                                        R_qspi_io0          &lt;=  W_rom_out[R_write_bits_cnt - <span style="color: #800080;">3</span>] ; <span style="color: #008000;">//</span><span style="color: #008000;"> 分别发送bit4</span>
                                    <span style="color: #0000ff;">end</span> 
                            <span style="color: #0000ff;">end</span>                                            
                    <span style="color: #0000ff;">end</span><span style="color: #000000;"> 
                C_FINISH_DONE:
                    </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        O_qspi_cs           </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                        R_qspi_io0             &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                        R_qspi_clk_en       &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                        O_done_sig          &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                        R_qspi_io3_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ; <span style="color: #008000;">// 设置IO_qspi_io3为高阻</span></span>
                        R_qspi_io2_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;<span style="color: #008000;"> // 设置IO_qspi_io2为高阻</span></span>
                        R_qspi_io1_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;<span style="color: #008000;"> // 设置IO_qspi_io1为高阻</span></span>
                        R_qspi_io0_out_en   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;<span style="color: #008000;"> // 设置IO_qspi_io0为高阻</span></span>
                        R_data_come_single  &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                        R_data_come_quad    &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                        O_qspi_state        &lt;=<span style="color: #000000;">  C_IDLE  ;
                    </span><span style="color: #0000ff;">end</span>
                <span style="color: #0000ff;">default</span>:O_qspi_state    &lt;=<span style="color: #000000;">  C_IDLE      ;
            </span><span style="color: #0000ff;">endcase</span>         
        <span style="color: #0000ff;">end</span>
<span style="color: #0000ff;">end</span>

<span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////
</span><span style="color: #008000;">//</span><span style="color: #008000;"> 功能：接收QSPI Flash发送过来的数据    </span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////////////////
</span><span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">posedge</span><span style="color: #000000;"> I_clk_25M)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n)
        </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
            R_read_bytes_cnt    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_bits_cnt     </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_finish       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            O_read_byte_valid   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            R_read_data_reg     &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            O_read_data         </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
        </span><span style="color: #0000ff;">end</span>
    <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(R_data_come_single)   <span style="color: #008000;">//</span><span style="color: #008000;"> 此信号为高表示接收数据从QSPI Flash发过来的数据</span>
        <span style="color: #0000ff;">begin</span>
            <span style="color: #0000ff;">if</span>(R_read_bytes_cnt &lt;<span style="color: #000000;"> R_read_bytes_num) 
                </span><span style="color: #0000ff;">begin</span>            
                    <span style="color: #0000ff;">if</span>(R_read_bits_cnt &lt; <span style="color: #800080;">7</span>)  <span style="color: #008000;">//</span><span style="color: #008000;">接收一个Byte的bit0~bit6    </span>
                        <span style="color: #0000ff;">begin</span><span style="color: #000000;">                         
                            O_read_byte_valid   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0                               ;</span>
                            R_read_data_reg     &lt;=  {R_read_data_reg[<span style="color: #800080;">6</span>:<span style="color: #800080;">0</span><span style="color: #000000;">],IO_qspi_io1} ;
                            R_read_bits_cnt     </span>&lt;=  R_read_bits_cnt +   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1           ;</span>
                        <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">else</span>  
                        <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                            O_read_byte_valid   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1                               ;  <span style="color: #008000;">//一个byte数据有效</span></span>
                            O_read_data         &lt;=  {R_read_data_reg[<span style="color: #800080;">6</span>:<span style="color: #800080;">0</span>],IO_qspi_io1} ;  <span style="color: #008000;">//</span><span style="color: #008000;">接收bit7</span>
                            R_read_bits_cnt     &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">                                  ;
                            R_read_bytes_cnt    </span>&lt;=  R_read_bytes_cnt    +   <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1       ;</span>
                        <span style="color: #0000ff;">end</span>
                <span style="color: #0000ff;">end</span>                               
            <span style="color: #0000ff;">else</span> 
                <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                    R_read_bytes_cnt    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
                    R_read_finish       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                    O_read_byte_valid   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                <span style="color: #0000ff;">end</span>
        <span style="color: #0000ff;">end</span> 
    <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;">(R_data_come_quad)   
        </span><span style="color: #0000ff;">begin</span>
            <span style="color: #0000ff;">if</span>(R_read_bytes_cnt &lt;<span style="color: #000000;"> R_read_bytes_num) 
                </span><span style="color: #0000ff;">begin</span>  <span style="color: #008000;">//</span><span style="color: #008000;">接收数据              </span>
                    <span style="color: #0000ff;">if</span>(R_read_bits_cnt &lt; <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">d1)</span>
                        <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                            O_read_byte_valid       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0                    ;</span>
                            R_read_data_reg         &lt;=  {R_read_data_reg[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>],IO_qspi_io3,IO_qspi_io2,IO_qspi_io1,IO_qspi_io0};<span style="color: #008000;">//</span><span style="color: #008000;">接收前四位</span>
                            R_read_bits_cnt         &lt;=  R_read_bits_cnt + <span style="color: #800080;">1</span><span style="color: #000000;">     ; 
                        </span><span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">else</span>    
                        <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                            O_read_byte_valid       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1                    ;</span>
                            O_read_data             &lt;=  {R_read_data_reg[<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span>],IO_qspi_io3,IO_qspi_io2,IO_qspi_io1,IO_qspi_io0};  <span style="color: #008000;">//</span><span style="color: #008000;">接收后四位</span>
                            R_read_bits_cnt         &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">                       ;
                            R_read_bytes_cnt        </span>&lt;=  R_read_bytes_cnt + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1 ;     </span>
                        <span style="color: #0000ff;">end</span>
                <span style="color: #0000ff;">end</span>                               
            <span style="color: #0000ff;">else</span> 
                <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                    R_read_bytes_cnt    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
                    R_read_finish       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1    ;</span>
                    O_read_byte_valid   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
                <span style="color: #0000ff;">end</span>
        <span style="color: #0000ff;">end</span>
    <span style="color: #0000ff;">else</span> 
        <span style="color: #0000ff;">begin</span><span style="color: #000000;">
            R_read_bytes_cnt    </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_bits_cnt     </span>&lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
            R_read_finish       </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            O_read_byte_valid   &lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0    ;</span>
            R_read_data_reg     &lt;=  <span style="color: #800080;">0</span><span style="color: #000000;">       ;
        </span><span style="color: #0000ff;">end</span>
<span style="color: #0000ff;">end</span><span style="color: #000000;">         

rom_data rom_data_inst (
  .clka(I_clk_25M), </span><span style="color: #008000;">//</span><span style="color: #008000;"> input clka</span>
  .addra(W_rom_addr), <span style="color: #008000;">//</span><span style="color: #008000;"> input [7 : 0] addra</span>
  .douta(W_rom_out) <span style="color: #008000;">//</span><span style="color: #008000;"> output [7 : 0] douta</span>
<span style="color: #000000;">);

</span><span style="color: #0000ff;">endmodule</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">　　顶层测试状态机的完整代码如下：</p>
<div class="cnblogs_code" style="text-align: left;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #0000ff;">module</span><span style="color: #000000;"> qspi_top
(
    </span><span style="color: #0000ff;">input</span><span style="color: #000000;">         I_clk         ,
    </span><span style="color: #0000ff;">input</span><span style="color: #000000;">         I_rst_n       ,

    </span><span style="color: #0000ff;">output</span>        O_qspi_clk    , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线串行时钟线</span>
    <span style="color: #0000ff;">output</span>        O_qspi_cs     , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线片选信号</span>
    <span style="color: #0000ff;">inout</span>         IO_qspi_io0   , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
    <span style="color: #0000ff;">inout</span>         IO_qspi_io1    , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
    <span style="color: #0000ff;">inout</span>         IO_qspi_io2    , <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
    <span style="color: #0000ff;">inout</span>         IO_qspi_io3      <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线  </span>
<span style="color: #000000;">);
     
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">3</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   R_state             ;
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   R_flash_cmd         ;
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">23</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]  R_flash_addr        ;
</span><span style="color: #0000ff;">reg</span><span style="color: #000000;">         R_clk_25M           ;
</span><span style="color: #0000ff;">reg</span> [<span style="color: #800080;">4</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]   R_cmd_type          ;
</span><span style="color: #0000ff;">reg</span>    [<span style="color: #800080;">15</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]    R_status_reg        ;
                                
</span><span style="color: #0000ff;">wire</span><span style="color: #000000;">        W_done_sig          ;
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]  W_read_data         ;
</span><span style="color: #0000ff;">wire</span><span style="color: #000000;">        W_read_byte_valid   ;
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">2</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]  R_qspi_state        ;


</span><span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//          </span>
<span style="color: #008000;">//</span><span style="color: #008000;">功能：二分频逻辑          </span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//          </span>
<span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">posedge</span> I_clk <span style="color: #0000ff;">or</span> <span style="color: #0000ff;">negedge</span><span style="color: #000000;"> I_rst_n)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n) 
        R_clk_25M   </span>&lt;=  <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0        ;</span>
    <span style="color: #0000ff;">else</span><span style="color: #000000;"> 
        R_clk_25M   </span>&lt;=  ~<span style="color: #000000;">R_clk_25M  ;
</span><span style="color: #0000ff;">end</span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//

</span><span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #008000;">//</span><span style="color: #008000;">功能：测试状态机</span>
<span style="color: #808080;">//////////////////////////////////////////////////////////////////</span><span style="color: #008000;">//</span>
<span style="color: #0000ff;">always</span> @(<span style="color: #0000ff;">posedge</span> R_clk_25M <span style="color: #0000ff;">or</span> <span style="color: #0000ff;">negedge</span><span style="color: #000000;"> I_rst_n)
</span><span style="color: #0000ff;">begin</span>
    <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">I_rst_n) 
        </span><span style="color: #0000ff;">begin</span><span style="color: #000000;">
            R_state         </span>&lt;=  <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d0        ;</span>
            R_flash_addr    &lt;=  <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0       ;</span>
            R_flash_cmd     &lt;=  <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00       ;</span>
            R_cmd_type      &lt;=  <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000   ;</span>
        <span style="color: #0000ff;">end</span>
     <span style="color: #0000ff;">else</span> 
        <span style="color: #0000ff;">begin</span>
            <span style="color: #0000ff;">case</span><span style="color: #000000;">(R_state)           
                </span><span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d0:<span style="color: #008000;">//读Device ID指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd  </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h90           ; </span>
                                R_flash_addr &lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0           ; </span>
                                R_cmd_type   &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0000       ; </span>
                            <span style="color: #0000ff;">end</span>     
                    <span style="color: #0000ff;">end</span> 
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d1:<span style="color: #008000;">//写不使能(Write disable)指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h04            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0100        ; </span>
                            <span style="color: #0000ff;">end</span>     
                    <span style="color: #0000ff;">end</span>                
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d2:<span style="color: #008000;">//写使能(Write Enable)指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h06            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0001        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>         
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d3:<span style="color: #008000;">// 扇区擦除(Sector Erase)指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h20            ; </span>
                                R_flash_addr&lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0010        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
            
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d4:<span style="color: #008000;">//读状态寄存器1, 当Busy位(状态寄存器1的最低位)为0时表示擦除操作完成</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span> 
                                <span style="color: #0000ff;">if</span>(W_read_data[<span style="color: #800080;">0</span>]==<span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0) </span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                        R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                                    <span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> 
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                                    <span style="color: #0000ff;">end</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d5:<span style="color: #008000;">//写状态寄存器2(Write Status Register2)指令，用来把QE(Quad Enable)位置1</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h01            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0110        ; </span>
                                R_status_reg&lt;= <span style="color: #800080;">16</span><span style="color: #800000;">'</span><span style="color: #800000;">h0002            ;</span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span> 
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d6:<span style="color: #008000;">//写使能(Write Enable)指令</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h06            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0001        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>             
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d7: <span style="color: #008000;">//四线模式页编程操作(Quad Page Program): 把存放在ROM中的数据写入QSPI Flash中</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h32            ; </span>
                                R_flash_addr&lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_1000        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d8:<span style="color: #008000;">//读状态寄存器1, 当Busy位(状态寄存器1的最低位)为0时表示写操作完成</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span> 
                                <span style="color: #0000ff;">if</span>(W_read_data[<span style="color: #800080;">0</span>]==<span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b0) </span>
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                        R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                                    <span style="color: #0000ff;">end</span>
                                <span style="color: #0000ff;">else</span> 
                                    <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                                    <span style="color: #0000ff;">end</span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h05        ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_0011    ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>           
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d9:<span style="color: #008000;">//四线模式读256 Bytes数据</span></span>
                    <span style="color: #0000ff;">begin</span>
                        <span style="color: #0000ff;">if</span><span style="color: #000000;">(W_done_sig) 
                            </span><span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                                R_state     &lt;= R_state + <span style="color: #800080;">1</span><span style="color: #800000;">'</span><span style="color: #800000;">b1   ;</span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                            <span style="color: #0000ff;">end</span>
                        <span style="color: #0000ff;">else</span> 
                            <span style="color: #0000ff;">begin</span><span style="color: #000000;"> 
                                R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h6b            ; </span>
                                R_flash_addr&lt;= <span style="color: #800080;">24</span><span style="color: #800000;">'</span><span style="color: #800000;">d0            ; </span>
                                R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b1_1001        ; </span>
                            <span style="color: #0000ff;">end</span>
                    <span style="color: #0000ff;">end</span>
            
                <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d10:<span style="color: #008000;">// 结束状态</span></span>
                    <span style="color: #0000ff;">begin</span><span style="color: #000000;">
                        R_flash_cmd </span>&lt;= <span style="color: #800080;">8</span><span style="color: #800000;">'</span><span style="color: #800000;">h00            ; </span>
                        R_state     &lt;= <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d10            ;</span>
                        R_cmd_type  &lt;= <span style="color: #800080;">5</span><span style="color: #800000;">'</span><span style="color: #800000;">b0_0000        ; </span>
                    <span style="color: #0000ff;">end</span>
                <span style="color: #0000ff;">default</span> :   R_state     &lt;= <span style="color: #800080;">4</span><span style="color: #800000;">'</span><span style="color: #800000;">d0         ;</span>
            <span style="color: #0000ff;">endcase</span>
        <span style="color: #0000ff;">end</span>           
<span style="color: #0000ff;">end</span><span style="color: #000000;"> 
qspi_driver U_qspi_driver
(
.O_qspi_clk          (O_qspi_clk        ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线串行时钟线</span>
.O_qspi_cs           (O_qspi_cs         ), <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线片选信号</span>
.IO_qspi_io0         (IO_qspi_io0       ), <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
.IO_qspi_io1         (IO_qspi_io1       ), <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
.IO_qspi_io2         (IO_qspi_io2       ), <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
.IO_qspi_io3         (IO_qspi_io3       ), <span style="color: #008000;">//</span><span style="color: #008000;"> QPI总线输入/输出信号线</span>
<span style="color: #000000;">                   
.I_rst_n             (I_rst_n           ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> 复位信号</span>
<span style="color: #000000;">
.I_clk_25M           (R_clk_25M         ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> 25MHz时钟信号</span>
.I_cmd_type          (R_cmd_type        ), <span style="color: #008000;">//</span><span style="color: #008000;"> 命令类型</span>
.I_cmd_code          (R_flash_cmd       ), <span style="color: #008000;">//</span><span style="color: #008000;"> 命令码</span>
.I_qspi_addr         (R_flash_addr      ), <span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash地址</span>
.I_status_reg         (R_status_reg        ), <span style="color: #008000;">//</span><span style="color: #008000;"> QSPI Flash状态寄存器</span>
<span style="color: #000000;">
.O_done_sig          (W_done_sig        ), </span><span style="color: #008000;">//</span><span style="color: #008000;"> 指令执行结束标志</span>
.O_read_data         (W_read_data       ), <span style="color: #008000;">//</span><span style="color: #008000;"> 从QSPI Flash读出的数据</span>
.O_read_byte_valid   (W_read_byte_valid ), <span style="color: #008000;">//</span><span style="color: #008000;"> 读一个字节完成的标志</span>
.O_qspi_state        (R_qspi_state      )  <span style="color: #008000;">//</span><span style="color: #008000;"> 状态机，用于在顶层调试用</span>
<span style="color: #000000;">);
     
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">35</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]     CONTROL0    ;
</span><span style="color: #0000ff;">wire</span> [<span style="color: #800080;">99</span>:<span style="color: #800080;">0</span><span style="color: #000000;">]     TRIG0       ;
icon icon_inst (
    .CONTROL0(CONTROL0) </span><span style="color: #008000;">//</span><span style="color: #008000;"> INOUT BUS [35:0]</span>
<span style="color: #000000;">);

ila ila_inst (
    .CONTROL(CONTROL0)  , </span><span style="color: #008000;">//</span><span style="color: #008000;"> INOUT BUS [35:0]</span>
    .CLK(I_clk)           ,      <span style="color: #008000;">//</span><span style="color: #008000;"> IN</span>
    .TRIG0(TRIG0)      <span style="color: #008000;">//</span><span style="color: #008000;"> IN BUS [255:0]</span>
<span style="color: #000000;">);                                                     

</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">7</span>:<span style="color: #800080;">0</span>]      =<span style="color: #000000;">   W_read_data         ;                                               
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">8</span>]        =<span style="color: #000000;">   W_read_byte_valid   ;   
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">12</span>:<span style="color: #800080;">9</span>]     =<span style="color: #000000;">   R_state             ;        
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">16</span>:<span style="color: #800080;">13</span>]    =<span style="color: #000000;">   R_qspi_state        ;   
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">17</span>]       =<span style="color: #000000;">   W_done_sig          ;    
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">18</span>]       =<span style="color: #000000;">   IO_qspi_io0         ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">19</span>]       =<span style="color: #000000;">   IO_qspi_io1         ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">20</span>]       =<span style="color: #000000;">   IO_qspi_io2         ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">21</span>]       =<span style="color: #000000;">   IO_qspi_io3         ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">22</span>]       =<span style="color: #000000;">   O_qspi_cs           ;  
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">23</span>]       =<span style="color: #000000;">   O_qspi_clk          ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">28</span>:<span style="color: #800080;">24</span>]    =<span style="color: #000000;">   R_cmd_type          ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">36</span>:<span style="color: #800080;">29</span>]    =<span style="color: #000000;">   R_flash_cmd         ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">60</span>:<span style="color: #800080;">37</span>]    =<span style="color: #000000;">   R_flash_addr        ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">61</span>]       =<span style="color: #000000;">   I_rst_n             ; 
</span><span style="color: #0000ff;">assign</span>  TRIG0[<span style="color: #800080;">77</span>:<span style="color: #800080;">62</span>]    =<span style="color: #000000;">   R_status_reg        ; 


</span><span style="color: #0000ff;">endmodule</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p style="text-align: left;"><strong>&nbsp;</strong></p>
<p style="text-align: left;">　　接下来就对比一下各个指令的时序图，由于有一部分时序图在单线模式已经对比过了，这里只对比写状态寄存器，四线读操作，四线写操作三个指令的时序图</p>
<p style="text-align: left;">1、写写状态寄存器(Write Status Register)指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册写状态寄存器时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155109823-996673963.png" alt=""></p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ChipScope抓出来的写状态寄存器时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155126558-778135305.png" alt=""></p>
<p style="text-align: left;">　　2、四线写数据(Quad Input Page Program)指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册四线写数据时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155217033-1423108223.png" alt=""></p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ChipScope抓回来的四线写数据时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155242588-1172050356.png" alt=""></p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155300958-654990319.png" alt=""></p>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">3、四线读数据(Quad Read Data)指令</p>
<p style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 芯片手册四线读数据(Fast Read Quad Output)时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155329409-1174109856.png" alt=""></p>
<p style="text-align: left;">ChipScope抓回来的四线读数据(Fast Read Quad Output)时序图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155350818-282114597.png" alt=""></p>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: center;"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155408793-138070872.png" alt=""></p>
<p style="text-align: left;">&nbsp;</p>
<p style="text-align: left;">　　通过对比各个指令与芯片手册的指令，可以发现各个指令的时序与芯片手册完全吻合，至此四线SPI操作QSPI Flash的代码全部测试通过。你可以把ROM里面的数据换成你自己的数据发给QSPI Flash，ROM里面数据则可以通过4.2小节的Matlab自定义产生。</p>
<p class="A1" style="text-align: left;"><span style="font-size: 14pt;">4.6、 四线模式与单线模式读写数据时的性能对比</span></p>
<p style="text-align: left;">　　由于QSPI Flash四线模式中共有四根信号线，它们全部可以用做输入输出来传输数据，所以传输同样大小的数据块时候，四线模式的速度是单线模式的四倍。下面列出我在最初调试QSPI Flash的时候抓出来的两张图，分别是四线模式与单线模式写数据对比图与 四线模式与单线模式读数据对比图</p>
<p style="text-align: left;">　　四线模式与单线模式写数据对比图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155500799-2130984191.png" alt=""></p>
<p style="text-align: left;">　　四线模式与单线模式读数据对比图：</p>
<p style="text-align: center;">&nbsp;<img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/1426240-20180915155523636-1191061247.png" alt=""></p>
<p style="text-align: left;">　　从上面可以很清晰的看出读写同一块数据的时候，四线模式相较于单线模式而言，速度有了4倍的提升。</p>
<p class="A1" style="text-align: left;"><span style="font-size: 18pt;">五、 进一步思考</span></p>
<p class="A1" style="text-align: left;"><span style="font-size: 14pt;">5.1、 用Verilog编写QSPI Flash驱动的意义何在？</span></p>
<p style="text-align: left;">　　事实上，Xilinx的FPGA的已经有专门的引脚用来与QSPI Flash相连，当我们把.bin文件或者.mcs文件通过Jtag固化到QSPI Flash中的时候，ISE软件中的iMPACT会自动把.bin文件或者.mcs文件以SPI协议的格式写入到QSPI Flash中，由于QSPI Flash是一种非易失性存储器，所以断电后，数据并不会丢失，当FPGA断电重启以后，它会自动从QSPI Flash中加载事先固化到QSPI Flash里面的程序到内部的RAM中执行，而不像.bit掉电程序就会丢失。既然FPGA已经支持QSPI Flash的协议，为什么还要写QSPI Flash的驱动呢？原因是在实际的项目中，如果要远程对FPGA的代码进行在线升级的话就必须有一套QSPI Flash的驱动来配合CPU进行升级操作。</p>
<p style="text-align: left;">　　比如，某厂家生产了几千台4G基站，而且已经发货到国外各个国家商用。而后期研发人员调试的时候发现FPGA部分有一个小Bug需要修复或者说需要增加一个新功能，代码写好了以后如果没有在线升级的功能，你只能一个一个去用jtag重新固化程序，这样会耗费大量的人力成本而且极其不方便，而如果有在线升级的功能只需要通过远程登录连接到CPU上发送几条指令就可以完成升级功能，大大提高了工作效率。</p>
<p class="A1" style="text-align: left;"><span style="font-size: 14pt;">5.2、 关于在代码中同时使用时钟的上升沿和下降沿操作时有什么风险</span></p>
<p style="text-align: left;">　　关于这个问题目前还没有找到比较权威的说法，以下两个说法是提的最多的：</p>
<p style="text-align: left;">　　1、FPGA内部的触发器都是上升沿触发的，所以，如果在代码中用下降沿触发的话会在时钟引脚的前面综合出一个反相器，这个反相器可能会对时钟信号的质量有影响</p>
<p style="text-align: left;">　　2、集成电路设计的书中有对晶振的描述，外部晶振产生的时钟信号上升沿的时间几乎是一样的，但是每个周期的下降沿的时间却无法保证完全一致，这与工艺有很大关系，所以采用下降沿触发有可能存在风险。</p>
<p style="text-align: left;">　　希望有这方面经验的网友能提供一些权威的说法。</p>
</div>
<div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block"><div id="BlogPostCategory">
    分类: 
            <a href="https://www.cnblogs.com/liujinggang/category/1296595.html" target="_blank">接口时序</a></div>
<div id="EntryTag">
    标签: 
            <a href="https://www.cnblogs.com/liujinggang/tag/verilog/">verilog</a></div>

    <div id="blog_post_info">
<div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(9651170,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
        <a id="green_channel_follow" onclick="follow(&#39;011f0ff5-f698-443f-eec1-08d5d38bf026&#39;);" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
        <div id="author_profile_detail" class="author_profile_info">
            <a href="https://home.cnblogs.com/u/liujinggang/">jgliu</a><br>
            <a href="https://home.cnblogs.com/u/liujinggang/followees/">关注 - 4</a><br>
            <a href="https://home.cnblogs.com/u/liujinggang/followers/">粉丝 - 108</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow(&#39;011f0ff5-f698-443f-eec1-08d5d38bf026&#39;);return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(9651170,&#39;Digg&#39;)">
        <span class="diggnum" id="digg_count">2</span>
    </div>
    <div class="buryit" onclick="votePost(9651170,&#39;Bury&#39;)">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>

<script type="text/javascript">
    currentDiggType = 0;
</script></div>
    <div class="clear"></div>
    <div id="post_next_prev">

    <a href="https://www.cnblogs.com/liujinggang/p/9609739.html" class="p_n_p_prefix">« </a> 上一篇：    <a href="https://www.cnblogs.com/liujinggang/p/9609739.html" title="发布于 2018-09-08 17:11">【接口时序】4、SPI总线的原理与Verilog实现</a>
    <br>
    <a href="https://www.cnblogs.com/liujinggang/p/9656358.html" class="p_n_p_prefix">» </a> 下一篇：    <a href="https://www.cnblogs.com/liujinggang/p/9656358.html" title="发布于 2018-09-16 15:55">【接口时序】6、IIC总线的原理与Verilog实现</a>

</div>
</div>
            </div>
            <div class="postDesc">posted @ 
<span id="post-date">2018-09-15 15:57</span>&nbsp;<a href="https://www.cnblogs.com/liujinggang/">jgliu</a> 阅读(<span id="post_view_count">10663</span>) 评论(<span id="post_comment_count">0</span>) <a href="https://i.cnblogs.com/EditPosts.aspx?postid=9651170" rel="nofollow"> 编辑</a> <a href="javascript:void(0)" onclick="AddToWz(9651170); return false;">收藏</a>
</div>
        </div>
	    
	    
    </div><!--end: topics 文章、评论容器-->
</div>
<script src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/highlight.min.js.download"></script>
<script>markdown_highlight();</script>
<script>
    var allowComments = true, cb_blogId = 442032, cb_blogApp = 'liujinggang', cb_blogUserGuid = '011f0ff5-f698-443f-eec1-08d5d38bf026';
    var cb_entryId = 9651170, cb_entryCreatedDate = '2018-09-15 15:57', cb_postType = 1; 
    loadViewCount(cb_entryId);
</script><a name="!comments"></a>
<div id="blog-comments-placeholder"></div>
<script>
    var commentManager = new blogCommentManager();
    commentManager.renderComments(0);
</script>

<div id="comment_form" class="commentform">
    <a name="commentform"></a>
    <div id="divCommentShow"></div>
    <div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="https://www.cnblogs.com/liujinggang/p/9651170.html#" onclick="return RefreshPage();">刷新页面</a><a href="https://www.cnblogs.com/liujinggang/p/9651170.html#top">返回顶部</a></div>
    <div id="comment_form_container"><div class="login_tips">
    注册用户登录后才能发表评论，请 
    <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login(&#39;commentform&#39;);">登录</a>
     或 
    <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，
    <a href="https://www.cnblogs.com/">访问</a> 网站首页。
</div></div>
    <div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
    <div id="ad_t2"><a href="http://www.ucancode.com/index.htm" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-工控&#39;)">【推荐】超50万C++/C#源码: 大型实时仿真组态图形源码</a><br><a href="http://clickc.admaster.com.cn/c/a131574,b3595115,c1705,i0,m101,8a1,8b3,h" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-华为云微认证&#39;)">【推荐】零基础轻松玩转华为云产品，获壕礼加返百元大礼</a><br><a href="https://www.ctyun.cn/activity/#/20190919?hmsr=%E5%8D%9A%E5%AE%A2%E5%9B%AD-0916-919%E6%B4%BB%E5%8A%A8&amp;hmpl=&amp;hmcu=&amp;hmkw=&amp;hmci=" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-天翼云&#39;)">【推荐】919 天翼云钜惠，全网低价，云主机9元轻松购</a><br><a href="http://clickc.admaster.com.cn/c/a131575,b3595121,c1705,i0,m101,8a1,8b3,h" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-华为文字&#39;)">【推荐】华为云文字识别资源包重磅上市，1元万次限时抢购</a><br><a href="https://www.cnblogs.com/cmt/p/11505603.html" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-华为云代金券&#39;)">【福利】git pull &amp;&amp; cherry-pick 博客园&amp;华为云百万代金券</a><br></div>
    <div id="opt_under_post"></div>
    <script async="async" src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/gpt.js.download"></script>
    <script>
        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];
    </script>
    <script>
        googletag.cmd.push(function () {
            googletag.defineSlot("/1090369/C1", [300, 250], "div-gpt-ad-1546353474406-0").addService(googletag.pubads());
            googletag.defineSlot("/1090369/C2", [468, 60], "div-gpt-ad-1539008685004-0").addService(googletag.pubads());
            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
    <div id="cnblogs_c1" class="c_ad_block">
        <div id="div-gpt-ad-1546353474406-0" style="height:250px; width:300px;" data-google-query-id="CPzvztCG2uQCFZeBvQod0ooBvQ"><div id="google_ads_iframe_/1090369/C1_0__container__" style="border: 0pt none;"><iframe id="google_ads_iframe_/1090369/C1_0" title="3rd party ad content" name="google_ads_iframe_/1090369/C1_0" width="300" height="250" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" style="border: 0px; vertical-align: bottom;" data-google-container-id="1" data-load-complete="true" src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/saved_resource.html"></iframe></div></div>
    </div>
    <div id="under_post_news"><div class="recomm-block"><b>相关博文：</b><br>·  <a title="【接口时序】4、SPI总线的原理与Verilog实现" href="https://www.cnblogs.com/liujinggang/p/9609739.html" target="_blank" onclick="clickRecomItmem(9609739)">【接口时序】4、SPI总线的原理与Verilog实现</a><br>·  <a title="【接口时序】6、IIC总线的原理与Verilog实现" href="https://www.cnblogs.com/liujinggang/p/9656358.html" target="_blank" onclick="clickRecomItmem(9656358)">【接口时序】6、IIC总线的原理与Verilog实现</a><br>·  <a title="【接口时序】3、UART串口收发的原理与Verilog实现" href="https://www.cnblogs.com/liujinggang/p/9535366.html" target="_blank" onclick="clickRecomItmem(9535366)">【接口时序】3、UART串口收发的原理与Verilog实现</a><br>·  <a title="【接口时序】7、VGA接口原理与Verilog实现" href="https://www.cnblogs.com/liujinggang/p/9690504.html" target="_blank" onclick="clickRecomItmem(9690504)">【接口时序】7、VGA接口原理与Verilog实现</a><br>·  <a title="SPI总线协议及SPI时序图详解" href="https://www.cnblogs.com/adylee/p/5399742.html" target="_blank" onclick="clickRecomItmem(5399742)">SPI总线协议及SPI时序图详解</a><br></div></div>
    <div id="cnblogs_c2" class="c_ad_block">
        <div id="div-gpt-ad-1539008685004-0" style="height:60px; width:468px;" data-google-query-id="CP3vztCG2uQCFZeBvQod0ooBvQ">
            
        <div id="google_ads_iframe_/1090369/C2_0__container__" style="border: 0pt none;"><iframe id="google_ads_iframe_/1090369/C2_0" title="3rd party ad content" name="google_ads_iframe_/1090369/C2_0" width="468" height="60" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" style="border: 0px; vertical-align: bottom;" data-google-container-id="2" data-load-complete="true" src="./【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现 - jgliu - 博客园_files/saved_resource(1).html"></iframe></div></div>
    </div>
    <div id="under_post_kb">
<div class="itnews c_ad_block">
    <b>最新 IT 新闻</b>:
    <br>
 ·              <a href="https://news.cnblogs.com/n/638045/" target="_blank">未来学家预测5年、50年、500年世界变迁</a>
            <br>
 ·              <a href="https://news.cnblogs.com/n/638044/" target="_blank">Adobe实习生的智能景深算法：2D图片3秒变立体，变换视角流畅自然</a>
            <br>
 ·              <a href="https://news.cnblogs.com/n/638043/" target="_blank">腾讯云助力厦门海上世界 打造智慧“未来之城”</a>
            <br>
 ·              <a href="https://news.cnblogs.com/n/638042/" target="_blank">任正非：可一次性出售华为5G技术许可，Mate 30系列没预装谷歌GMS</a>
            <br>
 ·              <a href="https://news.cnblogs.com/n/638041/" target="_blank">RMS 澄清他没有为 Jeffrey Epstein 辩护</a>
            <br>
    » <a href="https://news.cnblogs.com/" title="IT 新闻" target="_blank">更多新闻...</a>
</div></div>
    <div id="HistoryToday" class="c_ad_block"></div>
    <script type="text/javascript">
        fixPostBody();
        setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
        deliverAdT2();
        deliverAdC1();
        deliverAdC2();
        loadNewsAndKb();
        loadBlogSignature();
LoadPostCategoriesTags(cb_blogId, cb_entryId);        LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
        GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
        loadOptUnderPost();
        GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
    </script>
</div>
	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<div id="sidebar_news" class="newsItem"><!--done-->
<h3 class="catListTitle">公告</h3>

<div id="blog-news">
    
    <div id="profile_block">
        昵称：
        <a href="https://home.cnblogs.com/u/liujinggang/">
            jgliu
        </a>
        <br>
        园龄：
        <a href="https://home.cnblogs.com/u/liujinggang/" title="入园时间：2018-06-21">
            1年2个月
        </a>
        <br>
        粉丝：
        <a href="https://home.cnblogs.com/u/liujinggang/followers/">
            107
        </a>
        <br>
        关注：
        <a href="https://home.cnblogs.com/u/liujinggang/followees/">
            4
        </a>
        <div id="p_b_follow">
<a href="javascript:void(0)" onclick="follow(&#39;011f0ff5-f698-443f-eec1-08d5d38bf026&#39;)">+加关注</a></div>
        <script>getFollowStatus('011f0ff5-f698-443f-eec1-08d5d38bf026');</script>
    </div>
</div>

</div>

			<div id="blog-calendar" style="">

<table id="blogCalendar" class="Cal" cellspacing="0" cellpadding="0" title="Calendar" border="0">
    <tbody>
        <tr>
            <td colspan="7">
                <table class="CalTitle" cellspacing="0" border="0">
                    <tbody>
                        <tr>
                            <td class="CalNextPrev">
                                <a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2019/08/16&#39;); return false;">&lt;</a>
                            </td>
                            <td align="center">2019年9月</td>
                            <td align="right" class="CalNextPrev">
                                <a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2019/10/16&#39;); return false;">&gt;</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
        <tr>
                    <th class="CalDayHeader" align="center" abbr="日" scope="col">日</th>
                    <th class="CalDayHeader" align="center" abbr="一" scope="col">一</th>
                    <th class="CalDayHeader" align="center" abbr="二" scope="col">二</th>
                    <th class="CalDayHeader" align="center" abbr="三" scope="col">三</th>
                    <th class="CalDayHeader" align="center" abbr="四" scope="col">四</th>
                    <th class="CalDayHeader" align="center" abbr="五" scope="col">五</th>
                    <th class="CalDayHeader" align="center" abbr="六" scope="col">六</th>
        </tr>
            <tr>
                        <td class="CalWeekendDay" align="center">
                            1
                        </td>
                        <td class="" align="center">
                            2
                        </td>
                        <td class="" align="center">
                            3
                        </td>
                        <td class="" align="center">
                            4
                        </td>
                        <td class="" align="center">
                            5
                        </td>
                        <td class="" align="center">
                            6
                        </td>
                    <td class="CalWeekendDay" align="center">
                        7
                    </td>
            </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            8
                        </td>
                            <td class="" align="center">
                                9
                            </td>
                            <td class="" align="center">
                                10
                            </td>
                            <td class="" align="center">
                                11
                            </td>
                            <td class="" align="center">
                                12
                            </td>
                            <td class="" align="center">
                                13
                            </td>
                        <td class="CalWeekendDay" align="center">
                            14
                        </td>
                </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            15
                        </td>
                            <td class="CalTodayDay" align="center">
                                16
                            </td>
                            <td class="" align="center">
                                17
                            </td>
                            <td class="" align="center">
                                18
                            </td>
                            <td class="" align="center">
                                19
                            </td>
                            <td class="" align="center">
                                20
                            </td>
                        <td class="CalWeekendDay" align="center">
                            21
                        </td>
                </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            22
                        </td>
                            <td class="" align="center">
                                23
                            </td>
                            <td class="" align="center">
                                24
                            </td>
                            <td class="" align="center">
                                25
                            </td>
                            <td class="" align="center">
                                26
                            </td>
                            <td class="" align="center">
                                27
                            </td>
                        <td class="CalWeekendDay" align="center">
                            28
                        </td>
                </tr>
                <tr>
                        <td class="CalWeekendDay" align="center">
                            29
                        </td>
                            <td class="" align="center">
                                30
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                1
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                2
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                3
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                4
                            </td>
                        <td class="CalOtherMonthDay" align="center">
                            5
                        </td>
                </tr>
                <tr>
                        <td class="CalOtherMonthDay" align="center">
                            6
                        </td>
                            <td class="CalOtherMonthDay" align="center">
                                7
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                8
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                9
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                10
                            </td>
                            <td class="CalOtherMonthDay" align="center">
                                11
                            </td>
                        <td class="CalOtherMonthDay" align="center">
                            12
                        </td>
                </tr>
    </tbody>
</table></div><script>loadBlogDefaultCalendar();</script>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn">

<!-- 搜索 -->
<div id="sidebar_search" class="sidebar-block">
    <div id="sidebar_search" class="mySearch">
        <h3 class="catListTitle">搜索</h3>
        <div id="sidebar_search_box">
            <div id="widget_my_zzk" class="div_my_zzk">
                <input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk">
            </div>
            <div id="widget_my_google" class="div_my_zzk">
                <input type="text" name="google_q" id="google_q" onkeydown="return google_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="google_go()" type="button" value="谷歌搜索" class="btn_my_zzk">
            </div>
        </div>
    </div>
</div>

<!-- 常用链接 -->
<div id="sidebar_shortcut" class="sidebar-block">
    <div class="catListLink">
<h3 class="catListTitle">
常用链接
</h3>
<ul>
		<li>

<a href="https://www.cnblogs.com/liujinggang/p/" title="我的博客的随笔列表">我的随笔</a>
</li>
		<li>

<a href="https://www.cnblogs.com/liujinggang/MyComments.html" title="我的发表过的评论列表">我的评论</a>
</li>
		<li>

<a href="https://www.cnblogs.com/liujinggang/OtherPosts.html" title="我评论过的随笔列表">我的参与</a>
</li>
		<li>

<a href="https://www.cnblogs.com/liujinggang/RecentComments.html" title="我的博客的评论列表">最新评论</a>
</li>
		<li>

<a href="https://www.cnblogs.com/liujinggang/tag/" title="我的博客的标签列表">我的标签</a>
</li>

</ul>
<div id="itemListLin_con" style="display:none;">
<ul>

</ul>
</div>
</div>


</div>

<!-- 最新随笔 -->



<!-- 我的标签 -->
<div id="sidebar_toptags" class="sidebar-block">
    <div class="catListTag">
<h3 class="catListTitle">我的标签</h3>
<ul>

        <li>
            <a href="https://www.cnblogs.com/liujinggang/tag/verilog/">verilog</a>(9)
        </li>
        <li>
            <a href="https://www.cnblogs.com/liujinggang/tag/rapidIO/">rapidIO</a>(6)
        </li>
        <li>
            <a href="https://www.cnblogs.com/liujinggang/tag/serdes/">serdes</a>(1)
        </li>
        <li>
            <a href="https://www.cnblogs.com/liujinggang/tag/chipscope/">chipscope</a>(1)
        </li>
        <li>
            <a href="https://www.cnblogs.com/liujinggang/tag/DDR/">DDR</a>(1)
        </li>
        <li>
            <a href="https://www.cnblogs.com/liujinggang/tag/QSPI%20Flash/">QSPI Flash</a>(1)
        </li>

</ul>
</div>


</div>

<!-- 积分与排名 -->


<!-- 随笔分类、随笔档案、文章分类、新闻分类、相册、链接 -->
<div id="sidebar_categories">
    
        <div id="sidebar_postcategory" class="catListPostCategory sidebar-block">
            <h3 class="catListTitle">
                

随笔分类



            </h3>


            <ul>

                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/category/1337215.html" rel="" target="">
    高速接口(6)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/category/1296595.html" rel="" target="">
    接口时序(8)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/category/1318081.html" rel="" target="">
    设计经验(5)
</a>
 

                        </li>

            </ul>


        </div>
        <div id="sidebar_postarchive" class="catListPostArchive sidebar-block">
            <h3 class="catListTitle">
                

随笔档案



            </h3>


            <ul>

                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/archive/2019/03.html" rel="" target="">
    2019年3月(1)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/archive/2018/12.html" rel="" target="">
    2018年12月(4)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/archive/2018/11.html" rel="" target="">
    2018年11月(3)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/archive/2018/10.html" rel="" target="">
    2018年10月(4)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/archive/2018/09.html" rel="" target="">
    2018年9月(4)
</a>
 

                        </li>
                        <li>
                            
<a href="https://www.cnblogs.com/liujinggang/archive/2018/08.html" rel="" target="">
    2018年8月(3)
</a>
 

                        </li>

            </ul>


        </div>

</div>

<!-- 最新评论 -->
<div id="sidebar_recentcomments" class="sidebar-block">
    <div class="catListComment">
<h3 class="catListTitle">最新评论</h3>

	<div class="RecentCommentBlock">
        <ul>
                    <li class="recent_comment_title"><a href="https://www.cnblogs.com/liujinggang/p/9782796.html#4351982">1. Re:【接口时序】8、DDR3驱动原理与FPGA实现（一、DDR的基本原理）</a></li>
                    <li class="recent_comment_body">大佬可以价格电话么 13230363872</li>
                    <li class="recent_comment_author">--靳博宇</li>
                    <li class="recent_comment_title"><a href="https://www.cnblogs.com/liujinggang/p/10072115.html#4343370">2. Re:【高速接口-RapidIO】4、Xilinx RapidIO核详解</a></li>
                    <li class="recent_comment_body">找了好久的资料，突然看到博主写的这个材料，发现眼前一亮，博主这个材料分析的如此详细，为博主点赞</li>
                    <li class="recent_comment_author">--lv_you</li>
                    <li class="recent_comment_title"><a href="https://www.cnblogs.com/liujinggang/p/9609739.html#4341500">3. Re:【接口时序】4、SPI总线的原理与Verilog实现</a></li>
                    <li class="recent_comment_body">讲的非常详细，楼主辛苦了</li>
                    <li class="recent_comment_author">--刘兴强</li>
                    <li class="recent_comment_title"><a href="https://www.cnblogs.com/liujinggang/p/9535366.html#4334678">4. Re:【接口时序】3、UART串口收发的原理与Verilog实现</a></li>
                    <li class="recent_comment_body">真的菜自己  这么详细的步骤竟然还会有问题</li>
                    <li class="recent_comment_author">--小虎哥0925</li>
                    <li class="recent_comment_title"><a href="https://www.cnblogs.com/liujinggang/p/9535366.html#4334206">5. Re:【接口时序】3、UART串口收发的原理与Verilog实现</a></li>
                    <li class="recent_comment_body">感谢博主 太详细了  准备操作一遍</li>
                    <li class="recent_comment_author">--小虎哥0925</li>
        </ul>
    </div>
</div>


</div>



<!-- 阅读排行榜 -->
<div id="sidebar_topviewedposts" class="sidebar-block">
    <div class="catListView">
<h3 class="catListTitle">阅读排行榜</h3>
	<div id="TopViewPostsBlock">
        <ul style="word-break:break-all">
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9609739.html">
                            1. 【接口时序】4、SPI总线的原理与Verilog实现(11618)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9651170.html">
                            2. 【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现(10663)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9782796.html">
                            3. 【接口时序】8、DDR3驱动原理与FPGA实现（一、DDR的基本原理）(6898)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9813863.html">
                            4. 【设计经验】2、ISE中ChipScope使用教程(6435)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9925859.html">
                            5. 【高速接口-RapidIO】1、RapidIO协议概述(6176)
                        </a>
                    </li>
        </ul>
    </div>
</div>


</div>

<!-- 评论排行榜 -->
<div id="sidebar_topcommentedposts" class="sidebar-block">
    <div class="catListFeedback">
<h3 class="catListTitle">评论排行榜</h3>
	<div id="TopFeedbackPostsBlock">
        <ul style="word-break:break-all">
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9656358.html">
                            1. 【接口时序】6、IIC总线的原理与Verilog实现(7)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9535366.html">
                            2. 【接口时序】3、UART串口收发的原理与Verilog实现(5)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9609739.html">
                            3. 【接口时序】4、SPI总线的原理与Verilog实现(3)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/9780767.html">
                            4. 【设计经验】1、Verilog中如何规范的处理inout信号(2)
                        </a>
                    </li>
                    <li>
                        <a href="https://www.cnblogs.com/liujinggang/p/10123498.html">
                            5. 【高速接口-RapidIO】6、Xilinx RapidIO核仿真与包时序分析(1)
                        </a>
                    </li>
        </ul>
    </div>
</div>


</div>

<!-- 推荐排行榜 -->
<div id="sidebar_topdiggedposts" class="sidebar-block">
    
<div id="topdigg_posts_wrap">
    <div class="catListView">
        <h3 class="catListTitle">推荐排行榜</h3>
        <div id="TopDiggPostsBlock">
            <ul style="word-break: break-all">
                        <li>
                            <a href="https://www.cnblogs.com/liujinggang/p/9609739.html">
                                1. 【接口时序】4、SPI总线的原理与Verilog实现(6)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/liujinggang/p/9535366.html">
                                2. 【接口时序】3、UART串口收发的原理与Verilog实现(4)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/liujinggang/p/10123498.html">
                                3. 【高速接口-RapidIO】6、Xilinx RapidIO核仿真与包时序分析(3)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/liujinggang/p/9656358.html">
                                4. 【接口时序】6、IIC总线的原理与Verilog实现(2)
                            </a>
                        </li>
                        <li>
                            <a href="https://www.cnblogs.com/liujinggang/p/9651170.html">
                                5. 【接口时序】5、QSPI Flash的原理与QSPI时序的Verilog实现(2)
                            </a>
                        </li>
            </ul>
        </div>
    </div>
</div>
</div></div>
                    <script>loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		<!--done-->
Copyright © 2019 jgliu
<br><span id="poweredby">Powered by .NET Core 3.0.0-preview9-19423-09 on Linux</span>



	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->


    


</body></html>