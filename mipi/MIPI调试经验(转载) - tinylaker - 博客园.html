
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="origin" />
    <meta property="og:description" content="转载自https://blog.csdn.net/g_salamander/article/details/9163455，整理修改图示部分，参考MIPI DSI Spec V01 以下是最近几个月在" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>MIPI调试经验(转载) - tinylaker - 博客园</title>
    
    <link rel="stylesheet" href="/css/blog-common.min.css?v=PyyhYDRKBG1sYtpoHme_xHO5AMd5iN57I45iBKF8FVY" />
    <link id="MainCss" rel="stylesheet" href="/skins/lessismore/bundle-lessismore.min.css?v=1lmBABNvH1t9BXpkhb10bZN9f1c0Xr-rdf30O35tbrs" />
    
    <link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="/skins/lessismore/bundle-lessismore-mobile.min.css?v=netr1CuSsXZ0CExbtEiL-uTF8pqcWT8cR0el_b5SyJM" />
    
    <link type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/tinylaker/rss" />
    <link type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/tinylaker/rsd.xml" />
    <link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/tinylaker/wlwmanifest.xml" />
    <script src="https://common.cnblogs.com/scripts/jquery-2.2.0.min.js"></script>
    <script src="/js/blog-common.min.js?v=F-Iy-_Lj7VcUKRIvNkS6UZ5LItMqjh1_L0VZk9Yxfb8"></script>
    <script>
        var currentBlogId = 468529;
        var currentBlogApp = 'tinylaker';
        var cb_enable_mathjax = false;
        var isLogined = false;
    </script>
    
    
    
</head>
<body>
    <a name="top"></a>
    
    <div id="home">
    <div id="header">
        <div id="blogTitle">
            
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle HeaderMainTitle" href="https://www.cnblogs.com/tinylaker/">tinylaker</a>
</div>
<div class="subtitle">

</div>

        </div>
        <div id="navigator">
            
<ul id="navList">
    <li id="nav_sitehome"><a id="blog_nav_sitehome" class="menu" href="https://www.cnblogs.com/">
博客园</a>
</li>
    <li id="nav_myhome">
<a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/tinylaker/">
首页</a>
</li>
    <li id="nav_newpost">

<a id="blog_nav_newpost" class="menu" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">
新随笔</a>
</li>
    <li id="nav_contact">
<a id="blog_nav_contact" class="menu" href="https://msg.cnblogs.com/send/tinylaker">
联系</a></li>
    <li id="nav_rss">
<a id="blog_nav_rss" class="menu" href="https://www.cnblogs.com/tinylaker/rss/">
订阅</a></li>
    <li id="nav_admin">
<a id="blog_nav_admin" class="menu" href="https://i.cnblogs.com/">
管理</a>
</li>
</ul>

            <div class="blogStats">
                
<span id="stats_post_count">随笔 - 
11&nbsp;</span>
<span id="stats_article_count">文章 - 
0&nbsp;</span>
<!-- <span id="stats-comment_count"></span> -->
<span id="stats_comment_count">评论 - 
0</span>
            </div>
        </div>
    </div>
    <div id="main">
        <div id="mainContent">
            <div class="forFlow">
                <div id="post_detail">
    <div id="topics">
        <div class="post">
            <h1 class="postTitle">
                
<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/tinylaker/p/9810019.html">MIPI调试经验(转载)</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
    <div class="toc">
    <p class="toc-title">目录</p>
    <div class="toc-list">
        <ul>
        <li><a href="#一d-phy">一、D-PHY</a><ul>
        <li><a href="#传输模式">1、传输模式</a></li>
        <li><a href="#lane-states">2、Lane States</a></li>
        <li><a href="#lane-levels">3、Lane Levels</a></li>
        <li><a href="#操作模式">4、操作模式</a></li>
        <li><a href="#时序要求">5、时序要求</a></li>
        </ul></li>
        <li><a href="#二dsi">二、DSI</a><ul>
        <li><a href="#线路构成">1、线路构成</a></li>
        <li><a href="#两种接口的-lcd">2、两种接口的 LCD</a></li>
        <li><a href="#数据包类型">3、数据包类型</a></li>
        <li><a href="#从控制器到外设发送的包类型">4、从控制器到外设发送的包类型</a></li>
        <li><a href="#从外设到处理器数据包类型">5、从外设到处理器数据包类型</a></li>
        <li><a href="#video-模式的-3-种数据格式">6、Video 模式的 3 种数据格式</a></li>
        </ul></li>
        <li><a href="#三调试记录">三、调试记录</a></li>
        </ul>
    </div>
</div>
<p>转载自https://blog.csdn.net/g_salamander/article/details/9163455，整理修改图示部分，参考MIPI DSI Spec V01</p>
<p>以下是最近几个月在调试 MIPI DSI / CSI 的一些经验总结，因为协议有专门的文档，所以这里就记录一些常用知识点：</p>
<h1 id="一d-phy">一、D-PHY</h1>
<h2 id="传输模式">1、传输模式</h2>
<p>LP（Low-Power） 模式：用于传输控制信号，最高速率 10 MHz</p>
<p>HS（High-Speed）模式：用于高速传输数据，速率范围 [80 Mbps， 1Gbps] per Lane</p>
<p>传输的最小单元为 1 个字节，采用小端的方式及 LSB first，MSB last。</p>
<h2 id="lane-states">2、Lane States</h2>
<ul>
<li>LP mode 有 4 种状态： LP00、LP01（0）、LP10（1）、LP11 （Dp、Dn）</li>
<li>HS mode 有 2 种状态： HS-0、HS-1</li>
</ul>
<p>HS 发送器发送的数据 LP 接收器看到的都是 LP00，</p>
<h2 id="lane-levels">3、Lane Levels</h2>
<ul>
<li>LP： 0 ~ 1.2V</li>
<li>HS： 100 ~ 300mV，HS common level = 200mV，swing = 200 mv</li>
</ul>
<h2 id="操作模式">4、操作模式</h2>
<p>在数据线上有 3 种可能的操作模式：Escape mode, High-Speed (Burst) mode and Control mode，下面是从停止状态进入相应模式需要的时序：</p>
<ul>
<li>Escape mode 进入时序：LP11→LP10→LP00→LP01→LP00，退出时序：LP10→LP11</li>
</ul>
<p>当进入 Escape mode 需要发送 8-bit entry command 表明请求的动作，比如要进行低速数据传输则需要发送 cmd： 0x87，进入超低功耗模式则发送 cmd： 0x78。在 DSI 中 LP 通讯只用 Data Lane 0。</p>
<ul>
<li>High-Speed mode 进入时序：LP11→LP01→LP00→SoT(0001_1101)，退出时序：EoT→LP11，时序图如下：</li>
</ul>
<p><img src="https://img2018.cnblogs.com/blog/1514304/201810/1514304-20181018130442508-1661074291.png" /></p>
<ul>
<li>Turnaround 进入时序：LP11→LP10→LP00→LP10→LP00，退出时序：LP00→LP10→LP11</li>
</ul>
<p>这时开启 BTA 的时序，一般用于从 slave 返回数据如 ACK： 0x84。</p>
<h2 id="时序要求">5、时序要求</h2>
<p>在调试 DSI 或者 CSI 的时候， HS mode 下的几个时序非常重要：T_LPX，T_HS-SETTLE ≈ T_HS-PREPARE + T_HS-ZERO，T_HS-TRAIL，一般遵循的原则为：Host 端的 T_HS-SETTLE &gt; Slave 端的 T_HS-SETTLE。</p>
<h1 id="二dsi">二、DSI</h1>
<h2 id="线路构成">1、线路构成</h2>
<p>在 DSI 中需要 1 根时钟线以及 1 ~ 4 根数据线。</p>
<h2 id="两种接口的-lcd">2、两种接口的 LCD</h2>
<ul>
<li>Command mode（对应 MPU 接口）</li>
<li>Video mode（对应 RGB 接口）</li>
</ul>
<p>该模式下视频数据只能通过 HS mode 传输。</p>
<h2 id="数据包类型">3、数据包类型</h2>
<p>短包：4 bytes，由 3 部分组成：</p>
<ul>
<li>Data Identifier (DI) * 1byte： Contains the Virtual Channel[7:6] and Data Type[5:0].</li>
<li>Packet Data * 2byte：Length is fixed at two bytes</li>
<li>Error Correction Code (ECC) * 1byte：allows single-bit errors to be corrected and 2-bit errors to be detected.</li>
</ul>
<p>长包：6 ~ 65541 bytes，同样由 3 部分组成：</p>
<ul>
<li>Packet Header(4 bytes) - 包头</li>
</ul>
<p>Data Identifier (DI) * 1byte：Contains the Virtual Channel[7:6] and Data Type[5:0].<br />
Word Count (WC) * 2byte：defines the number of bytes in the Data Payload.<br />
Error Correction Code (ECC) * 1byte：allows single-bit errors to be corrected and 2-bit errors to be detected.</p>
<ul>
<li>Data Payload(0~65535 bytes) - 有效数据<br />
Length = WC × bytes</li>
<li>Packet Footer(2 bytes)：Checksum - 包尾<br />
If the payload has length 0, then the Checksum calculation results in FFFFh<br />
If the Checksum isn’t calculated, the Checksum value is 0000h</li>
</ul>
<h2 id="从控制器到外设发送的包类型">4、从控制器到外设发送的包类型</h2>
<p><img src="https://img2018.cnblogs.com/blog/1514304/201810/1514304-20181018131047349-506777765.png" /></p>
<p>如果希望从外设读取数据或者状态，则在处理器发送完读取命令后还需要发送 BTA 命令，非读取命令在外设接收成功后会返回 trigger message 0x84。</p>
<h2 id="从外设到处理器数据包类型">5、从外设到处理器数据包类型</h2>
<p><img src="https://img2018.cnblogs.com/blog/1514304/201810/1514304-20181018131139157-948380794.png" /></p>
<p>返回的数据一般分为 4 个类型：</p>
<ul>
<li>Tearing Effect (TE)：trigger message (BAh)</li>
<li>Acknowledge：trigger message (84h)</li>
<li>Acknowledge and Error Report：short packet (Data Type is 02h)</li>
<li>Response to Read Request：short packet or long packet<br />
Generic Read Response、DCS Read Response（1byte, 2byte, multi byte）</li>
</ul>
<p>读取数据返回值解析示例如下：</p>
<ul>
<li>Acknowledge and Error report (if error occurs)<br />
Byte 0 is 0x87 (escape mode low power data transmission header)<br />
Byte 1 is 0x02 (Data type, 8.10 of “MIPI Alliance Specification for DSI”)<br />
Byte 3,2 are error report bits[15:0] (8.9.5 of “MIPI Alliance Specification for DSI”)<br />
Byte 4 is the ECC, calculated from byte 1,2,3</li>
<li>Generic Short READ response<br />
Byte 0 is 0x87 (escape mode low power data transmission header)<br />
Byte 1 is 0x11 or 0x12 (8.10 of “MIPI Alliance Specification for DSI”)<br />
Byte 2,3 are the read data. If only 1 byte is returned, byte 3 will be 0x00<br />
Byte 4 is the ECC, calculated from byte 1,2,3</li>
<li>Long READ packet response<br />
Byte 0 is 0x87 (escape mode low power data transmission header)<br />
Byte 1 is 0x1A (8.10 of “MIPI Alliance Specification for DSI”)<br />
Byte 3,2 are the word count N (N=0 to 65535)<br />
Byte 4 is the ECC, calculated from byte 1,2,3<br />
Byte 5 to byte 5+N-1 are the N-byte read data<br />
Byte 5+N+1, byte 5+N are the checksum, calculated on byte 5 to byte 5+N-1. If<br />
checksum is not calculated by peripheral, this field is 0x0000.</li>
</ul>
<h2 id="video-模式的-3-种数据格式">6、Video 模式的 3 种数据格式</h2>
<p><img src="https://img2018.cnblogs.com/blog/1514304/201810/1514304-20181018131358871-940146612.png" /></p>
<ul>
<li>Non-Burst Mode with Sync Pulses</li>
<li>Non-Burst Mode with Sync Events</li>
<li>Burst Mode</li>
</ul>
<h1 id="三调试记录">三、调试记录</h1>
<ul>
<li><p>LCD半边闪屏问题</p>
<blockquote>
<p>原厂给的信息：</p>
<p>分析了系統板送出的 video mode timing，資訊摘要如下</p>
<p>HSCLK: 160MHz<br />
Per lane bit-rate: 320Mbps (UI=3.125ns)<br />
HS SoT HS-prepare + HS-zero 約 155ns</p>
<p>由上述的 timing 懷疑與現象是因為 IC HS data settle timing 搭配不當所導致<br />
看来是我们输出的mipi信号 HS-prepare + HS-zero 比 LCD 默认设置短引起的。还有随机整屏闪动的问题通过调节 VFP 和 VBP 的值调到了理想状态。另外 LCD 的 VCC 在使用 mos 管控制后休眠后会有 2.0V 的悬浮电压，通过 RC 电路将电压放掉，将 C78 换成了 10K 电阻。<br />
LCD电路上有几个比较重要的电压: AVDD、VCC、VGH、VGL、HAVDD、VCOM（由AVDD通过电阻分压得到）</p>
</blockquote></li>
<li><p>唤醒慢的问题</p>
<blockquote>
<p>在最初调试的几款 LCD 里面初始化 cmd 都比较少，后来在调试一款 IPS 屏的时候发现唤醒需要 3 秒左右，这款 LCD 初始化 cmd 有100多条，之前在调试一款 LCD 的时候每条 cmd 发送之后需要 delay 10ms 再发下一条 cmd，所以在这款 LCD 这里不能有 delay，并且经过调试在确保发送成功的情况下将 LP 的传输速度提高了 3 倍（这里需要读取每条 cmd 的返回值 0x84 确认命令是否发送成功），优化后唤醒时间不到 1 秒。</p>
</blockquote></li>
<li><p>LCD 参数理解更正</p>
<blockquote>
<p>才发现之前一直对 LCD 的几个参数 HFP、HBP、VFP、VBP 理解有错误，正确的应该是以同步信号（HSYNC、VSYNC）为基准，在同步信号之前的称为 Front，在同步信号之后的称为 Back，而不是之前理解的以有效像素为基准。</p>
</blockquote></li>
<li><p>LCD 显示呈锯齿状问题</p>
<blockquote>
<p>这两天（12.11）还调试了一款 540 x 960 分辨率的 mipi LCD，在开始的时候一直点不亮，和供应商确认了好久无意间才发现是他们给的初始化代码是错的，使用正确的初始化代码就能点亮了，不过显示出来的图像却是呈锯齿状的，即没有对齐。之前在别的平台也遇到过类似问题，也就是分辨率不是 16 的整数倍，LCD controller 在取数据的时候会对不齐。边研究 Datasheet 边和 ASIC 同事讨论，后来确定了一个方案：即在 DSI、LCD 寄存器里面设置分辨率为 540 x 960 以让 LCD 正确识别信号，但 framebuffer 需要设置为 544 x 960 以对齐，并且设置 Source pitch 寄存器为 544，这样显示就正常了，相当于 framebuffer 里每一行的最后 4 个 pixel 会被 LCD controller 丢掉。</p>
</blockquote></li>
<li><p>讨论</p>
<blockquote>
<p>今天（12.12）在和 ASIC 同事的讨论下更正了之前的理解：LCD controller 在计算取数据的时候，地址是根据（x，y）坐标来算的，差不多是address = y * pitch + x + base，pitch 就是一行 pixel 在内存里的大小，这个至少是要对齐到 8byte， 因为 bus 宽度是 8byte，如 Data sheet 中的描述 ”Source pitch for RGB channel, QWORD aligned if linear mode“。之前计算 pitch 值的公式为：xres / 8 * bits_per_pixel / 8，如果 xres = 540，bits_per_pixel = 32，计算的结果因为取整的原因为 0x10c，实际上正确的值应该是 0x10e，所以需要将公式改为：xres * (bits_per_pixel / 8) / 8，即在每个像素占 4byte 的情况下只要 xres 为偶数就可以满足对齐的要求，而不用改为 544。</p>
</blockquote></li>
</ul>
</div>
<div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
    <div id="blog_post_info"></div>
    <div class="clear"></div>
    <div id="post_next_prev"></div>
</div>
            </div>
            <div class="postDesc">posted @ 
<span id="post-date">2018-10-18 13:43</span>&nbsp;
<a href="https://www.cnblogs.com/tinylaker/">tinylaker</a>&nbsp;
阅读(<span id="post_view_count">...</span>)&nbsp;
评论(<span id="post_comment_count">...</span>)&nbsp;
<a href="https://i.cnblogs.com/EditPosts.aspx?postid=9810019" rel="nofollow">编辑</a>&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(9810019);return false;">收藏</a></div>
        </div>
<script src="https://common.cnblogs.com/highlight/9.12.0/highlight.min.js"></script>
<script>markdown_highlight();</script>
<script>
    var allowComments = true, cb_blogId = 468529, cb_blogApp = 'tinylaker', cb_blogUserGuid = '1fb1460d-744b-4dec-e7df-08d634502d7b';
    var cb_entryId = 9810019, cb_entryCreatedDate = '2018-10-18 13:43', cb_postType = 1; 
    loadViewCount(cb_entryId);
</script><a name="!comments"></a>
<div id="blog-comments-placeholder"></div>
<script>
    var commentManager = new blogCommentManager();
    commentManager.renderComments(0);
</script>

<div id="comment_form" class="commentform">
    <a name="commentform"></a>
    <div id="divCommentShow"></div>
    <div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
    <div id="comment_form_container"></div>
    <div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
    <div id="ad_t2"></div>
    <div id="opt_under_post"></div>
    <script async="async" src="https://www.googletagservices.com/tag/js/gpt.js"></script>
    <script>
        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];
    </script>
    <script>
        googletag.cmd.push(function () {
            googletag.defineSlot("/1090369/C1", [300, 250], "div-gpt-ad-1546353474406-0").addService(googletag.pubads());
            googletag.defineSlot("/1090369/C2", [468, 60], "div-gpt-ad-1539008685004-0").addService(googletag.pubads());
            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
    <div id="cnblogs_c1" class="c_ad_block">
        <div id="div-gpt-ad-1546353474406-0" style="height:250px; width:300px;"></div>
    </div>
    <div id="under_post_news"></div>
    <div id="cnblogs_c2" class="c_ad_block">
        <div id="div-gpt-ad-1539008685004-0" style="height:60px; width:468px;">
            <script>
                if (new Date() >= new Date(2018, 9, 13)) {
                    googletag.cmd.push(function () { googletag.display("div-gpt-ad-1539008685004-0"); });
                }
            </script>
        </div>
    </div>
    <div id="under_post_kb"></div>
    <div id="HistoryToday" class="c_ad_block"></div>
    <script type="text/javascript">
        fixPostBody();
        setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
        deliverAdT2();
        deliverAdC1();
        deliverAdC2();
        loadNewsAndKb();
        loadBlogSignature();
LoadPostCategoriesTags(cb_blogId, cb_entryId);        LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
        GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
        loadOptUnderPost();
        GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
    </script>
</div>    </div>
</div>
            </div>
        </div>

        <div id="sideBar">
            <div id="sideBarMain">
                
<div id="sidebar_news" class="newsItem">
            <script>loadBlogNews();</script>
</div>

                <div id="calendar"><div id="blog-calendar" style="display:none"></div></div>                
                <script>loadBlogDefaultCalendar();</script>
                <div id="leftcontentcontainer">
                    <!-- begin:SingleColumn -->
                    <div id="blog-sidecolumn"></div>
                    <script>loadBlogSideColumn();</script>
                    <!-- end:  SingleColumn -->
                </div>
            </div>
        </div>
        <div class="clear"></div>
    </div>
    <div class="clear"></div>
    <div id="footer">
        <!--done-->
Copyright &copy; 2020 tinylaker
<br /><span id="poweredby">Powered by .NET Core 3.1.0 on Linux</span>

    </div>
</div>

    
</body>
</html>