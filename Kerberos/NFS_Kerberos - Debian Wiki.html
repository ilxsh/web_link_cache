<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/htdocs/favicon.ico">
<script type="text/javascript" src="/htdocs/bugstatus.js"></script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="robots" content="index,nofollow">

<title>NFS/Kerberos - Debian Wiki</title>
<script type="text/javascript" src="/htdocs/common/js/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="/htdocs/debwiki/css/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="/htdocs/debwiki/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="/htdocs/debwiki/css/projection.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debian-wiki-1.0.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/msie.css">
<![endif]-->


<link rel="alternate" title="Debian Wiki: NFS/Kerberos" href="/NFS/Kerberos?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=NFS%2FKerberos&amp;ddiffs=1" type="application/rss+xml">


<link rel="Start" href="/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="/NFS/Kerberos?action=raw">
<link rel="Alternate" media="print" title="Print View" href="/NFS/Kerberos?action=print">
<link rel="Up" href="/NFS">
<link rel="Search" href="/FindPage">
<link rel="Index" href="/TitleIndex">
<link rel="Glossary" href="/WordIndex">
<link rel="Help" href="/HelpOnFormatting">
</head>

<body  lang="en" dir="ltr">
<div id="logo"><a href="https://www.debian.org" title="Debian Homepage"><img src="https://www.debian.org/Pics/openlogo-50.png" alt="Debian" width="50" height="61"></a></div>
<div id="header">
<div id="wikisection">
<p class="section"><a href="/FrontPage" title="Debian Wiki Homepage">Wiki</a></p>
<div id="username"><a href="/NFS/Kerberos?action=login" id="login" rel="nofollow">Login</a></div>
</div>
<div id="navbar">

<ul id="navibar">
<li class="wikilink"><a href="/FrontPage">FrontPage</a></li><li class="wikilink"><a href="/RecentChanges">RecentChanges</a></li><li class="wikilink"><a href="/FindPage">FindPage</a></li><li class="wikilink"><a href="/HelpContents">HelpContents</a></li><li class="current"><a href="/NFS/Kerberos">NFS/Kerberos</a></li>
</ul>

</div>

<form id="searchform" method="get" action="/NFS/Kerberos">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20"
    onfocus="searchFocus(this)" onblur="searchBlur(this)"
    onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit"
    value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit"
    value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="https://www.debian.org" title="Debian Homepage"><img src="https://www.debian.org/Pics/openlogo-50.png" alt="Debian" width="50" height="61"></a></div>

<div id="breadcrumbs"><a href="/FrontPage" title="Debian Wiki Homepage">Wiki</a><span class="sep">/</span>

</div>

<ul class="editbar"><li><a href="/NFS/Kerberos?action=login" id="login-1" rel="nofollow">Login</a></li><li class="toggleCommentsButton" style="display:none;"><a href="#" class="nbcomment" onClick="toggleComments();return false;">Comments</a></li><li><a class="nbinfo" href="/NFS/Kerberos?action=info" rel="nofollow">Info</a></li><li><a class="nbattachments" href="/NFS/Kerberos?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="/NFS/Kerberos">
<div>
    <label>More Actions:</label>
    <select name="action"
        onchange="if ((this.selectedIndex != 0) &&
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="raw">Raw Text</option>
<option value="print">Print View</option>
<option value="RenderAsDocbook">Render as Docbook</option>
<option value="refresh">Delete Cache</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="SpellCheck">Check Spelling</option>
<option value="LikePages">Like Pages</option>
<option value="LocalSiteMap">Local Site Map</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="RenamePage" disabled class="disabled">Rename Page</option>
<option value="DeletePage" disabled class="disabled">Delete Page</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">Subscribe User</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="show" disabled class="disabled">Remove Spam</option>
<option value="show" disabled class="disabled">Revert to this revision</option>
<option value="PackagePages">Package Pages</option>
<option value="show" disabled class="disabled">------------------------</option>
<option value="Load">Load</option>
<option value="Save">Save</option>
<option value="SlideShow">SlideShow</option>
    </select>
    <input type="submit" value="Do">
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

<h1 id="locationline">


<ul id="pagelocation">
<li><a href="/NFS">NFS</a></li><li><a href="/NFS/Kerberos">Kerberos</a></li>
</ul>

</h1>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867">
<h1 id="NFSv4_.28nfs4.29_.2B-_Kerberos_in_Debian">NFSv4 (nfs4) + Kerberos in Debian</h1>
<span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line862">Some pointers to getting NFSv4 going with a Kerberos system, perhaps even one similar to <a href="/LDAP/Kerberos">LDAP/Kerberos</a>. <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867">
<h2 id="Overview">Overview</h2>
<span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line862">Once one has a nice <a href="/LDAP/Kerberos">LDAP/Kerberos</a> system running, one might want to mount filesystems across servers. After a bit of research, it seems that as of 2009-07-18 NFS is still the preferred way to do that between a bunch of Debian machines. NFS does have one horribly broken component to it which this tutorial hopes to solve: host-based authentication. By using Kerberos instead, hosts are required to prove identity in order to mount your filesystem instead of blindly assuming that the IP they're connecting from is genuine. This guideline is dedicated for Debian Jessie installations or newer. <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">Start by installing: <span class="anchor" id="line-10"></span><ul><li><p class="line891"><tt class="backtick">nfs-kernel-server</tt> (on the server) <span class="anchor" id="line-11"></span></li><li><p class="line891"><tt class="backtick">nfs-common</tt> (on both client and server) <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></li></ul><p class="line862">Read through <tt class="backtick">/usr/share/doc/nfs-common/README.Debian.nfsv4</tt>. It's a great introduction to this. From here on, it is assumed that you've read this document and may still be struggling to get it going. <span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line867">
<h3 id="Client_and_Server">Client and Server</h3>
<span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line862">Create an nfs Kerberos principal for your client and server machines. This should be in the form of <tt class="backtick">nfs/hostname@REALM</tt>. Each host should have a copy of its own key inside <em>/etc/krb5.keytab</em>. For each host, locally run <em>kadmin -p adminuser/admin</em> (adminuser/admin is an admin principal) with the commands: <span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><p class="line867"><span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><pre><span class="anchor" id="line-1"></span>addpriv -randkey nfs/hostnamename@REALM
<span class="anchor" id="line-2"></span>ktadd nfs/clientname@REALM</pre><span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><p class="line874">The correct hostname can be found out with the command <span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><pre><span class="anchor" id="line-1-1"></span>getent hosts $(hostname) | awk '{print $1; exit}' | xargs getent hosts | awk '{print $2}'</pre><span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line862">Please note that the ktadd command invaidates all previously-issued keys <a class="http" href="http://kerberos.996246.n3.nabble.com/keytab-kvno-ktadd-and-existing-tickets-td17558.html">reference</a>. <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><p class="line867">
<h3 id="Server">Server</h3>
<span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line862">There is the myth that one needs to create an export root directory (having fsid=0) and bind all exported directories into it. This works, but the regular exporting as in nfs3 works and is less error-prone. I.e., the command <em>showmount --exports</em> works only without an export root. <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><p class="line862">Say we wish to expose <tt class="backtick">/home</tt> on the server. In your <tt class="backtick">/etc/exports</tt> would read: <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line867"><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><pre><span class="anchor" id="line-1-2"></span># 'no_subtree_check' is specified to get rid of warning messages
<span class="anchor" id="line-2-1"></span>#    about the default value changing. This is the default value
<span class="anchor" id="line-3"></span>/home   192.168.1.0/24(rw,sync,no_subtree_check,sec=krb5)</pre><span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><p class="line874">(Replace the network 192.168.1.0/24 according to your desired export configuration. Please note that the older notation &quot;gss/krb5&quot; instead of the network results at least in some situations in errors on the client side about non-existing mount points although &quot;showmount -e&quot; displays them.) <span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span><p class="line874">There are three different modes that nfs can operate in with Kerberos, which should be specified in the mount/export options: <span class="anchor" id="line-47"></span><ul><li><p class="line891"><em>krb5</em> Use Kerberos for authentication only. <span class="anchor" id="line-48"></span></li><li><p class="line891"><em>krb5i</em> Use Kerberos for authentication, and include a hash with each transaction to ensure integrity. Traffic can still be intercepted and examined, but modifications to the traffic will be apparent. <span class="anchor" id="line-49"></span></li><li><p class="line891"><em>krb5p</em> Use Kerberos for authentication, and encrypt all traffic between the client and server. This is the most secure, but also incurs the most load. <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span></li></ul><p class="line867">
<h3 id="Client">Client</h3>
<span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line874">On the client side, mount in the following way: <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line867"><span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><pre><span class="anchor" id="line-1-3"></span>$ mount -t nfs4 -o sec=krb5 nfs4-server.example.com:/home /home</pre><span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><p class="line874">If you don't specify the type, it may fall back on nfs3, which will probably error on you. <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><p class="line867">
<h2 id="Tips">Tips</h2>
<span class="anchor" id="line-62"></span><ul><li><p class="line862">Your <tt class="backtick">/etc/krb5.keytab</tt> file should only be readable by root.  <span class="anchor" id="line-63"></span></li><li><p class="line862">Try enabling verbose messages for rpc.gssd by adding <tt class="backtick">RPCGSSDOPTS=&quot;-vvv&quot;</tt> to <tt class="backtick">/etc/default/nfs-common</tt> <span class="anchor" id="line-64"></span></li><li><p class="line862">If autodetection fails, edit <tt class="backtick">/etc/default/nfs-common</tt> to enable <tt class="backtick">idmapd</tt>, <tt class="backtick">gssd</tt> on the clients + server and <tt class="backtick">/etc/default/nfs-kernel-server</tt> to enable <tt class="backtick">svcgssd</tt> on the server. <span class="anchor" id="line-65"></span></li><li><p class="line862">ensure your Kerberos domains are correctly configured. This includes in your krb5.conf file; nfs seems to use it to get the realm. This also seems to imply that servers must be in the form of HOST.<em>domain</em>, where <em>domain</em> is common to both the server and client. <span class="anchor" id="line-66"></span></li><li>Make sure your domain is specified in /etc/idmapd.conf <span class="anchor" id="line-67"></span></li><li><p class="line862">when tinkering with your export file, make sure to re-export with <tt class="backtick">exportfs&nbsp;-ra</tt> <span class="anchor" id="line-68"></span></li><li><p class="line891"><tt class="backtick">rpc.svcgssd</tt> on the server looks for the prinicpal <tt class="backtick">nfs/</tt><em>reverse_lookup_of_your_ip_address</em> (not necessary <tt class="backtick">nfs/</tt><em>hostnameT</em>). Check if the principal matches the return value of the above command. If necessary, you can specify this in your <tt class="backtick">/etc/hosts</tt> file. <span class="anchor" id="line-69"></span></li><li>Errors about corrupt keyfiles in auth.log often can be resolved by deleting and re-creating keys and keyfiles. <span class="anchor" id="line-70"></span></li><li>Errors about &quot;Additional pre-authentication required&quot; in auth.log indicate that not the right keys are in the keyfiles or that some wrong encryption ciphers have been used (the default ciphers should be ok). The server should only need a server key inside, the client only the client key. Restart all nfs services after changing the keyfiles. <span class="anchor" id="line-71"></span></li><li>&quot;Server not found in Kerberos database&quot; in auth.log indicate that the key names of client or server and the respective hostnames do not match. <span class="anchor" id="line-72"></span></li><li><p class="line862">If all else fails, restart your daemons. Also try restarting <tt class="backtick">nscd</tt>, as that can cause hard-to-spot caching errors. <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span></li></ul><p class="line867">
<h2 id="Other_tutorials_and_further_information_sources">Other tutorials and further information sources</h2>
<span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><ul><li><p class="line891"><a class="http" href="http://www-theorie.physik.unizh.ch/~dpotter/howto/kerberos">http://www-theorie.physik.unizh.ch/~dpotter/howto/kerberos</a> <span class="anchor" id="line-77"></span></li><li><p class="line891"><a class="http" href="http://farfewertoes.com/stories/2009-05-12-simple_nfsv4_configuration_for_debian_and_ubuntu/">http://farfewertoes.com/stories/2009-05-12-simple_nfsv4_configuration_for_debian_and_ubuntu/</a> <span class="anchor" id="line-78"></span></li><li><p class="line891"><a href="/DebianLAN">Debian-LAN provides a complete implementation of kerberized NFSv4</a> <span class="anchor" id="line-79"></span></li></ul><span class="anchor" id="bottom"></span></div><div id="pagebottom"></div>
</div>


<div id="footer">
<p id="pageinfo" class="info" lang="en" dir="ltr">NFS/Kerberos  (<a class="nbinfo" href="/NFS/Kerberos?action=info" rel="nofollow">last modified 2015-11-15 22:37:26</a>)</p>

<ul id="credits">
<li><a href="https://www.debian.org/legal/privacy">Debian privacy policy</a><br></li><li><a href="https://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="https://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li>Debian Wiki <a href="/Teams/DebianWiki">team</a>, <a href="https://bugs.debian.org/wiki.debian.org">bugs</a> and <a href="https://salsa.debian.org/debian/wiki.debian.org">config</a> available.</li><li>Hosting provided by <a href="https://www.man-da.de/">Metropolitan Area Network Darmstadt</a></li>
</ul>


</div>
</body>
</html>

