/**
 * 路障广告
 */
(function(jQuery){
    var thisURL = window.location.href;
    if(thisURL.indexOf('member.php') != -1){
        return false;
    }
    var cookiehelper = function(name, value, options) {
        if (typeof value != 'undefined') { // name and value given, set cookie
            options = options || {};
            if (value === null) {
                value = '';
                options.expires = -1;
            }
            var expires = '';
            if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
                var date;
                if (typeof options.expires == 'number') {
                    date = new Date();
                    date.setTime(date.getTime() + (options.expires * 60 * 60 * 1000));
                } else {
                    date = options.expires;
                }
                expires = '; expires=' + date.toUTCString(); // use expires attribute, max-age is not supported by IE
            }
            var path = options.path ? '; path=' + options.path : '';
            var domain = options.domain ? '; domain=' + options.domain : '';
            var secure = options.secure ? '; secure' : '';
            document.cookie = [name, '=', encodeURIComponent(value), expires, path, domain, secure].join('');
        } else { // only name given, get cookie
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var whitespace = "[\\x20\\t\\r\\n\\f]",
                        rtrim = new RegExp( "^" + whitespace + "+|((?:^|[^\\\\])(?:\\\\.)*)" + whitespace + "+$", "g" );
                    var cookie = cookies[i] == null ? "" : ( cookies[i] + "" ).replace( rtrim, "" );
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    };
    var MAX_da442f5f = '';
    MAX_da442f5f += "<"+"div id=\"MAX_da442f5f\" style=\"position:absolute; width:640px; height:480px; z-index:9999; left: 0px; top: 0px; visibility: hidden\">\n";
    MAX_da442f5f += "<"+"table cellspacing=\"0\" cellpadding=\"0\" style=\"border-style: solid; border-width: 1px; border-color: #ccc\">\n";
    // MAX_da442f5f += "<"+"tr>\n";
    // MAX_da442f5f += "<"+"td bgcolor=\"#FFFFFF\" align=\"right\" style=\"padding: 2px\"><"+"a class=\"pop_close\" href=\"javascript:;\" onClick=\"MAX_simplepop_da442f5f(\'close\'); return false;\" style=\"color:#333;text-decoration:none;padding-right:10px; font-size:14px; font-family:'微软雅黑'\"><"+"span>关闭<"+"/span><"+"/a><"+"/td>\n";
    // MAX_da442f5f += "<"+"/tr>\n";
    MAX_da442f5f += "<"+"tr>\n";
    MAX_da442f5f += "<"+"td bgcolor=\"#FFFFFF\" align=\"center\">\n";
    MAX_da442f5f += "<"+"table border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n";
    MAX_da442f5f += "<"+"tr id='roadblock-box'>\n";
    // MAX_da442f5f +="<"+"iframe scrolling=\"no\" width=\"640\" height=\"480\" frameborder=\"0\" src=\"\" id='roadblock'><"+"/iframe"+">";
    MAX_da442f5f += "<"+"/tr>\n";
    MAX_da442f5f += "<"+"/table>\n";
    MAX_da442f5f += "<"+"span id=\"tdk-close\" style=\"background: url(http://www.elecfans.com/images2013/close.png) no-repeat 0 0; cursor: pointer; width: 24px; height: 24px; position: absolute; display: block; right: -12px; top: -12px; z-index: 101;\" title=\"点击关闭\">\n";
    MAX_da442f5f += "<"+"/span>\n";
    MAX_da442f5f += "<"+"/td>\n";
    MAX_da442f5f += "<"+"/tr>\n";
    MAX_da442f5f += "<"+"/table>\n";
    MAX_da442f5f += "<"+"/div>\n";
    document.write(MAX_da442f5f);

    function MAX_findObj(n, d) {
      var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
      d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
      if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
      for(i=0;!x&&d.layers&&i>d.layers.length;i++) x=MAX_findObj(n,d.layers[i].document);
      if(!x && document.getElementById) x=document.getElementById(n); return x;
    }

    function MAX_getClientSize() {
        if (window.innerHeight >= 0) {
            return [window.innerWidth, window.innerHeight];
        } else if (document.documentElement && document.documentElement.clientWidth > 0) {
            return [document.documentElement.clientWidth,document.documentElement.clientHeight]
        } else if (document.body.clientHeight > 0) {
            return [document.body.clientWidth,document.body.clientHeight]
        } else {
            return [0, 0]
        }
    }

    function MAX_adlayers_place_da442f5f(){
        var c = MAX_findObj('MAX_da442f5f');

        if (!c)
            return false;

        _s='style'

        var clientSize = MAX_getClientSize()
        ih = clientSize[1]
        iw = clientSize[0]

        if(document.all && !window.opera)
        {
            sl = document.body.scrollLeft || document.documentElement.scrollLeft;
            st = document.body.scrollTop || document.documentElement.scrollTop;
            of = 0;
        }
        else
        {
            sl = window.pageXOffset;
            st = window.pageYOffset;

            if (window.opera)
                of = 0;
            else
                of = 16;
        }

         c[_s].left = parseInt(sl+(iw - 640) / 2 + 0) + (window.opera?'':'px');
         c[_s].top = parseInt(st+(ih - 480) / 2 + 0) + (window.opera?'':'px');

        c[_s].visibility = MAX_adlayers_visible_da442f5f;
        c[_s].display = MAX_adlayers_display_da442f5f;
        if (MAX_adlayers_display_da442f5f == 'none') {
            c.innerHTML = '&nbsp;';
        }
    }

    function www1_openX_ad(posterid,htmlid,width,height){
        if(jQuery(htmlid).length > 0){
            var randomnumber = Math.random();
            var ga = document.createElement('iframe');
            ga.src = 'http://www1.elecfans.com/www/delivery/myafr.php?target=_blank&cb='+randomnumber+'&zoneid='+posterid;
            ga.width = width;
            ga.height = height;
            ga.frameBorder = 0;
            ga.scrolling = 'no';
            var s = jQuery(htmlid).append(ga);
        }
    }

    /**
     * Google 路障广告
     * @param  {[type]} htmlid [description]
     * @param  {[type]} width  [description]
     * @param  {[type]} height [description]
     * @return {[type]}        [description]
     */
    function googletagservice(htmlid, width, height) {
        if(jQuery(htmlid).length > 0){
            var randomnumber = Math.random();
            var ga = document.createElement('iframe');
            ga.src = 'http://www1.elecfans.com/public/googlead/roadblock.html';
            ga.width = width;
            ga.height = height;
            ga.frameBorder = 0;
            ga.scrolling = 'no';
            var s = jQuery(htmlid).append(ga);
        }
    }

    function MAX_simplepop_da442f5f(what, frequency){
        var c = MAX_findObj('MAX_da442f5f');

        if (!c)
            return false;

        if (c.style)
            c = c.style;

        switch(what)
        {
            case 'close':
                MAX_adlayers_visible_da442f5f = 'hidden';
                MAX_adlayers_display_da442f5f = 'none';
                MAX_adlayers_place_da442f5f();
                window.clearInterval(MAX_adlayers_timerid_da442f5f);
                break;

            case 'open':
                MAX_adlayers_visible_da442f5f = 'visible';
                MAX_adlayers_display_da442f5f = 'block';
                MAX_adlayers_place_da442f5f();
                MAX_adlayers_timerid_da442f5f = window.setInterval(MAX_adlayers_place_da442f5f, 10);

                www1_openX_ad('443','#roadblock-box', 640, 480)
                // googletagservice('#roadblock-box', 640, 480);
                if (isNaN(popAdsValue)) {
                    popAdsValue = 0;
                }

                cookiehelper('popAds', parseInt(1+popAdsValue), {expires:frequency, path:'/'});

                setTimeout(MAX_simplepop_da442f5f, 30000, 'close');

                jQuery('#tdk-close').click(function(){
                    MAX_simplepop_da442f5f('close');
                });
                break;
        }
    }


    var MAX_adlayers_timerid_da442f5f;
    var MAX_adlayers_visible_da442f5f;
    var MAX_adlayers_display_da442f5f;
    var popAdsValue = parseInt(cookiehelper('popAds'));


    if(isNaN(popAdsValue) ||  popAdsValue < 1){
        var domain_bbs = window.location.host
        var domain_www = domain_bbs.replace(/bbs\.elecfans/, 'www.elecfans');
        jQuery.ajax({
            type:'GET',
            url:'http://' + domain_www + '/webapi/advertisement/roadblock',
            data:{site_name:'bbs',format:'jsonp'},
            dataType:'jsonp',
            success: function(response) {
                if (response.error_code != 0) {
                    return false;
                }
                var data = response.data;
                MAX_simplepop_da442f5f('open', data['frequency']);
            }
        });
    }


        // 显示视频路障广告
  var showTdkVideoAd = function() {
    var setStyle=
        '<style type="text/css">'+
        '/*2015-07-20 tdk弹窗广告*/'+
        '#isShowVideo{cursor: pointer;background: #000;color: #fff;width: 161px;text-align: left;font-size: 14px;padding: 10px 0 10px 10px;box-sizing:border-box;display: none;}'+
        '.closeOpenxBtn{background: #fff;border: 1px solid #999999;padding: 3px 15px;margin: 8px;color: #999999; cursor: pointer;}'+
        '.goTargetUrl{text-decoration: none;cursor: pointer;display: block;line-height: 45px;margin-left: 80px;font-size: 15px;}'+
        '</style>'
      ;
    var content = '<div id="isShowVideo">ADI “魔术手”上线<br /> 点击了解<br />ADI如何超越一切可能！</div>'+
                  '<div style="display: flex; display: -ms-flexbox;display: -ms-flexbox;display: -moz-box">'+
                  '<button class="closeOpenxBtn">关闭</button>'+
                  '<a class="goTargetUrl" target="_blank">ADI “魔术手”上线点击了解ADI如何超越一切可能！&gt;&gt;&gt;</a>'+
                  '</div>'
    var script = "<SCRIPT language='JavaScript1.1' SRC='https://ad.doubleclick.net/ddm/trackimpj/N7384.1821876ELECFANS.COM/B21679777.228535550;dc_trk_aid=426716634;dc_trk_cid=105808177;ord=[timestamp];dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=?'></SCRIPT>"
    jQuery('body').append(setStyle+'<div style="position: fixed; right: 0; bottom: 0; z-index: 500;border: 1px solid #999999;background: #fff;">'+content+'<div id="video-fix-tdkad"><iframe width="640" height="480" frameborder="0" src="http://www1.elecfans.com/www/delivery/myafr.php?target=_blank&cb=0.8775979285112017&zoneid=699" scrolling="no"></iframe></div></div>' + script);
   //关闭视频路障广告
    closeTdkVideoAd()
  }

    function sendGA(){
        //向谷歌发送数据
        if(typeof(ga)!="undefined"){
          ga('send', 'event', 'ADI_video_banner', 'click', '[ADI_video_banner]');
        }
        //向百度发送数据
        if(typeof(_hmt)!="undefined"){
          _hmt.push(['_trackEvent', 'ADI_video_banner', 'click', '[ADI_video_banner]']);
        }
    }

  var closeTdkVideoAd = function(){
     jQuery('#isShowVideo').click(function(){
      jQuery(this).hide()
      jQuery(".closeOpenxBtn").parent().show()
      jQuery('#video-fix-tdkad').css("display", 'block')
    });
    jQuery('.closeOpenxBtn').click(function(){
        jQuery('#video-fix-tdkad').hide();
        jQuery(this).parent().hide()
        jQuery('#isShowVideo').css("display", 'block')
      })
    jQuery(".goTargetUrl").click(function(){
        sendGA()
        window.open('https://ad.doubleclick.net/ddm/trackclk/N7384.1821876ELECFANS.COM/B21679777.228535550;dc_trk_aid=426716634;dc_trk_cid=105808177;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=')
    })
  }
  var _that= this
  //视频路障广告
  if(cookiehelper("popAdsVideo") != "yes"){
    var domain_bbs = window.location.host
    var domain_www = domain_bbs.replace(/bbs\.elecfans/, 'www.elecfans');
    jQuery.ajax({
            type:'get',
            url:'http://'+ domain_www +'/webapi/advertisement/roadblock',
            data:{site_name:'bbs', format:'jsonp', ad_type: 5},
            dataType:'jsonp',
            success: function(response){
                if (response.error_code != 0) {
                    return false;
                }
                var data = response.data;
                cookiehelper("popAdsVideo", "yes", {expires:data['frequency'], path:"/"});
                showTdkVideoAd();
            }
        });
  } else {
    var setStyle=
        '<style type="text/css">'+
        '#isShowVideoNext{cursor:pointer;background: #000;color: #fff;width: 161px;text-align: left;font-size: 14px;padding: 10px 0 10px 10px;; box-sizing: border-box; display: block;}'+
        '</style>'
      ;
    var content = '<div id="isShowVideoNext">ADI “魔术手”上线<br /> 点击了解<br />ADI如何超越一切可能！</div>';
    jQuery('body').append(setStyle+'<div style="position: fixed; right: 0; bottom: 0; z-index: 1001;border: 1px solid #999999;background: #fff;">'+content+'</div>');
    jQuery("#isShowVideoNext").click(function(){
      jQuery(this).hide()
      showTdkVideoAd()
    })
  }
})(jQuery);



/**
 * 直播弹窗，页面 右下角
 * @param  {[type]} $ [description]  
 * @return {[type]}   [description]
 */
(function($){
    var domain_bbs = window.location.host
    var domain_www = domain_bbs.replace(/bbs\.elecfans/, 'www.elecfans');
    $.ajax({
        type:'GET',
        url:'http://'+domain_www+'/webapi/advertisement/liveElasticLayer?site_name=bbs&format=jsonp&all=1',
        dataType:'jsonp',
        success:function(response) {
            if (response.error_code == 0 && response.data) {
                var data = response.data;
                var setHTML = ' <div style="position:fixed;bottom: 0px;right:0;z-index:5000;width:300px;height:300px;">'+
                                    '<img src="http://'+domain_www+'/images2013/live_elastic_layer.png">'
                                        for(var i = 0; i< data.length; i++){
                                            setHTML+='<div class="aditem" style="display:none;position:fixed;bottom;margin-top: -135px;z-index: 6000;text-align: center;width: 300px;">'+
                                                        '<a href="'+data[i]['live_url']+'" target="_blank"">'+
                                                            '<p style="font-size: 12px;font-weight: bold;font-family: 微软雅黑;color:#3d3d3d;">'+data[i]['event_name']+'</p>'+
                                                            '<p style="font-size: 15px;font-weight: bold;font-family: 微软雅黑;color:#3d3d3d;">'+data[i]['event_subject']+'</p>'+
                                                            '<p style="font-size: 11px;font-weight: bold;font-family: 微软雅黑;color:#757575;">'+data[i]['event_time']+'</p>'+
                                                            '<p style="font-size: 11px;font-weight: bold;font-family: 微软雅黑;color:#757575;">'+data[i]['event_desc']+'</p>'+
                                                        '</a>'+
                                                     '</div>'
                                        }

                                    setHTML+='<i class="close_icon" style="position:fixed;bottom: 237px;right: 6px;width: 30px;height: 30px;z-index:5002;cursor:pointer;/* background: #ddd; */"></i></div>'

                $("body").append(setHTML);
                $(".close_icon").click(function(){
                    $(this).parent().remove();
                    return false;
                });
                var index = 0;
                var timer = setInterval(function(){
                    index ++;
                    if(index == $('.aditem').length){
                        index = 0;
                    }
                    $('.aditem').each(function(i){
                        if(i == index){
                            $(this).show()
                        }else {
                            $(this).hide()
                        }
                    })
                }, 2000)
            }
        }
    });
})(jQuery);
