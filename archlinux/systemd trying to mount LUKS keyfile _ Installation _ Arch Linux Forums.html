<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0051)https://bbs.archlinux.org/viewtopic.php?pid=1771830 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>systemd trying to mount LUKS keyfile / Installation / Arch Linux Forums</title>
<link rel="stylesheet" type="text/css" href="./systemd trying to mount LUKS keyfile _ Installation _ Arch Linux Forums_files/ArchLinux.css">
<link rel="canonical" href="https://bbs.archlinux.org/viewtopic.php?id=235025" title="Page 1">
<link rel="alternate" type="application/atom+xml" href="https://bbs.archlinux.org/extern.php?action=feed&amp;tid=235025&amp;type=atom" title="Atom topic feed">
    <link rel="stylesheet" media="screen" href="./systemd trying to mount LUKS keyfile _ Installation _ Arch Linux Forums_files/arch.css">
        <link rel="stylesheet" media="screen" href="./systemd trying to mount LUKS keyfile _ Installation _ Arch Linux Forums_files/archnavbar.css">
    
<link rel="shortcut icon" href="https://bbs.archlinux.org/style/ArchLinux/favicon.ico">
</head>

<body>
<div id="archnavbar" class="anb-forum">
	<div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div>
	<div id="archnavbarmenu">
		<ul id="archnavbarlist">
			<li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-security"><a href="https://security.archlinux.org/">Security</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li>		</ul>
	</div>
</div>


<div id="punviewtopic" class="pun">
<div class="top-box"></div>
<div class="punwrap">

<div id="brdheader" class="block">
	<div class="box">
		<div id="brdmenu" class="inbox">
			<ul>
				<li id="navindex" class="isactive"><a href="https://bbs.archlinux.org/index.php">Index</a></li>
				<li id="navrules"><a href="https://bbs.archlinux.org/misc.php?action=rules">Rules</a></li>
				<li id="navsearch"><a href="https://bbs.archlinux.org/search.php">Search</a></li>
				<li id="navregister"><a href="https://bbs.archlinux.org/register.php">Register</a></li>
				<li id="navlogin"><a href="https://bbs.archlinux.org/login.php">Login</a></li>
			</ul>
		</div>
		<div id="brdwelcome" class="inbox">
			<p class="conl">You are not logged in.</p>
			<ul class="conr">
				<li><span>Topics: <a href="https://bbs.archlinux.org/search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="https://bbs.archlinux.org/search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li>
			</ul>
			<div class="clearer"></div>
		</div>
	</div>
</div>



<div id="brdmain">
<div class="linkst">
	<div class="inbox crumbsplus">
		<ul class="crumbs">
			<li><a href="https://bbs.archlinux.org/index.php">Index</a></li>
			<li><span>»&nbsp;</span><a href="https://bbs.archlinux.org/viewforum.php?id=17">Installation</a></li>
			<li><span>»&nbsp;</span><strong><a href="https://bbs.archlinux.org/viewtopic.php?id=235025">systemd trying to mount LUKS keyfile</a></strong></li>
		</ul>
		<div class="pagepost">
			<p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong></p>
		</div>
		<div class="clearer"></div>
	</div>
</div>

<div id="p1771830" class="blockpost rowodd firstpost blockpost1">
	<h2><span><span class="conr">#1</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1771830#p1771830">2018-03-04 09:50:44</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>ascendrix</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2018-03-04</span></dd>
						<dd><span>Posts: 1</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>systemd trying to mount LUKS keyfile</h3>
					<div class="postmsg">
						<p>Hi,</p><p>I just setup a system with an encrypted root partition which is automatically unlocked at boot by a keyfile, which is stored on /boot (I'm aware that this defeats the main purpose of encryption).</p><p>My /etc/crypttab file looks like this:<br>sda2_crypt UUID=186b2415-a31f-41d1-9c6a-5c745e4d2faf /dev/disk/by-uuid/f41f8341-ec7d-425c-8c69-fb586c0c5850:/keyfile luks,discard,keyscript=/lib/cryptsetup/scripts/passdev</p><p>My /etc/fstab file looks like this:<br>UUID=f41f8341-ec7d-425c-8c69-fb586c0c5850 /boot&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ext2&nbsp; &nbsp; defaults&nbsp; &nbsp; &nbsp; &nbsp; 0&nbsp; &nbsp; &nbsp; &nbsp;2<br>/dev/mapper/sda2_crypt /&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ext4&nbsp; &nbsp; errors=remount-ro 0&nbsp; &nbsp; &nbsp; &nbsp;1</p><p>During boot I get an error message stating that "a start job is running for dev-disk-by uuid" and I have to wait 90 seconds until boot resumes. In the log file (/var/log/syslog) I found this particular entry:<br>systemd[1]: dev-disk-by\x2duuid-f41f8341\x2dec7d\x2d425c\x2d8c69\x2dfb586c0c5850:-keyfile.device: Job dev-disk-by\x2duuid-f41f8341\x2dec7d\x2d425c\x2d8c69\x2dfb586c0c5850:-keyfile.device/start timed out.</p><p>The way I understand this is that systemd is trying to mount my keyfile as a device (but it's just a file?). Does anyone know how to fix this, so that systemd doesn't try to mount or start it?</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1772914" class="blockpost roweven">
	<h2><span><span class="conr">#2</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1772914#p1772914">2018-03-09 12:20:39</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>grantek</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2018-03-09</span></dd>
						<dd><span>Posts: 1</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: systemd trying to mount LUKS keyfile</h3>
					<div class="postmsg">
						<p>I'm facing the same issue on a Debian system, I agree it's probably an error parsing the keyfile option in crypttab, but I managed to work around it.</p><p>I have a slightly more convoluted setup:<br>- Key file for my root partition exists on a USB key, this is configured in /etc/crypttab in order for the initramfs configuration to hook it all up.<br>This part is the same as your setup, and I worked around it by disabling the post-root systemd's cryptsetup generator, using "luks.crypttab=no" as described here: <a href="https://www.freedesktop.org/software/systemd/man/systemd-cryptsetup-generator.html" rel="nofollow">https://www.freedesktop.org/software/sy … rator.html</a></p><p>- Then I added an additional partition/filesystem and wanted to keep the key on the root filesystem, with a regular filesystem path for the keydev option in /etc/crypttab<br>This completely broke my boot process, due to the cryptsetup generator being disabled, so I removed that kernel argument and got the 90 second timeout back.</p><p>I tried the "noauto" option in crypttab for my root device (since root was already unlocked and mounted at this point), but it had no effect.</p><p>I then tried "luks.cryptsetup=no" with "luks.uuid=..." to whitelist the extra partition, but this still failed, in a weird way - the cryptsetup generator still was looking for the keyfile argument (with the full filesystem path appended to the .device, which is the broken bit) to my boot line in crypttab, and trying to wait for it as a device. Perhaps it wasn't matching the UUID specified on the kernel command line to the correct crypttab line, but 1. the boot device it was matching was specified with a UUID, which obviously didn't match, and 2. I tried changing the extra partition's line in crypttab to select it by UUID, and it still failed in the same way.</p><p>I was finally able to work around it by deleting the line in /etc/crypttab for my extra partition, and specifying the whole crypttab configuration using kernel command line arguments:<br>luks.crypttab=no luks.name=&lt;uuid&gt;=&lt;unlocked device name&gt; luks.key=&lt;uuid&gt;=/path/to/key</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div class="postlinksb">
	<div class="inbox crumbsplus">
		<div class="pagepost">
			<p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong></p>
		</div>
		<ul class="crumbs">
			<li><a href="https://bbs.archlinux.org/index.php">Index</a></li>
			<li><span>»&nbsp;</span><a href="https://bbs.archlinux.org/viewforum.php?id=17">Installation</a></li>
			<li><span>»&nbsp;</span><strong><a href="https://bbs.archlinux.org/viewtopic.php?id=235025">systemd trying to mount LUKS keyfile</a></strong></li>
		</ul>
		<div class="clearer"></div>
	</div>
</div>
</div>

<div id="brdfooter" class="block">
	<h2><span>Board footer</span></h2>
	<div class="box">
		<div id="brdfooternav" class="inbox">
			<div class="conl">
				<form id="qjump" method="get" action="https://bbs.archlinux.org/viewforum.php">
					<div><label><span>Jump to<br></span>
					<select name="id" onchange="window.location=(&#39;viewforum.php?id=&#39;+this.options[this.selectedIndex].value)">
						<optgroup label="Technical Issues and Assistance">
							<option value="23">Newbie Corner</option>
							<option value="17" selected="selected">Installation</option>
							<option value="22">Kernel &amp; Hardware</option>
							<option value="18">Applications &amp; Desktop Environments</option>
							<option value="31">Laptop Issues</option>
							<option value="8">Networking, Server, and Protection</option>
							<option value="32">Multimedia and Games</option>
							<option value="50">System Administration</option>
							<option value="35">Other Architectures</option>
						</optgroup>
						<optgroup label="Arch-centric">
							<option value="24">Announcements, Package &amp; Security Advisories</option>
							<option value="1">Arch Discussion</option>
							<option value="13">Forum &amp; Wiki discussion</option>
						</optgroup>
						<optgroup label="Pacman Upgrades, Packaging &amp; AUR">
							<option value="44">Pacman &amp; Package Upgrade Issues</option>
							<option value="49">[testing] Repo Forum</option>
							<option value="4">Creating &amp; Modifying Packages</option>
							<option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option>
						</optgroup>
						<optgroup label="Contributions &amp; Discussion">
							<option value="20">GNU/Linux Discussion</option>
							<option value="27">Community Contributions</option>
							<option value="33">Programming &amp; Scripting</option>
							<option value="30">Other Languages</option>
							<option value="47">Artwork and Screenshots</option>
						</optgroup>
					</select></label>
					<input type="submit" value=" Go " accesskey="g">
					</div>
				</form>
			</div>
			<div class="conr">
				<p id="feedlinks"><span class="atom"><a href="https://bbs.archlinux.org/extern.php?action=feed&amp;tid=235025&amp;type=atom">Atom topic feed</a></span></p>
				<p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p>
			</div>
			<div class="clearer"></div>
		</div>
	</div>
</div>

</div>
<div class="end-box"></div>
</div>



</body></html>