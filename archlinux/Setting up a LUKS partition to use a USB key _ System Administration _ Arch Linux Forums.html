<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0049)https://bbs.archlinux.org/viewtopic.php?id=192858 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Setting up a LUKS partition to use a USB key / System Administration / Arch Linux Forums</title>
<link rel="stylesheet" type="text/css" href="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/ArchLinux.css">
<link rel="canonical" href="https://bbs.archlinux.org/viewtopic.php?id=192858" title="Page 1">
<link rel="alternate" type="application/atom+xml" href="https://bbs.archlinux.org/extern.php?action=feed&amp;tid=192858&amp;type=atom" title="Atom topic feed">
    <link rel="stylesheet" media="screen" href="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/arch.css">
        <link rel="stylesheet" media="screen" href="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/archnavbar.css">
    
<link rel="shortcut icon" href="https://bbs.archlinux.org/style/ArchLinux/favicon.ico">
</head>

<body>
<div id="archnavbar" class="anb-forum">
	<div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div>
	<div id="archnavbarmenu">
		<ul id="archnavbarlist">
			<li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-security"><a href="https://security.archlinux.org/">Security</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li>		</ul>
	</div>
</div>


<div id="punviewtopic" class="pun">
<div class="top-box"></div>
<div class="punwrap">

<div id="brdheader" class="block">
	<div class="box">
		<div id="brdmenu" class="inbox">
			<ul>
				<li id="navindex" class="isactive"><a href="https://bbs.archlinux.org/index.php">Index</a></li>
				<li id="navrules"><a href="https://bbs.archlinux.org/misc.php?action=rules">Rules</a></li>
				<li id="navsearch"><a href="https://bbs.archlinux.org/search.php">Search</a></li>
				<li id="navregister"><a href="https://bbs.archlinux.org/register.php">Register</a></li>
				<li id="navlogin"><a href="https://bbs.archlinux.org/login.php">Login</a></li>
			</ul>
		</div>
		<div id="brdwelcome" class="inbox">
			<p class="conl">You are not logged in.</p>
			<ul class="conr">
				<li><span>Topics: <a href="https://bbs.archlinux.org/search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="https://bbs.archlinux.org/search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li>
			</ul>
			<div class="clearer"></div>
		</div>
	</div>
</div>



<div id="brdmain">
<div class="linkst">
	<div class="inbox crumbsplus">
		<ul class="crumbs">
			<li><a href="https://bbs.archlinux.org/index.php">Index</a></li>
			<li><span>»&nbsp;</span><a href="https://bbs.archlinux.org/viewforum.php?id=50">System Administration</a></li>
			<li><span>»&nbsp;</span><strong><a href="https://bbs.archlinux.org/viewtopic.php?id=192858">Setting up a LUKS partition to use a USB key</a></strong></li>
		</ul>
		<div class="pagepost">
			<p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong></p>
		</div>
		<div class="clearer"></div>
	</div>
</div>

<div id="p1497315" class="blockpost rowodd firstpost blockpost1">
	<h2><span><span class="conr">#1</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1497315#p1497315">2015-01-28 14:34:27</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>jonnybarnes</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>From: Manchester, UK</span></dd>
						<dd><span>Registered: 2011-05-11</span></dd>
						<dd><span>Posts: 127</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://jonnybarnes.uk/" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>Im playing with an old netbook I've been given, essentially practicing for when I get a new desktop. Anyway, I want to install Arch on a LUKS encrypted partition and have it unlocked at boot time using a key located on a USB key.</p><p>This is what I did first time round and whilst the root partition is indeed encrypted I'm having to type a passphrase every boot:</p><div class="codebox"><pre><code>loadkeys uk
lsblk
gdisk /dev/sda
  outout should eventually look like:
  Command (? for help): p
  Disk /dev/sda: 
  Logical sector size: 512 bytes
  Disk identifier (GUID): 
  Partition table holds up to 128 entries
  First usable sector is 34, last usable sector is 
  Partitions will be aligned on 2048-sector boundaries
  Total free space is 2014 sectors (1007.0 KiB)
 
  Number  Start (sector)    End (sector)  Size       Code  Name
     1            2048            8191   3.0 MiB     EF02  BIOS boot partition
     2            8192         1032191   500.0 MiB   8300  boot
     3         1032192                               8300  root
cryptsetup -v --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 5000 --use-random luksFormat /dev/sda3
  enter a passphrase twice here
cryptsetup open /dev/sda3 ARCHROOT
mkfs.ext4 /dev/sda2
mkfs.btrfs /dev/mapper/ARCHROOT
mount /dev/mapper/ARCHROOT /mnt
cd /mnt</code></pre></div><p>Would I need to </p><div class="codebox"><pre><code>cryptsetup luksAddKey /path/to/keyfile</code></pre></div><p> after the first cyptsetup step? If so can the live Arch environment mount USB drives at this point in the installation process?</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1497319" class="blockpost roweven">
	<h2><span><span class="conr">#2</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1497319#p1497319">2015-01-28 14:56:03</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>nstgc</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2014-03-17</span></dd>
						<dd><span>Posts: 379</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>I'm currently working on something similar. I just got my new laptop in the mail and want to make sure this thing is secure. I'll let you know if I figure anything out.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1497330" class="blockpost rowodd">
	<h2><span><span class="conr">#3</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1497330#p1497330">2015-01-28 15:39:24</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>firecat53</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd class="postavatar"><img src="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/10920.png" width="80" height="80" alt=""></dd>
						<dd><span>From: Lake Stevens, WA, USA</span></dd>
						<dd><span>Registered: 2007-05-14</span></dd>
						<dd><span>Posts: 1,526</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://github.com/firecat53" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>I have this setup using a keyfile (don't set a passphrase) on the USB drive to unlock the luks partition. <a href="https://gist.github.com/firecat53/17b3d309ea54a0ed0cd4" rel="nofollow">Here are the setup </a> notes I kept. Hopefully something useful in there for you.</p><p>Scott</p>
						<p class="postedit"><em>Last edited by firecat53 (2015-01-28 15:46:33)</em></p>
					</div>
					<div class="postsignature postmsg"><hr><p><a href="https://github.com/firecat53" rel="nofollow">Github</a></p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1497443" class="blockpost roweven">
	<h2><span><span class="conr">#4</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1497443#p1497443">2015-01-28 19:12:01</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>nstgc</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2014-03-17</span></dd>
						<dd><span>Posts: 379</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>I tried following your notes for my laptop, however when I checked to make sure everything worked properly it failed. I then tried again on my desktop using a test partition with nearly the exact same input and it worked. The chief, non-trivial, difference was the use of an actual file on a mounted FS as opposed to a device. I dd'ed /dev/random to a USB drive and used "/dev/sdc" as the file. Since *nix systems are suppose to treat everything as a file, I figured this would work.</p><p>I tried using the USB keyfile on my desktop. I noticed this time, however, that it complained that the keyfile was too large. Apparently a 128MiB keyfile is not supported <img src="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/tongue.png" width="15" height="15" alt="tongue">. Using a smaller, less unreasonable size it worked fine.</p><p>[edit] Oh, wait, it was trying for a 32GB USB drive. As in teh whole thing. That was the problem.</p><p>[edit2] Okay, something isn't work. Not sure what, or why.</p><p>[edit3] It doesn't seem to like </p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX="cryptdevice=/dev/disk/by-label/SCOTTY:root:allow-discards cryptkey=/dev/disk/by-label/ISO:ext4:/&lt;path/to/keyfile/on/flash drive&gt;"</code></pre></div><p>In particular it seems as if it located the partition by label.</p><p>[edit4] To confirm, I got it to work, however there was the small snag with identifying the disk by label. Aside from that Firecat's notes were great.</p>
						<p class="postedit"><em>Last edited by nstgc (2015-01-30 21:30:01)</em></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1498742" class="blockpost rowodd">
	<h2><span><span class="conr">#5</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1498742#p1498742">2015-02-01 22:18:44</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>teateawhy</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>From: GER</span></dd>
						<dd><span>Registered: 2012-03-05</span></dd>
						<dd><span>Posts: 1,135</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://github.com/vitamins/archinstaller" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>Nobody has mentioned this yet, here is the wiki page that deals with storing the key on a USB key:<br><a href="https://wiki.archlinux.org/index.php/Dm-crypt/Device_encryption#Unlock_the_root_partition_at_boot_using_a_keyfile" rel="nofollow">https://wiki.archlinux.org/index.php/Dm … _a_keyfile</a></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1498810" class="blockpost roweven">
	<h2><span><span class="conr">#6</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1498810#p1498810">2015-02-02 02:21:11</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>nstgc</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2014-03-17</span></dd>
						<dd><span>Posts: 379</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<div class="quotebox"><cite>teateawhy wrote:</cite><blockquote><div><p>Nobody has mentioned this yet, here is the wiki page that deals with storing the key on a USB key:<br><a href="https://wiki.archlinux.org/index.php/Dm-crypt/Device_encryption#Unlock_the_root_partition_at_boot_using_a_keyfile" rel="nofollow">https://wiki.archlinux.org/index.php/Dm … _a_keyfile</a></p></div></blockquote></div><p>I saw Firecat's post first, which is, in my opinion, better than what's on the wiki.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1499477" class="blockpost rowodd">
	<h2><span><span class="conr">#7</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1499477#p1499477">2015-02-03 19:58:16</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>teateawhy</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>From: GER</span></dd>
						<dd><span>Registered: 2012-03-05</span></dd>
						<dd><span>Posts: 1,135</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://github.com/vitamins/archinstaller" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>I think it is a good idea if you edit the wiki and add a link to firecat's post. Or even add some of his content directly, if firecat allows it <img src="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/big_smile.png" width="15" height="15" alt="big_smile"></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1499500" class="blockpost roweven">
	<h2><span><span class="conr">#8</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1499500#p1499500">2015-02-03 20:51:30</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>firecat53</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd class="postavatar"><img src="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/10920.png" width="80" height="80" alt=""></dd>
						<dd><span>From: Lake Stevens, WA, USA</span></dd>
						<dd><span>Registered: 2007-05-14</span></dd>
						<dd><span>Posts: 1,526</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://github.com/firecat53" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>Of course!! Just please someone smater than me idiot check it first!! I'll try and contribute some to the wiki given a little time....</p>
					</div>
					<div class="postsignature postmsg"><hr><p><a href="https://github.com/firecat53" rel="nofollow">Github</a></p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1500598" class="blockpost rowodd">
	<h2><span><span class="conr">#9</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1500598#p1500598">2015-02-07 12:20:49</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>starfry</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>From: Surrey, UK</span></dd>
						<dd><span>Registered: 2010-08-18</span></dd>
						<dd><span>Posts: 202</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>Hi, just thought I'd chip in as I have just done all this and cleared away a few problems along the way...</p><p>I have my laptop 100% encrypted with detached headers and keys stored in an encrypted partition on a USB key. The laptop has two hard drives that together form a LVM volume group containing a root volume plus several others. There is one key/header per physical disk and both are the whole volume group.</p><p>The encrypted USB partition contains the headers and keys for the pv containing the lv that is the root filesystem. I enter the passphrase for the encrypted partition and Grub then uses the keys in that partition to decrypt the encrypted root to read the kernel and initramfs. I have them on the filesystem so that I don't have to faff with moving kernels etc onto USB every time I update. The initramfs contains the keys and headers for all of the pv's that form the vg so it they can be unlocked and the lv's activated by systemd during boot. (You have to use systemd in the initramfs for this - Grub can only unlock one device).</p><p>I also have a server that has a hybrid config where the root is plain but some filesystems exist that are encrypted. This time, systemd prompts for the passphrase of the encrypted partition on the USB key and reads the necessary headers and keys from there. The kernel and initramfs are on a plaintext device so Grub needs no special configuration.</p><p>To get this to work, I extended Grub with support for detached headers. See <a href="http://grub.johnlane.ie/" rel="nofollow">http://grub.johnlane.ie</a>. I have a PKGBUILD for this and will stick in on AUR if there's interest (I just haven't got around to it yet).</p><p>It's also necessary to have the latest systemd (systemd-git from AUR) because 218 (current latest) doesn't support detached headers in /etc/crypttab. See "man crupttab" and check out the new "--header" option.</p><p>If you want to be able to pull the USB stick out after booting (once the devices are unlocked and the keys/headers are no longer needed) then you cannot use /etc/crypttab because the systemd generator imposes too strong dependencies that makes it unmount the volumes if the device containing the key file is unlocked. It's reported upstream and there's a TODO for it. Meanwhile, 've used a custom unit to work around the problem. Again, I can post if there's interest.</p><p>If I can enlighten any more let me know...</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1500602" class="blockpost roweven">
	<h2><span><span class="conr">#10</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1500602#p1500602">2015-02-07 12:36:17</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>frostschutz</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd class="postavatar"><img src="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/76897.png" width="80" height="80" alt=""></dd>
						<dd><span>Registered: 2013-11-15</span></dd>
						<dd><span>Posts: 909</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<div class="quotebox"><cite>starfry wrote:</cite><blockquote><div><p>I have my laptop 100% encrypted with detached headers and keys stored in an encrypted partition on a USB key.</p></div></blockquote></div><p>Do you have a backup of those headers, then? Kinda sucks to lose all your data to a faulty USB key.</p><div class="quotebox"><cite>starfry wrote:</cite><blockquote><div><p>I enter the passphrase for the encrypted partition and Grub then uses the keys in that partition to decrypt the encrypted root to read the kernel and initramfs.<br>[...]<br>To get this to work, I extended Grub with support for detached headers.</p></div></blockquote></div><p>Wow. Personally I don't let Grub handle the encryption. It's all in Initramfs for me (luks encrypted keyfiles). Security wise it shouldn't matter, if someone can modify my Initramfs, they can also modify my Grub. It may be harder in your case since you already use a modified Grub...</p><div class="quotebox"><cite>starfry wrote:</cite><blockquote><div><p>If you want to be able to pull the USB stick out after booting (once the devices are unlocked and the keys/headers are no longer needed) then you cannot use /etc/crypttab because the systemd generator imposes too strong dependencies that makes it unmount the volumes if the device containing the key file is unlocked.</p></div></blockquote></div><p>Oh. That's strange. I can pull my USB stick as soon as Grub is done loading the kernel and initramfs, i.e. the moment kernel messages start to appear. They keys and all are part of the Initramfs, so the USB stick is no longer necessary.</p><p>Basically, it's this method: <a href="https://wiki.gentoo.org/wiki/Custom_Initramfs#Encrypted_Keyfile" rel="nofollow">https://wiki.gentoo.org/wiki/Custom_Ini … ed_Keyfile</a> and the first example here: <a href="https://wiki.gentoo.org/wiki/Custom_Initramfs/Examples" rel="nofollow">https://wiki.gentoo.org/wiki/Custom_Initramfs/Examples</a></p>
						<p class="postedit"><em>Last edited by frostschutz (2015-02-07 12:39:18)</em></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1500619" class="blockpost rowodd">
	<h2><span><span class="conr">#11</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1500619#p1500619">2015-02-07 13:30:45</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>starfry</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>From: Surrey, UK</span></dd>
						<dd><span>Registered: 2010-08-18</span></dd>
						<dd><span>Posts: 202</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<div class="quotebox"><cite>frostschutz wrote:</cite><blockquote><div><p>Do you have a backup of those headers, then? Kinda sucks to lose all your data to a faulty USB key.</p></div></blockquote></div><p>hehe, yes several USB keys and other secure storage.</p><div class="quotebox"><cite>frostschultz wrote:</cite><blockquote><div><p>Security wise it shouldn't matter, if someone can modify my Initramfs, they can also modify my Grub.</p></div></blockquote></div><p>The other thing I forgot to mention is that my USB stick is also my boot device. There's no Grub or any other bootloader on the target systems to mess with. If started without the key, they just say "operating system not found". Even if someone got hold of the USB stick, as a last line of defence, all the keys and headers that Grub needs (as well as the Grub boot config) is stored on an encrypted partition on the USB stick that requires a passphrase to unlock. </p><div class="quotebox"><cite>frostschultz wrote:</cite><blockquote><div><p>I can pull my USB stick as soon as Grub is done loading the kernel and initramfs, i.e. the moment kernel messages start to appear. They keys and all are part of the Initramfs, so the USB stick is no longer necessary.</p><p>Basically, it's this method: <a href="https://wiki.gentoo.org/wiki/Custom_Initramfs#Encrypted_Keyfile" rel="nofollow">https://wiki.gentoo.org/wiki/Custom_Ini … ed_Keyfile</a> and the first example here: <a href="https://wiki.gentoo.org/wiki/Custom_Initramfs/Examples" rel="nofollow">https://wiki.gentoo.org/wiki/Custom_Initramfs/Examples</a></p></div></blockquote></div><p>That gentoo example doesn't use systemd. I wanted to use the native systemd functionality as much as possible. My my initramfs opens what's necessary for boot (essentially the root filesystem) and the main early-boot does everything else. I wanted to use the standard /etc/fstab and /etc/crypttab and allow systemd to sort everything out but I encountered the dependency problem. I have a very simple workaround for it, however. </p><p>I'll just add to that as well that the systemd issue is only on systems where the initramfs is insecure and, therefore, cannot contain keys. Those systems with the initramfs on an encrypted filesystem don't need the usb key to unlock the rest of the encrypted filesystems because the keys are in the encrypted initramfs. They only need the USB key to unlock the root. I cannot secure the initramfs on some systems because of the way they boot (specifically, non-x86 boxes that cannot use Grub or are unable to boot off arbitrary devices).</p>
						<p class="postedit"><em>Last edited by starfry (2015-02-07 14:09:29)</em></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1501925" class="blockpost roweven">
	<h2><span><span class="conr">#12</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1501925#p1501925">2015-02-11 14:23:42</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>gcala</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2010-06-03</span></dd>
						<dd><span>Posts: 9</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>Hi, I'm trying to unlock my encrypted home partion at boot time through a keyfile stored on flash-drive, but without luck. I followed wiki and firecat53's gist.</p><p>1) added keyfile (an image stored in root of flash-drive) to luks header; i'm able to open di device using the keyfile in command line so i presume this step is right.<br>2) labeled both home partition and flash-drive: SCOTTY for sda10 and TX8GB for sdb1<br>3) added hooks and modules as explained in wiki and firecat53's guide plus mkinitcpio command<br>4) disabled previously added crypttab line to unlock partition at boot time through passphrase (homecrypt UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX none luks,timeout=180)<br>5) added the following options to kernel in grub.cfg:</p><div class="codebox"><pre><code>cryptdevice=/dev/disk/by-label/SCOTTY:homecrypt cryptkey=/dev/disk/by-label/TX8GB:vfat:/bar.jpg</code></pre></div><p>Unfortunately, something goes wrong during boot and after a timer with the message "A start job is running for dev-mapper-homecrypt.device" the boot ends in a maintenance console.</p><p>If I restore the crypttab line (step 4) it asks for the passphrase and, after interting it, the system completes successfully the boot process.</p><p>Am I missing any step?</p><p>Thanks</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1501965" class="blockpost rowodd">
	<h2><span><span class="conr">#13</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1501965#p1501965">2015-02-11 16:54:26</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>teateawhy</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>From: GER</span></dd>
						<dd><span>Registered: 2012-03-05</span></dd>
						<dd><span>Posts: 1,135</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://github.com/vitamins/archinstaller" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>@gcala<br>For the home partition it is better to use crypttab instead of the cryptdevice= parameter in grub.cfg.<br>See:<br><a href="https://wiki.archlinux.org/index.php/Dm-crypt/System_configuration#crypttab" rel="nofollow">https://wiki.archlinux.org/index.php/Dm … n#crypttab</a><br>Using the cryptdevice= parameter means you are unlocking the partition from the initramfs. This is not necessary for the home partition, as the home partition can be unlocked later in the boot process. Unlocking from the initramfs is only necessary when you need&nbsp; access to the partition at the beginning of the boot process, for example the root partition.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1501974" class="blockpost roweven">
	<h2><span><span class="conr">#14</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1501974#p1501974">2015-02-11 17:23:32</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>gcala</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2010-06-03</span></dd>
						<dd><span>Posts: 9</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<div class="quotebox"><cite>teateawhy wrote:</cite><blockquote><div><p>For the home partition it is better to use crypttab instead of the cryptdevice= parameter in grub.cfg.<br>See: <a href="https://wiki.archlinux.org/index.php/Dm-crypt/System_configuration#crypttab" rel="nofollow">https://wiki.archlinux.org/index.php/Dm … n#crypttab</a></p></div></blockquote></div><p>Thanks teateawhy, but I already consulted that wiki page and, if I'm not wrong, it does not explain which path to use. It has some examples but nothing related to external flash-drive. For instance, it reports the following line:</p><div class="codebox"><pre><code>externaldrive         UUID=2f9a8428-ac69-478a-88a2-4aa458565431        none    luks,timeout=180</code></pre></div><p>saying that "A keyfile can also be set up and referenced instead of none.", Ok, but how? /mnt/media/? /run/media/root/TX8GB? or /dev/disk/by-label/TX8GB:vfat:/bar.jpg?</p>
						<p class="postedit"><em>Last edited by gcala (2015-02-11 17:24:20)</em></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1502000" class="blockpost rowodd">
	<h2><span><span class="conr">#15</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1502000#p1502000">2015-02-11 19:03:39</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>teateawhy</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>From: GER</span></dd>
						<dd><span>Registered: 2012-03-05</span></dd>
						<dd><span>Posts: 1,135</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://github.com/vitamins/archinstaller" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>@gcoala<br>Ah yes you are right the keyfile must be accessed by its path, which is only possible after the usb stick has been mounted. So using crypttab does not work unless you mount the usb stick from initramfs. I think it is better to continue with your inital setup as firecat has described it and forget what i said before.<br>"A start job is running for dev-mapper-homecrypt.device"<br>This message looks like systemd has generated it. Do you still have the "systemd" hook in /etc/mkinitcpio.conf ? I think you have to remove it for this to work.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1502030" class="blockpost roweven">
	<h2><span><span class="conr">#16</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1502030#p1502030">2015-02-11 20:23:52</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>firecat53</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd class="postavatar"><img src="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/10920.png" width="80" height="80" alt=""></dd>
						<dd><span>From: Lake Stevens, WA, USA</span></dd>
						<dd><span>Registered: 2007-05-14</span></dd>
						<dd><span>Posts: 1,526</span></dd>
						<dd class="usercontacts"><span class="website"><a href="https://github.com/firecat53" rel="nofollow">Website</a></span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>@gcala - the path to the keyfile is referenced to the root of the USB drive partition. For example, my keyfile is at /scotty/&lt;keyfile.jpg&gt;, where scotty/ is a directory in the root directory of the flash drive filesystem and the partition label is ISO. So my grub line looks like:</p><div class="codebox"><pre><code>"cryptdevice=/dev/disk/by-uuid/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx:root:allow-discards cryptkey=/dev/disk/by-label/ISO:ext4:/scotty/&lt;filename&gt;.png"</code></pre></div><p>I'm not sure about the other error message. You should definitely make sure you can access your encrypted partition using just the keyfile from a live CD/USB session.</p><p>Just in case it helps, my MODULES and HOOKS lines in /etc/mkinitcpio.conf are:</p><div class="codebox"><pre><code> MODULES="i915 ext4 nls_cp437"
HOOKS="base udev autodetect consolefont modconf block encrypt filesystems keyboard fsck"</code></pre></div><p>Scott</p>
					</div>
					<div class="postsignature postmsg"><hr><p><a href="https://github.com/firecat53" rel="nofollow">Github</a></p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1502210" class="blockpost rowodd">
	<h2><span><span class="conr">#17</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1502210#p1502210">2015-02-12 10:36:32</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>gcala</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2010-06-03</span></dd>
						<dd><span>Posts: 9</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>Success!! The trick is to use UUID to identify the encrypted device instead of label. Thank you all.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1502215" class="blockpost roweven">
	<h2><span><span class="conr">#18</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1502215#p1502215">2015-02-12 11:03:26</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>gcala</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd><span>Registered: 2010-06-03</span></dd>
						<dd><span>Posts: 9</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<div class="quotebox"><cite>frostschutz wrote:</cite><blockquote><div><p>I can pull my USB stick as soon as Grub is done loading the kernel and initramfs, i.e. the moment kernel messages start to appear. They keys and all are part of the Initramfs, so the USB stick is no longer necessary.</p></div></blockquote></div><p>So you just pull the flash drive without 'umount' command? Is it safe?</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p1502244" class="blockpost rowodd">
	<h2><span><span class="conr">#19</span> <a href="https://bbs.archlinux.org/viewtopic.php?pid=1502244#p1502244">2015-02-12 13:15:09</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong>frostschutz</strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
						<dd class="postavatar"><img src="./Setting up a LUKS partition to use a USB key _ System Administration _ Arch Linux Forums_files/76897.png" width="80" height="80" alt=""></dd>
						<dd><span>Registered: 2013-11-15</span></dd>
						<dd><span>Posts: 909</span></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Setting up a LUKS partition to use a USB key</h3>
					<div class="postmsg">
						<p>In my case it's safe because it never got mounted in the first place.</p><p>Grub is on the stick and Grub loads kernel + initramfs. But the kernel never mounts the stick itself, it mounts the root partitions instead which are all on internal SSD / HDD. So once grub is done and kernel starts booting, the stick no longer matters. I put the encrypted keys in the initramfs itself.</p><p>The stick is /boot but it's set to noauto in fstab. OTOH this means when I update kernel I have to mount /boot manually first.</p>
						<p class="postedit"><em>Last edited by frostschutz (2015-02-12 13:16:19)</em></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div class="postlinksb">
	<div class="inbox crumbsplus">
		<div class="pagepost">
			<p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong></p>
		</div>
		<ul class="crumbs">
			<li><a href="https://bbs.archlinux.org/index.php">Index</a></li>
			<li><span>»&nbsp;</span><a href="https://bbs.archlinux.org/viewforum.php?id=50">System Administration</a></li>
			<li><span>»&nbsp;</span><strong><a href="https://bbs.archlinux.org/viewtopic.php?id=192858">Setting up a LUKS partition to use a USB key</a></strong></li>
		</ul>
		<div class="clearer"></div>
	</div>
</div>
</div>

<div id="brdfooter" class="block">
	<h2><span>Board footer</span></h2>
	<div class="box">
		<div id="brdfooternav" class="inbox">
			<div class="conl">
				<form id="qjump" method="get" action="https://bbs.archlinux.org/viewforum.php">
					<div><label><span>Jump to<br></span>
					<select name="id" onchange="window.location=(&#39;viewforum.php?id=&#39;+this.options[this.selectedIndex].value)">
						<optgroup label="Technical Issues and Assistance">
							<option value="23">Newbie Corner</option>
							<option value="17">Installation</option>
							<option value="22">Kernel &amp; Hardware</option>
							<option value="18">Applications &amp; Desktop Environments</option>
							<option value="31">Laptop Issues</option>
							<option value="8">Networking, Server, and Protection</option>
							<option value="32">Multimedia and Games</option>
							<option value="50" selected="selected">System Administration</option>
							<option value="35">Other Architectures</option>
						</optgroup>
						<optgroup label="Arch-centric">
							<option value="24">Announcements, Package &amp; Security Advisories</option>
							<option value="1">Arch Discussion</option>
							<option value="13">Forum &amp; Wiki discussion</option>
						</optgroup>
						<optgroup label="Pacman Upgrades, Packaging &amp; AUR">
							<option value="44">Pacman &amp; Package Upgrade Issues</option>
							<option value="49">[testing] Repo Forum</option>
							<option value="4">Creating &amp; Modifying Packages</option>
							<option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option>
						</optgroup>
						<optgroup label="Contributions &amp; Discussion">
							<option value="20">GNU/Linux Discussion</option>
							<option value="27">Community Contributions</option>
							<option value="33">Programming &amp; Scripting</option>
							<option value="30">Other Languages</option>
							<option value="47">Artwork and Screenshots</option>
						</optgroup>
					</select></label>
					<input type="submit" value=" Go " accesskey="g">
					</div>
				</form>
			</div>
			<div class="conr">
				<p id="feedlinks"><span class="atom"><a href="https://bbs.archlinux.org/extern.php?action=feed&amp;tid=192858&amp;type=atom">Atom topic feed</a></span></p>
				<p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p>
			</div>
			<div class="clearer"></div>
		</div>
	</div>
</div>

</div>
<div class="end-box"></div>
</div>



</body></html>