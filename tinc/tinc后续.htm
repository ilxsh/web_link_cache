<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/icon/iconfont.css">
    <link rel="canonical" href="https://blogs.vicsdf.com/article/4190"/>
        <link rel="stylesheet" href="/css/agate.min.css">
        <link rel="stylesheet" href="/css/v1.css?1">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.cookie.min.js"></script>
        <meta name="keywords" content="tinc后续">
    <meta name="description"  content="之前用tinc构建了虚拟专网，实现了在不同局域网内的机器通过tinc互相访问，但是遇到一个问题，我想从公司里访问到家里其他没有装tinc的机器，或者从家里其他没有装tinc的机器访问到公司里装了tinc的机器。经过一番简单的设置便可以达到想"/>
    <title>tinc后续</title>
</head>
<body>
<header>
    <div class="wrap flex">
        <div class="logo flex-auto">
            <a href="//blogs.vicsdf.com"><img alt="博客汇" src="/img/logo.png" height="32"></a>
        </div>
    </div>
</header><section class="content">
    <div class="wrap flex">
        <div class="flex-auto article-body">
            <article class="detail">
                <h1>tinc后续</h1>
                <div class="c3">
                    <span class="c3-0">on <a href="/date/2018-07-26">2018-07-26</a></span> |
                    <span class="c3-0 author_name">by <a author_id="91" href="/author/91">类库大魔王/missdeer</a></span>
                    <span class="c3-2"><a href="#"><i class="iconfont icon-shoucang">0</i></a></span>
                    <span class="c3-3"><a href="#">关注作者</a></span>
                </div>
                <div class="body"><p>之前用tinc构建了虚拟专网，实现了在不同局域网内的机器通过tinc互相访问，但是遇到一个问题，我想从公司里访问到家里其他没有装tinc的机器，或者从家里其他没有装tinc的机器访问到公司里装了tinc的机器。经过一番简单的设置便可以达到想要的效果。</p>

<p>家里一台HTPC装了tinc，新增IP为<code class="highlighter-rouge">192.168.88.3</code>，内网IP为<code class="highlighter-rouge">192.168.66.110</code>，家里所有机器网关都指向软路由，假设IP为<code class="highlighter-rouge">192.168.66.1</code>，修改相应配置。</p>

<p>修改所有机器上的<code class="highlighter-rouge">/etc/tinc/bignet/hosts/shhtpc</code>文件，头部增加一行：</p>

<pre><code class="language-。">Subnet = 192.168.66.0/24
</code></pre>

<p>刷新tinc的配置，要用<code class="highlighter-rouge">sudo</code>：</p>

<pre class="highlight"><code><span class="nb">sudo </span>tincd <span class="nt">-n</span> bignet <span class="nt">-kHUP</span>
</code></pre>

<p>设置流量转发，修改<code class="highlighter-rouge">/etc/sysctl.conf</code>：</p>

<pre class="highlight"><code>net.ipv4.ip_forward=1
</code></pre>

<p>执行以下命令使其生效：</p>

<pre class="highlight"><code><span class="nb">sudo </span>sysctl <span class="nt">-p</span>
</code></pre>

<p>修改路由器<code class="highlighter-rouge">192.68.66.1</code>上的静态路由：</p>

<pre class="highlight"><code><span class="nb">sudo </span>ip route add 192.168.88.0/24 via 192.168.66.110
</code></pre>

<p>至此，家里所有机器的流量先全部流到路由器，路由器发现目标IP地址是<code class="highlighter-rouge">192.168.88.0/24</code>范围内的，重路由到HTPC上（<code class="highlighter-rouge">192.168.66.110</code>）。</p>

<p>修改公司所有机器上的<code class="highlighter-rouge">/etc/tinc/bignet/tinc-up</code>文件，增加一条静态路由：</p>

<pre class="highlight"><code><span class="nb">sudo </span>route add <span class="nt">-net</span> 192.168.66.0/24 192.168.88.3 255.255.255.0
</code></pre>

<p>即把<code class="highlighter-rouge">192.168.66.0/24</code>网段的流量路由到HTPC上。</p>

<p>因为我家里的路由器和HTPC使用的操作系统都是Linux，公司的电脑都是macOS系统，所以增加静态路由使用不同的命令。</p>

<p>至此，公司可以直接访问<code class="highlighter-rouge">192.168.66.0/24</code>网段内的所有机器。</p>



<p>tinc装在Windows上只需要装好tap-Windows驱动，设置好虚拟IP和子网掩码，就不需要手动设置路由，但在上面这种情况下，需要另外加一条静态路由，以管理员身份运行cmd.exe，输入命令：</p>

<pre class="highlight"><code>route add 192.168.66.0 mask 255.255.255.0 192.168.88.6 metric 3
</code></pre>

<p>命令中<code class="highlighter-rouge">192.168.88.6</code>是本机的tinc虚拟IP，我猜改成HTPC的IP应该也可以，没试过。</p>



<p>由于不能控制公司的路由器，所以不能给公司所有主机修改路由设置，如果要从家里访问公司里其他主机，比如访问公司内网的网站，我认为比较简单的方法是修改家中的路由器设置：</p>


  
    <p>开一个SSH隧道到公司任意一台装了tinc也装了OpenSSH server的机器：</p>

    <pre class="highlight"><code>ssh -D 8089 -f -C -q -N username@192.168.88.4
</code></pre>    

    <p>其中<code class="highlighter-rouge">192.168.88.4</code>就是公司某一台装了tinc也装了OpenSSH server的机器。</p>
  
  
    <p>装redsocks，并指向SSH隧道开的本地端口：</p>

    <pre class="highlight"><code>ip = 127.0.0.1;
port = 8089;
type = socks5;
</code></pre>    

    <p>假设redsocks监听在58096端口上。</p>
  
  
    <p>修改iptables防火墙设置：</p>

    <pre class="highlight"><code>-A SS -d 10.0.0.0/8 -p tcp -j REDIRECT --to-ports 58096
-A SS -d 173.36.0.0/14 -p tcp -j REDIRECT --to-ports 58096
-A SS -d 172.0.0.0/8 -p tcp -j REDIRECT --to-ports 58096
-A SS -d 171.68.0.0/14 -p tcp -j REDIRECT --to-ports 58096
-A SS -d 72.163.0.0/16 -p tcp -j REDIRECT --to-ports 58096
</code></pre>    

    <p>把所有公司内网用到的IP段流量都重定向到58096端口。</p>
  
  
    <p>在公司某一台装了tinc的机器上装一个DNS server，在家里把所有公司内网用到的域名都使用该DNS server进行解析，比如dnsmasq设置为：</p>

    <pre class="highlight"><code>server=/.cisco.com/192.168.88.4#35353
server=/.webex.com/192.168.88.4#35353
server=/.webexconnect.com/192.168.88.4#35353
server=/.wbx2.com/192.168.88.4#35353
</code></pre>    

    <p>其中<code class="highlighter-rouge">192.168.88.4</code>就是公司某一台装了DNS server的机器，监听在35353端口。</p>
  


<p>这时，家里所有机器应该都可以访问公司内网的网站，登录收发邮件等等。</p>

<p>我之前并没有使用SSH隧道，而是在公司机器上使用polipo提供http代理，发现它并不能正确代理非http端口的流量请求，而SSH隧道就没这个问题，不知是polipo的限制，还是因为SSH隧道使用socks5协议是会话层协议的缘故。</p>
</div>
                <div class="source">
                    <p>文章来源：</p>
                    <p>Author：类库大魔王/missdeer<br>link：https://blog.minidump.info/2018/07/tinc-follow-up/</p>
                </div>
            </article>
            <div class="more">
                                <div class="prev">上一篇：<a href="/article/4114">使用tinc构建虚拟专网</a></div>            </div>
        </div>
        <div class="side">
<!--    <div class="search c">-->
<!--        <h2>搜索</h2>-->
<!--        <form class="pure-form" action="--><!--">-->
<!--            <select class="pure-input-1-4">-->
<!--                <option>文章</option>-->
<!--                <option>作者</option>-->
<!--            </select><input class="pure-input-3-4" placeholder="请输入搜索内容" type="text" required>-->
<!--        </form>-->
<!--    </div>-->
        <div class="c">
        <h2>添加我喜欢的博客</h2>
        <form id="add_author" class="pure-form pure-form-stacked" action="javascript:void(0);">
            <input type="text" class="pure-input-1" placeholder="请填写博客RSS地址" required name="blog">
            <button type="submit" class="pure-button pure-button-primary pure-input-1-3 pure-o-1-3">提交</button>
        </form>
    </div>
    <div class="c">
        <h2><a class="c5" id="care_edit">编辑</a> 我的关注</h2>
        <div class="c1 c4">
                    </div>
    </div>
    <div class="c">
        <h2><a class="c5" href="/author">更多</a> 推荐博客</h2>
        <div class="c1 j1"><a author_id="1" href="/author/1">developerWorks中国</a><a author_id="2" href="/author/2">阮一峰</a><a author_id="3" href="/author/3">风雨后见彩虹</a><a author_id="4" href="/author/4">garfileo</a><a author_id="5" href="/author/5">大愚</a><a author_id="6" href="/author/6">naice</a><a author_id="7" href="/author/7">u3xyz</a><a author_id="8" href="/author/8">_Icarus</a><a author_id="9" href="/author/9">plokmju88</a><a author_id="10" href="/author/10">hvkcoder</a><a author_id="11" href="/author/11">九死蚕传人bo</a><a author_id="12" href="/author/12">猫耳</a><a author_id="13" href="/author/13">xixicat</a><a author_id="14" href="/author/14">Wall_Breaker</a><a author_id="15" href="/author/15">风清洋</a><a author_id="16" href="/author/16">香吉士</a><a author_id="17" href="/author/17">怀疑真爱的流浪者jason</a><a author_id="18" href="/author/18">洪旭</a><a author_id="19" href="/author/19">司徒正美</a><a author_id="20" href="/author/20">Holden</a>        </div>
    </div>

</div>
<script>
function arrayUnique(e){var t={},o=e.length,i=[];for(var r=0;r<o;r++){if(!t[e[r]]){t[e[r]]=true;i.push(e[r])}}return i}(function(){var e=arrayUnique($.cookie("care")?$.cookie("care").split(","):[]);var t=$("#add_author"),o="/author/add?_s_=360cc503be372a22713e0e80c6835225b395f6dc";t.submit(function(){$.post(o,"author="+t[0].blog.value,function(t){if(t.err){jer.error(t.msg)}else{var o=t.res.ids;for(var i=0;i<o.length;i++){e.push(o[i])}$.cookie("care",e.join(","),{expires:1360,path:"/"});jer.success(t.res.msg,function(){window.location.href="/care"})}},"json");t[0].reset()})})();(function(){var e=$("section .side .c4"),t=$("#care_edit"),o=null;var i=[];$("section .side .c4 a").each(function(){i.push($(this).attr("author_id"))});$.cookie("care",i.join(","),{expires:1360,path:"/"});$("section .side .j1 a,.author-list .a1 a").each(function(){$(this).click(r)});$(".content article .c3-3 a").click(function(){var e=$(".content article .author_name a")[0];r.call(e)});function r(){if(i.indexOf($(this).attr("author_id"))!==-1){jer.error("你已经关注了");return false}var t=this.cloneNode(true),r=this.cloneNode(true);var a=$('<i class="iconfont icon-error"></i>');a.click(function(e){n(this.parentNode);e.stopPropagation();return false});a.appendTo($(r));$(r).css({opacity:.01,transition:"none"}).appendTo(e);$(t).css({position:"absolute",zIndex:1,opacity:1,left:$(this).offset().left,top:$(this).offset().top,transition:"all ease-out 0.3s"}).appendTo($(this.parentNode));var c=$(this).parent().hasClass("j1");if(c){$(this).remove()}setTimeout(function(){$(t).css({opacity:1,left:$(r).offset().left-3,top:$(r).offset().top-3})},1);setTimeout(function(){$(r).css("opacity",1);$(t).remove();i.push($(r).attr("author_id"));$.cookie("care",i.join(","),{expires:1360,path:"/"})},300);if(c){clearTimeout(o);o=setTimeout(function(){if(i.length>0){window.location.href="/care"}},2e3)}return false}function n(e){var t=$(e).attr("author_id"),r=[];for(var n=0;n<i.length;n++){if(i[n]!=t){r.push(i[n])}}i=r;$.cookie("care",i.join(","),{expires:1360,path:"/"});$(e).remove();clearTimeout(o);o=setTimeout(function(){console.log(i.length);if(i.length==0){window.location.href="/"}else{window.location.href="/care"}},5e3)}t.click(function(){e.addClass("edit")});$(".content .c4 a i").click(function(e){n(this.parentNode);e.stopPropagation();return false})})();</script>
    </div>
</section>
<script>
    $('pre').each(function () {
        if(this.children.length == 0){
            var c = $(this).html();
            var css = $(this).attr('class');
            if(css && css.indexOf('brush:') != -1){
                var cr = css.split(';');
                var css = ' class="language-'+(cr[0].replace('brush:',''))+'"';
            }else{
                css = '';
            }
            $(this).html('<code'+css+'>'+c+'</code>');
        }
    });
    $('code.language-clike').removeClass('language-clike');
    $('blockquote').each(function () {
        if(this.children.length == 0){
            $(this).addClass('blockquote');
            $(this).html($.trim(this.innerHTML));
        }
    });
    $('.body img').attr('width','').attr('height','').bind('error',function () {
        $(this).remove();
    });
    $('.source').click(function () {
        window.location.href = 'https://blog.minidump.info/2018/07/tinc-follow-up/';
    });
    if(window.innerWidth > 700){
        $('.body pre,.content .detail .source,.blockquote').css({
            width: $('.wrap').width() - 360
        });
    }else{
        $('.body pre,.content .detail .source,.blockquote').css({
            width: window.innerWidth - 10
        });
    }
</script>
<footer>
    <p><a href="//blogs.vicsdf.com/">博客汇</a>是一个基于RSS标准的阅读工具，你可以在这里阅读你喜欢的博客文章. <a href="mailto:contus@qq.com">联系我们</a> <a href="https://s.vicsdf.com/">押韵搜索</a> <a href="https://www.vicsdf.com/">报告汇</a> </p>
    <p>Copyright ©2017 京ICP备12040723号 2.5ms</p>
</footer>
<script src="/js/jer.min.js"></script>
<script src="/js/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>
<link rel="stylesheet" href="//jzhitai.yxsss.com/css/jws.css">
<script src="//jzhitai.yxsss.com/js/jws.js"></script>
<script>
        JzhiTai({
        appId:"p6xi6zoxvvpeg2qgzbszykmtp",
        name:"游客96553b",
        avatar:"//jzhitai.yxsss.com/pic/663",
        groupId:"blogsarticle/4190",
        title:"tinc后续",
        sign:"12ea9ee8eccd5ef41bbe06280c523ae1407b0a80",
        time:1587054441    });

</script>
</body>
</html>