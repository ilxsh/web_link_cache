(function(i,t){if(typeof WebSocket=="undefined"){return false}function e(){var e={};function s(i,t,e){if(typeof t=="undefined"){return e.querySelector(i)}else{return e.querySelectorAll(i)}}e.$=function(i,e,a){return s(i,e,a||t)};e.on=function(i,t,e){if(!i)return;if(i.attachEvent){i.attachEvent("on"+t,function(){e.apply(i,arguments)})}else{i.addEventListener(t,e,false)}};e.$$=function(i,e){var a=t.createElement(e||"ul");a.innerHTML=i;return a.children[0]};e.trim=function(i){return i.replace(/(^\s+)|(\s+$)/g,"")};e.ichat=function(i,t,a,n,s){i=i.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");var r="";if(a){r="jzhitai-me"}if(n){r+=" jzhitai-privite "}var c="<li"+(r?' class="'+r+'"':"")+'><img class="jzhitai-avatar" src="'+t+'"><div><i></i><p>'+i+"</p></div></li>";var d=this.$$(c);g.appendChild(d);l();p.scrollTop=p.scrollHeight-p.offsetHeight;if(a==false){e.on(d.children[0],"click",function(){x(e.$("#"+s),s)})}};function l(){var i=200;if(g.children.length>i){for(var t=0;t<g.children.length-i;t++){g.removeChild(g.children[t])}}}e.schat=function(i){var t='<li  class="jzhitai-jzt"><div>'+i+"</div></li>";var e=this.$$(t);g.appendChild(e);l();p.scrollTop=p.scrollHeight-p.offsetHeight};e.addUser=function(i,t,e){var a='<li id="'+e+'" '+(e=="all_users"?'class="active"':"")+'><img class="jzhitai-avatar" src="'+t+'"><span>'+i+"</span></li>";var s=this.$$(a);w.appendChild(s);this.on(s,"click",function(){if(n.id!=e){x(this,e);if(d){S()}}})};e.delUser=function(i){var t=e.$("#"+i);t.parentNode.removeChild(t)};var r="//jzhitai.yxsss.com";var c="Powered by 聚知台";var d=false;var o="按 enter 发送";function h(){var i='<div class="jzhitai jzhitai-mobile"><div class="jzhitai-main jzhitai-mobile-chat"><div class="jzhitai-head"><a title="关闭" class="jzhitai-close jzhitai-rotate90">+</a><a class="jzhitai-list" href="#">成员列表</a><span>'+a+'</span></div><div class="jzhitai-chat"><ul></ul></div><div class="jzhitai-foot"><form action="javascript:void(0);"><div class="jzhitai-submit"><input type="submit" value="发送"></div><div class="jzhitai-text"><input type="hidden" name="sid"><input type="text" id="jzhitai_f_input" placeholder="'+o+'" name="msg"></div></form></div></div><div class="jzhitai-main jzhitai-user-list"><div class="jzhitai-head"><a title="关闭" class="jzhitai-close jzhitai-rotate90">+</a><a class="jzhitai-list jzhitai-list-back" href="#">返回</a></div><div class="jzhitai-user"><ul></ul></div><div class="power"><a href="'+r+'" target="_blank">Powered by 聚知台</a></div></div></div>';document.body.appendChild(e.$$(i,"div"))}function f(){var i='<div class="jzhitai jzhitai-web"><div class="jzhitai-left"><ul></ul><div class="power"><a href="'+r+'" target="_blank">'+c+'</a></div></div><div class="jzhitai-right"><div class="jzhitai-head"><a title="关闭" class="jzhitai-close jzhitai-rotate90">+</a><span>'+a+'</span></div><div class="jzhitai-chat"><ul></ul></div><div class="jzhitai-input"><form action="javascript:void(0);"><input type="hidden" name="sid"><textarea id="jzhitai_f_input" placeholder="'+o+'" name="msg"></textarea></form></div></div></div>';document.body.appendChild(e.$$(i,"div"))}function u(){var i='<div class="jzhitai-icon"><img src="'+r+'/img/eye.png"> <span>0</span><i></i></div>';document.body.appendChild(e.$$(i,"div"))}if(typeof document.ontouchstart=="undefined"&&window.innerWidth>500){f()}else{o="";h();d=true}u();var v=e.$(".jzhitai-input form"),p=e.$(".jzhitai-chat"),m=e.$(".jzhitai-foot form"),g=e.$(".jzhitai-chat ul"),j=e.$(".jzhitai-icon"),z=e.$(".jzhitai-close",true),y=e.$(".jzhitai-web"),$=e.$(".jzhitai-mobile"),b=e.$("#jzhitai_f_input"),k=e.$(".jzhitai-icon i"),w=e.$(".jzhitai-left ul")||e.$(".jzhitai-user ul");function T(i){var t=e.trim(i.msg.value);if(t){var a={msg:t,id:n.id,sid:e.ling.id,type:3};if(e.ling.id!="all_users"){a.type=4;var s="@"+e.$("#"+e.ling.id+" span").innerHTML;a.msg=s+" "+a.msg}q(a);i.msg.value=""}}e.on(j,"click",function(i){k.style.opacity=0;this.style.right="-"+this.offsetWidth+"px";if($){$.style.left=0}else{y.style.left="50%"}L=false;try{i.stopPropagation()}catch(i){}});function _(){L=true;j.style.right="0px";if($){$.style.left="100%"}else{y.style.left="150%"}}var H=$||y;e.on(window,"click",function(i){_()});e.on(H,"click",function(i){try{i.stopPropagation()}catch(i){}});for(var C=0;C<z.length;C++){e.on(z[C],"click",function(){_()})}e.ling={dom:null,id:"all_users"};var L=true;function x(i,t){if(!e.ling.dom){e.ling.dom=e.$("#all_users")}e.ling.dom.className="";i.className="active";e.ling.dom=i;e.ling.id=t;if(t!="all_users"){b.placeholder="@"+i.children[1].innerHTML+" "+o}else{b.placeholder=o}}if(v){e.on(v.msg,"keyup",function(t){var e=i.event?t.keyCode:t.which;if(e==13){T(v)}})}if(m){m.onsubmit=function(){T(this)}}function M(){var i=e.$(".jzhitai-user-list");i.style.left=0;i.style.opacity=1}function S(){var i=e.$(".jzhitai-user-list");i.style.left="100%";i.style.opacity=0}var I=e.$(".jzhitai-list");if(I){e.on(I,"click",M);e.on(e.$(".jzhitai-list-back"),"click",S)}if(document.location.protocol=="https:"){var N="wss://jzhitai.yxsss.com:8080";var U=true;var E=5e4}else{var N="ws://jzhitai.yxsss.com:8081";var U=false}var J,P={},W=0;function q(i){var t=(new Date).getTime();if(t-W<100){if(P.msg){P.msg+=" "+i.msg}else{P=i}return}if(P.msg){P.msg+=" "+i.msg}else{P=i}W=t;J.send(JSON.stringify(P));P={}}function O(){J=new WebSocket(N);function i(){J.send("ping");setTimeout(function(){i()},E)}J.onopen=function(){if(J.readyState==1){n.type=1;J.send(JSON.stringify(n));if(U){setTimeout(function(){i()},E)}}};J.onclose=function(){J=null;e.schat("退出聊天室");setTimeout(function(){O()},1e4)};J.onmessage=function(i){if(i.data=="ping"){return}var t=JSON.parse(i.data);if(L==true){k.style.opacity=1}switch(t.type){case 0:e.schat(t.msg);break;case 1:if(t.id!=n.id){e.addUser(t.n,t.p,t.id);j.children[1].innerHTML=parseInt(j.children[1].innerHTML)+1}else{e.$("#"+n.id).style.backgroundColor="transparent";e.$("#"+n.id).style.color="#333"}break;case 2:if(t.id==e.ling.id){x(e.$("#all_users"),"all_users")}e.delUser(t.id);j.children[1].innerHTML=parseInt(j.children[1].innerHTML)-1;break;case 3:e.ichat(t.msg,t.p,t.id==n.id,false,t.id);break;case 4:e.ichat(t.msg,t.p,t.id==n.id,true,t.id);break;case 5:n.id=t.id;w.innerHTML="";e.addUser("所有人",r+"/img/group.png","all_users");j.children[1].innerHTML=t.list.length;var a=t.list;for(var s=0;s<a.length;s++){var l=a[s];e.addUser(l.n,l.p,l.id)}break;default:break}}}O()}var a="";var n={};function s(i){if(i.appId&&i.name&&i.avatar&&i.groupId&&i.sign&&i.time){n={a:i.appId,n:i.name,p:i.avatar,g:i.groupId,s:i.sign,t:i.title,e:i.time};if(i.title){a=i.title}e()}else{console.warn("信息格式不正确")}}i.JzhiTai=s})(window,document);